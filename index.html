<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Maifer's Factory: Refined Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&display=swap');
        body { margin: 0; background: #000; color: #fff; font-family: 'Special Elite', cursive; overflow: hidden; user-select: none; }
        
        /* --- MENÚ --- */
        #menu { position: fixed; inset: 0; z-index: 1000; background: radial-gradient(circle, #1a0000, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 5px solid #300; }
        .menu-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { background: #111; border: 1px solid #600; color: #aaa; padding: 12px 25px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn:hover { background: #600; color: #fff; box-shadow: 0 0 15px #f00; }
        .btn-play { grid-column: span 2; font-size: 2.2rem; color: #f00; border: 2px solid #f00; }

        /* --- OFICINA --- */
        #game { display: none; position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        #office { position: absolute; width: 160vw; height: 100%; left: -30vw; background: #0d0d0d; transition: transform 0.1s ease-out; }
        
        /* LUZ Y LINTERNA */
        #ambient { position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 5; pointer-events: none; transition: background 0.3s; }
        .bulb-on { background: rgba(0,0,0,0.25) !important; }
        #flashlight { 
            position: absolute; inset: 0; z-index: 6; pointer-events: none;
            background: radial-gradient(circle at 50% 40%, rgba(255,255,200,0.4) 0%, transparent 35%);
            display: none; 
        }

        /* PASILLO Y VENTANA */
        #hallway { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 320px; height: 460px; background: #000; border: 12px solid #1a1a1a; box-shadow: 0 0 50px #000; }
        #window-frame { position: absolute; top: 22%; right: 10%; width: 220px; height: 260px; background: #000; border: 6px solid #222; overflow: hidden; }
        #glass { width: 100%; height: 100%; background: linear-gradient(to bottom, #1a2a3a, #000); transform: translateY(0); transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }

        /* MESA Y MONITOR */
        #desk { position: absolute; bottom: 0; width: 100%; height: 35%; background: #26140a; border-top: 15px solid #3a1f11; z-index: 20; display: flex; justify-content: center; }
        #monitor { 
            width: 320px; height: 200px; background: #050505; border: 8px solid #444; 
            margin-top: -140px; position: relative; overflow: hidden; cursor: pointer;
            box-shadow: 0 0 20px #000; transition: 0.5s transform;
        }
        .monitor-zoom { transform: scale(4.2) translateY(-60px); z-index: 1000; }

        /* ENEMIGOS */
        .enemy { position: absolute; display: none; z-index: 15; border-radius: 5px; }
        #jomar { bottom: 0; left: 50%; transform: translateX(-50%); width: 200px; height: 380px; background: #ffd700; filter: brightness(0.4); box-shadow: 0 0 20px rgba(255,215,0,0.2); }
        #isaac { left: 10%; bottom: 30%; width: 170px; height: 330px; background: #0044ff; box-shadow: 0 0 40px #0044ff; }
        #maifer { right: 10%; bottom: 30%; width: 190px; height: 360px; background: #ff0000; box-shadow: 0 0 40px #ff0000; }

        /* --- CÁMARAS --- */
        #cam-system { position: absolute; inset: 0; background: #000; display: none; z-index: 900; border: 10px solid #222; }
        #cam-display { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #map-area { position: absolute; bottom: 20px; right: 20px; width: 240px; height: 200px; background: rgba(0,0,0,0.9); border: 2px solid #555; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; }
        .cam-btn { background: #222; color: #fff; border: 1px solid #444; cursor: pointer; font-family: inherit; }
        .cam-btn.active { background: #900; border-color: #f00; }

        /* HUD */
        #clock { position: fixed; top: 20px; right: 40px; font-size: 3.5rem; z-index: 1100; color: #fff; text-shadow: 0 0 10px #f00; }
        #mask-overlay { position: fixed; inset: 0; background: radial-gradient(circle, transparent 25%, black 85%); border: 180px solid black; display: none; z-index: 800; pointer-events: none; }
        #hiding-screen { position: fixed; inset: 0; background: #000; display: none; z-index: 850; align-items: center; justify-content: center; font-size: 2rem; color: #1a1a1a; }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="font-size: 4rem; color: #f00; text-shadow: 0 0 20px #600; margin: 0;">MAIFER'S FACTORY</h1>
        <h2 id="night-info">NOCHE 1</h2>
        <button class="btn btn-play" onclick="initGame()">VIGILAR FÁBRICA</button>
        <div class="menu-btns">
            <button class="btn" onclick="alert('Configuración: Dificultad Equilibrada.')">AJUSTES</button>
            <button class="btn" onclick="alert('Idioma: Español.')">TRADUCIR</button>
            <button class="btn" onclick="alert('M: Máscara | S: Mesa | R: Luz | L: Linterna | ESPACIO: Cámaras')">CONTROLES</button>
            <button class="btn" onclick="alert('El turno termina a las 8 AM. No dejes que entren.')">DATOS</button>
        </div>
    </div>

    <div id="game">
        <div id="clock">12:00 AM</div>
        
        <div id="office">
            <div id="ambient"></div>
            <div id="flashlight"></div>
            
            <div id="hallway"><div id="jomar" class="enemy"></div></div>
            <div id="window-frame"><div id="glass" onclick="resetWindow()"></div></div>
            
            <div id="isaac" class="enemy"></div>
            <div id="maifer" class="enemy"></div>

            <div id="desk">
                <div id="monitor" onclick="toggleCams()">
                    <div id="cam-system">
                        <div id="cam-display">
                            <h2 id="cam-label" style="position:absolute; top:10px; left:20px; color:#fff;">CAM 1</h2>
                            <div id="static-img" style="position:absolute; inset:0; background:url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif'); opacity:0.1;"></div>
                            <div id="enemy-dot" style="width:60px; height:120px; display:none; border: 2px solid #fff;"></div>
                        </div>
                        <div id="map-area">
                            <button class="cam-btn active" onclick="changeCam(1)">C1</button>
                            <button class="cam-btn" onclick="changeCam(2)">C2</button>
                            <button class="cam-btn" onclick="changeCam(3)">C3</button>
                            <button class="cam-btn" onclick="changeCam(4)">C4</button>
                            <button class="cam-btn" onclick="changeCam(5)">C5</button>
                            <button class="cam-btn" onclick="changeCam(6)">C6</button>
                        </div>
                    </div>
                    <p style="text-align:center; color:#0f0; margin-top:80px; font-size:0.8rem;">[ VIDEO FEED ]</p>
                </div>
            </div>
        </div>

        <div id="mask-overlay"></div>
        <div id="hiding-screen">ESTÁS DEBAJO DE LA MESA</div>
    </div>

    <script>
        /* --- NUEVOS AUDIOS DE MAIFER --- */
        const sndMaiferAparece = new Audio('maifer_aparece.mp3'); 
        const sndMaiferMata = new Audio('maifer_mata.mp3');

        const audioCtx = new AudioContext();
        function playBeep(freq, dur) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq; gain.gain.value = 0.05;
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        let state = {
            active: false, h: 0, night: 1, cam: false, bulb: false, mask: false, hide: false, light: false,
            winOpen: 0, curCam: 1,
            isaac: { pos: 1, state: 'roaming', timer: 0 },
            maifer: { pos: 2, state: 'roaming', timer: 0 },
            jomar: { state: 'hidden', timer: 0 }
        };

        function initGame() {
            state.active = true; state.h = 0; state.winOpen = 0;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            gameLoop();
        }

        function gameLoop() {
            if(!state.active) return;

            // Avance de hora (cada 20 segundos)
            setTimeout(() => {
                if(!state.active) return;
                state.h++;
                document.getElementById('clock').innerText = (state.h === 0 ? 12 : state.h) + ":00 AM";
                if(state.h >= 8) victory(); else gameLoop();
            }, 20000);

            // Inteligencia Artificial (cada 1.2 segundos para que no sea tan rápido)
            const aiTick = setInterval(() => {
                if(!state.active) { clearInterval(aiTick); return; }

                // RICHARD (La Ventana)
                if(Math.random() > 0.92 && !state.bulb) {
                    state.winOpen += 8;
                    document.getElementById('glass').style.transform = `translateY(-${state.winOpen}%)`;
                    if(state.winOpen >= 100) gameOver("RICHARD");
                }

                // JOMAR (Pasillo)
                if(state.jomar.state === 'hidden' && Math.random() > 0.96) {
                    state.jomar.state = 'hall';
                    document.getElementById('jomar').style.display = 'block';
                }
                if(state.jomar.state === 'hall') {
                    if(state.light) { 
                        state.jomar.state = 'hidden'; state.jomar.timer = 0;
                        document.getElementById('jomar').style.display = 'none';
                    } else {
                        state.jomar.timer++; if(state.jomar.timer > 12) gameOver("JOMAR");
                    }
                }

                // ISAAC (Máscara)
                if(state.isaac.state === 'roaming' && Math.random() > 0.97) {
                    state.isaac.state = 'office';
                    document.getElementById('isaac').style.display = 'block';
                }
                if(state.isaac.state === 'office') {
                    if(state.mask) {
                        state.isaac.timer++;
                        if(state.isaac.timer > 4) {
                            state.isaac.state = 'roaming'; state.isaac.timer = 0;
                            document.getElementById('isaac').style.display = 'none';
                            playBeep(220, 0.3); // Pitido grave Isaac
                        }
                    } else {
                        state.isaac.timer++; if(state.isaac.timer > 8) gameOver("ISAAC");
                    }
                }

                // MAIFER (Mesa)
                if(state.maifer.state === 'roaming' && Math.random() > 0.98) {
                    state.maifer.state = 'office';
                    document.getElementById('maifer').style.display = 'block';
                    sndMaiferAparece.play(); // <--- SONIDO AL APARECER
                }
                if(state.maifer.state === 'office') {
                    if(state.hide) {
                        state.maifer.timer++;
                        if(state.maifer.timer > 4) {
                            state.maifer.state = 'roaming'; state.maifer.timer = 0;
                            document.getElementById('maifer').style.display = 'none';
                            playBeep(880, 0.2); // Pitido agudo Maifer
                        }
                    } else {
                        state.maifer.timer++; 
                        if(state.maifer.timer > 8) {
                            sndMaiferMata.play(); // <--- SONIDO AL MATAR
                            gameOver("MAIFER");
                        }
                    }
                }
                renderCams();
            }, 1200);
        }

        // --- ENTRADAS ---
        document.addEventListener('keydown', (e) => {
            if(!state.active) return;
            const k = e.key.toUpperCase();
            if(k === 'R') { state.bulb = !state.bulb; document.getElementById('ambient').classList.toggle('bulb-on'); }
            if(k === 'L') { state.light = true; document.getElementById('flashlight').style.display = 'block'; }
            if(k === 'M' && !state.cam) { state.mask = !state.mask; document.getElementById('mask-overlay').style.display = state.mask ? 'block' : 'none'; }
            if(k === 'S' && !state.cam) { state.hide = !state.hide; document.getElementById('hiding-screen').style.display = state.hide ? 'flex' : 'none'; }
            if(e.code === 'Space') toggleCams();
        });

        document.addEventListener('keyup', (e) => {
            if(e.key.toUpperCase() === 'L') { state.light = false; document.getElementById('flashlight').style.display = 'none'; }
        });

        function toggleCams() {
            if(state.mask || state.hide) return;
            state.cam = !state.cam;
            document.getElementById('monitor').classList.toggle('monitor-zoom');
            document.getElementById('cam-system').style.display = state.cam ? 'block' : 'none';
        }

        function changeCam(n) {
            state.curCam = n;
            document.getElementById('cam-label').innerText = "CAM " + n;
            document.querySelectorAll('.cam-btn').forEach((b, i) => b.classList.toggle('active', (i+1) === n));
            renderCams();
        }

        function renderCams() {
            const dot = document.getElementById('enemy-dot'); dot.style.display = 'none';
            if(state.isaac.pos === state.curCam && state.isaac.state === 'roaming') {
                dot.style.display = 'block'; dot.style.background = 'rgba(0,0,255,0.3)'; dot.style.borderColor = 'blue';
            }
            if(state.maifer.pos === state.curCam && state.maifer.state === 'roaming') {
                dot.style.display = 'block'; dot.style.background = 'rgba(255,0,0,0.3)'; dot.style.borderColor = 'red';
            }
        }

        function resetWindow() { state.winOpen = 0; document.getElementById('glass').style.transform = 'translateY(0)'; }

        function gameOver(name) { state.active = false; alert("HAS MUERTO: " + name); location.reload(); }
        
        function victory() { state.active = false; state.night++; alert("¡SOBREVIVISTE A LA NOCHE!"); location.reload(); }

        document.addEventListener('mousemove', (e) => {
            if(!state.active || state.cam) return;
            let p = (e.clientX / window.innerWidth) - 0.5;
            document.getElementById('office').style.transform = `translateX(${p * -40}vw)`;
        });
    </script>
</body>
</html>