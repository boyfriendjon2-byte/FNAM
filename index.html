<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maifer's Factory: Ultimate v47.0 (Creator Mode & DB Fix)</title>
    
    <!-- LIBRER√çAS DE FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* ==========================================================================
           1. ESTILOS VISUALES (ROBUSTOS)
           ========================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nosifer&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root { 
            --primary-color: #ff0000; 
            --secondary-color: #00ff00;
            --background-dark: #000000; 
            --hud-background: rgba(0, 10, 0, 0.85);
            --hud-border-color: #446644;
            --text-color: #cccccc;
        }

        * { box-sizing: border-box; user-select: none; touch-action: none; cursor: crosshair; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--background-dark); color: var(--text-color); font-family: 'Share Tech Mono', monospace; overflow: hidden; }

        /* MODO M√ìVIL */
        body.mode-mobile .hud-container { transform: scale(0.7); transform-origin: top left; }
        body.mode-mobile .menu-container { display: flex; flex-direction: column; align-items: center; overflow-y: auto; max-height: 60vh; width: 100%; padding-bottom: 50px; }
        body.mode-mobile .menu-btn { padding: 15px; font-size: 1.5rem; width: 80%; margin: 10px 0; flex-shrink: 0; }
        body.mode-mobile .title-text { font-size: 3rem; }
        body.mode-mobile #mobile-controls { height: 15vh; display: flex; }
        body.mode-mobile .mob-btn { font-size: 1rem; }
        body.mode-mobile #star-row { transform: scale(0.8); }
        body.mode-mobile .cam-btn { width: 15%; height: 12%; font-size: 1rem; pointer-events: auto; }

        /* MODO PC */
        body:not(.mode-mobile) .menu-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; justify-items: center; align-content: center; width: 80%; max-width: 900px; height: auto; max-height: 60vh; overflow: hidden; margin: 0 auto; padding-bottom: 0; }
        body:not(.mode-mobile) .menu-btn { width: 100%; font-size: 1.8rem; padding: 10px; margin: 0; }
        body:not(.mode-mobile) #mobile-controls { display: none !important; }

        /* PANTALLAS */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background-color: #000; z-index: 10; }
        .screen.active { display: flex; }

        /* DEVICE SELECTION */
        #screen-device { z-index: 9999; background: #050505; }
        #loading-bar-container { width: 80%; height: 20px; border: 2px solid #333; margin-top: 20px; display: none; }
        #loading-bar { width: 0%; height: 100%; background: #0f0; transition: width 0.2s; }

        /* INTRO */
        #screen-intro { z-index: 5000; background: #000; color: #fff; font-family: 'VT323'; text-align: center; }
        .intro-text { font-size: 4rem; opacity: 0; animation: fadeInOut 4s forwards; }
        @keyframes fadeInOut { 0% { opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }

        /* MENU */
        #screen-menu { background: url('start_screen.png') no-repeat center center fixed; background-size: cover; position: relative; overflow: hidden; }
        #screen-menu::before { content: " "; display: block; position: absolute; inset: 0; pointer-events: none; z-index: 2; background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.8) 80%, rgba(0,0,0,1) 100%); background-size: 100% 100%; }
        #screen-menu::after { content: " "; display: block; position: absolute; inset: 0; pointer-events: none; z-index: 3; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px; }

        .title-text { font-family: 'Nosifer'; font-size: clamp(3.5rem, 12vw, 7rem); color: var(--primary-color); text-shadow: 0 0 10px #500, 0 0 20px #f00; text-align: center; animation: glitch 4s infinite, pulseTitle 3s infinite alternate; margin-bottom: 30px; z-index: 5; width: 90%; }
        @keyframes pulseTitle { from { text-shadow: 0 0 10px #500, 0 0 20px #f00; transform: scale(1); } to { text-shadow: 0 0 20px #800, 0 0 40px #f00; transform: scale(1.02); } }

        .menu-btn { background-color: rgba(0, 0, 0, 0.7); border: 2px solid #440000; color: #cccccc; margin: 8px; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; position: relative; z-index: 10; box-shadow: 0 0 5px rgba(0,0,0,0.8); backdrop-filter: blur(2px); font-family: 'Share Tech Mono'; }
        .menu-btn:hover:not(.locked) { border-color: #ff0000; color: #ffffff; background-color: rgba(50, 0, 0, 0.9); transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 0, 0, 0.4); text-shadow: 0 0 5px #fff; }
        .menu-btn.locked { opacity: 0.5; cursor: not-allowed; border-color: #333333; filter: grayscale(100%); }
        .icon-lock { position: absolute; right: 15px; }

        /* USER UI */
        #user-panel { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 25; display: flex; gap: 10px; }
        .user-btn { background: #001100; border: 1px solid #00ff00; color: #00ff00; font-family: 'Share Tech Mono'; cursor: pointer; padding: 5px 10px; }
        #lang-btn { position: absolute; top: 20px; left: 20px; width: auto; font-family: 'VT323'; font-size: 1.5rem; z-index: 20; border: 1px solid #444; background: rgba(0,0,0,0.8); color: #fff; padding: 5px 10px; cursor: pointer; }
        #btn-leaderboard { position: absolute; top: 20px; right: 20px; width: auto; font-family: 'VT323'; font-size: 1.5rem; z-index: 20; background-color: rgba(0, 34, 68, 0.8); border: 1px solid #0088ff; color: #0088ff; padding: 5px 10px; cursor: pointer; }
        #credits-text { position: absolute; bottom: 5px; right: 10px; z-index: 20; font-family: 'Share Tech Mono'; font-size: 0.9rem; color: #00aaff; text-shadow: 0 0 5px #00aaff; }

        /* STARS */
        #star-row { display: flex; gap: 15px; margin-bottom: 30px; height: 50px; z-index: 5; }
        .star { font-size: 3rem; color: #222222; transition: transform 0.3s; }
        .star.earned { color: gold; text-shadow: 0 0 15px gold; }
        .star.blue { color: #0088ff; text-shadow: 0 0 20px #0088ff; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.98); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .modal-box { background-color: #0b0b0b; border: 2px solid var(--primary-color); width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto; padding: 30px; color: #ffffff; box-shadow: 0 0 50px rgba(255,0,0,0.2); border-radius: 8px; }
        .lore-text { font-family: 'Share Tech Mono'; white-space: pre-wrap; text-align: left; line-height: 1.6; color: #00ff00; font-size: 1rem; }
        .lore-header { color: var(--primary-color); font-family: 'Nosifer'; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 25px; text-align: center; font-size: 1.8rem; }
        .update-list { text-align: left; font-family: 'VT323'; color: #cccccc; padding-left: 20px; }
        .update-list li { margin-bottom: 8px; font-size: 1.2rem; list-style-type: square; }
        .teaser-text { color: red; font-family: 'Nosifer'; text-align: center; margin-top: 30px; animation: glitch 2s infinite; font-size: 1.2rem; }

        /* SETTINGS UI */
        .setting-section { border: 1px solid #333; background-color: rgba(255,255,255,0.02); padding: 15px; margin-bottom: 15px; }
        .setting-header { color: #aaaaaa; font-family: 'Nosifer'; font-size: 1.2rem; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .setting-row { margin: 15px 0; display: flex; align-items: center; justify-content: space-between; width: 100%; font-family: 'VT323'; font-size: 1.4rem; }
        input[type=range] { width: 50%; cursor: pointer; accent-color: var(--primary-color); }
        input[type=checkbox] { transform: scale(1.5); cursor: pointer; accent-color: var(--primary-color); }

        /* COMMUNITY */
        .comment-box { border-bottom: 1px solid #333; padding: 10px; font-family: 'Share Tech Mono'; background-color: #080808; margin-bottom: 5px; font-size: 1rem; }
        .comment-user { color: #0088ff; font-weight: bold; }
        .comment-msg { display: block; margin-top: 5px; color: #cccccc; }

        /* CUSTOM NIGHT UI */
        #screen-custom { background-color: #111; overflow-y: auto; padding: 20px; padding-top: 50px; }
        .cn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 900px; justify-items: center; }
        .cn-char { background-color: #000; border: 2px solid #444; padding: 10px; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 250px; }
        .cn-img { width: 70px; height: 70px; object-fit: contain; margin-bottom: 10px; border: 1px solid #333; }
        .cn-controls { display: flex; align-items: center; gap: 10px; }
        .cn-btn { width: 35px; height: 35px; background-color: #333; color: #fff; border: 1px solid #666; cursor: pointer; font-size: 1.2rem; }
        .cn-val { font-family: 'VT323'; font-size: 2rem; color: #fff; width: 40px; text-align: center; }

        /* GAME ENVIRONMENT */
        #view-office { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #111; background-image: radial-gradient(circle at center, transparent 30%, #000 130%), url('https://www.transparenttextures.com/patterns/dark-concrete.png'); background-size: cover; background-position: center; overflow: hidden; }
        #layer-flicker { position: fixed; inset: 0; background-color: #000; opacity: 0; pointer-events: none; z-index: 80; }
        
        #hallway { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 45vw; max-width: 400px; height: 70vh; background-color: #000; border: 20px solid #1a1a1a; border-image: linear-gradient(to right, #111, #333, #555, #222) 1; box-shadow: inset 0 0 50px #000; overflow: hidden; }

        /* CURTAIN */
        #curtain-window { position: absolute; top: 15%; right: 5%; width: 18vw; max-width: 150px; height: 30vh; background-color: #050505; border: 5px solid #222; box-shadow: inset 0 0 20px #000; z-index: 25; overflow: hidden; }
        #curtain-fabric { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(90deg, #500, #400 10px, #300 10px, #300 20px); transform: translateY(-100%); transition: transform 0.3s ease-out; z-index: 5; }
        #curtain-fabric.closed { transform: translateY(0); }
        #vis-richard-win { position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; object-fit: contain; display: none; z-index: 2; filter: brightness(0.7); }
        #curtain-btn { position: absolute; bottom: 0; width: 100%; height: 20%; background: #800; color: #fff; border: none; border-top: 3px solid #a00; cursor: pointer; font-family: 'VT323'; z-index: 6; }

        /* ANIMATRONICS */
        .anim-img { position: absolute; pointer-events: none; display: none; z-index: 20; filter: brightness(0.6); }
        #vis-maifer { right: 0; bottom: 0; height: 90%; max-height: 100vh; }
        #vis-isaac { left: 0; bottom: 0; height: 95%; max-height: 100vh; }
        #vis-jomar { left: 50%; bottom: 0; transform: translateX(-50%); height: 80%; z-index: 4; }

        /* VENT */
        #vent-system { position: absolute; top: 25%; left: 0; width: 25vw; max-width: 200px; height: 30vh; background-color: #0a0a0a; border: 5px solid #222; border-left: none; box-shadow: 5px 5px 15px #000; z-index: 35; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        #vent-grill { width: 100%; height: 100%; background: repeating-linear-gradient(45deg, rgba(20,20,20,0.9) 10px, transparent 10px, transparent 18px); position: relative; z-index: 4; pointer-events: none; border: 2px solid #111; }
        #vent-door { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #2a2a2a; transform: translateY(-100%); transition: transform 0.2s; border-bottom: 5px solid #444; z-index: 5; background-image: repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.2) 20px); }
        #vent-door.closed { transform: translateY(0); }
        #vent-img { position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; z-index: 1; display: none; filter: brightness(0.5); object-fit: contain; }
        #vent-btn { width: 100%; height: 25%; background-color: #600; color: #fff; border: none; font-family: 'VT323'; cursor: pointer; z-index: 6; border-top: 4px solid #800; font-size: 1.2rem; }
        #vent-btn.active { background-color: #006600; border-top: 4px solid #008800; }

        /* GENERATOR */
        #gen-panel { position: absolute; bottom: 20%; left: 20%; width: 15vh; height: 20vh; background-color: #1a1a1a; border: 4px solid #333; z-index: 40; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #gen-fan { width: 70%; height: auto; aspect-ratio: 1/1; border-radius: 50%; border: 4px dashed #555; animation: spin 4s linear infinite; margin-bottom: 10px; background-color: #000; }
        #gen-btn { width: 40%; aspect-ratio: 1/1; background: radial-gradient(circle, #ff5555, #990000); border: 2px solid #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px red; }

        /* DESK */
        #desk { position: absolute; bottom: 0; width: 100%; height: 15vh; background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.9)), url('https://www.transparenttextures.com/patterns/wood-pattern.png'), #2d2d2d; z-index: 30; display: flex; justify-content: center; align-items: flex-end; border-top: 5px solid #333; box-shadow: inset 0 20px 30px rgba(0,0,0,0.8); }
        .monitor-btn { width: 80%; max-width: 600px; height: 100%; background-color: #111; color: #0f0; border: 2px solid #0f0; border-bottom: 0; font-family: 'VT323'; font-size: clamp(1.5rem, 5vw, 3rem); cursor: pointer; }
        .monitor-btn:hover { background-color: #002200; }

        /* HUD */
        .hud-container { position: absolute; background-color: var(--hud-bg); border: 2px solid var(--hud-border); padding: 5px 15px; color: #fff; font-family: 'VT323'; z-index: 900; border-radius: 4px; backdrop-filter: blur(2px); pointer-events: none; }
        #hud-time-box { top: 20px; right: 20px; text-align: right; }
        #hud-time { font-size: clamp(2rem, 8vw, 4rem); line-height: 0.9; color: #eeffee; text-shadow: 0 0 10px #0f0; }
        #hud-night { font-size: clamp(1rem, 4vw, 2rem); color: #aaccaa; }
        #hud-power-box { bottom: 140px; left: 20px; width: auto; }
        #hud-power-text { font-size: clamp(1.5rem, 5vw, 2.5rem); margin-bottom: 5px; color: #eeffee; }
        #hud-usage { display: flex; gap: 5px; align-items: center; font-size: 1.2rem; color: #aaccaa; }
        .usage-block { width: 20px; height: 10px; background-color: #222; border: 1px solid #444; }
        .usage-block.active { background-color: #0f0; box-shadow: 0 0 5px #0f0; }
        .usage-block.high { background-color: #ff0000; box-shadow: 0 0 5px #ff0000; }
        #hud-toxic { position: absolute; top: 20px; left: 20px; width: 30%; height: 20px; border: 2px solid #004400; background-color: #001100; z-index: 900; display: none; }
        #toxic-bar { height: 100%; background-color: #0f0; width: 0%; box-shadow: 0 0 10px #0f0; }
        #btn-mute { position: absolute; top: 80px; left: 20px; background-color: #222; color: #fff; border: 1px solid #555; font-family: 'VT323'; cursor: pointer; z-index: 950; padding: 5px; pointer-events: auto; }

        /* CONTROLES M√ìVILES */
        #mobile-controls { position: fixed; bottom: 0; left: 0; width: 100%; height: 12vh; background-color: rgba(0,0,0,0.95); z-index: 1000; display: none; justify-content: space-around; align-items: center; border-top: 2px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .mob-btn { width: 18%; height: 80%; background-color: #222; border: 2px solid #555; color: #fff; font-family: 'VT323'; font-size: clamp(1rem, 4vw, 1.5rem); border-radius: 8px; touch-action: manipulation; }
        .mob-btn:active, .mob-btn.active { background-color: #555; border-color: var(--primary-color); }

        /* FX LAYERS */
        #layer-mask { position: absolute; inset: 0; z-index: 100; display: none; pointer-events: none; background: radial-gradient(circle at center, transparent 30%, rgba(0,20,0,0.8) 60%, #000 95%); }
        #layer-flashlight { position: absolute; inset: 0; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.7) 0%, transparent 60%); z-index: 50; display: none; mix-blend-mode: overlay; pointer-events: none; opacity: 0.85 !important; }
        #layer-under-desk { position: absolute; inset: 0; z-index: 90; display: none; align-items: center; justify-content: center; background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.9) 60%, #000 95%); }
        #layer-under-desk h2 { font-family: 'Share Tech Mono'; color: #444; background: #000; padding: 10px; border: 1px solid #333; margin-top: 40%; }

        /* MONITOR */
        #screen-monitor { position: absolute; inset: 0; background-color: #111; z-index: 200; display: none; flex-direction: column; padding: 2vh; }
        #cam-view { flex: 2; background-color: #000; border: 4px solid #333; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 10px; }
        #cam-static { position: absolute; inset: 0; opacity: 0.15; background: url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif'); pointer-events: none; z-index: 5; }
        #cam-content { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2; flex-direction: column; }
        .cam-spot { font-family: 'Share Tech Mono'; color: #fff; font-size: 1.5rem; border: 2px solid #fff; background: rgba(0,0,0,0.5); padding: 10px; text-align: center; }
        .cam-spot.active-anim { color: #f00; border-color: #f00; background: rgba(50,0,0,0.5); animation: glitch 1s infinite; }
        
        #map-layout { height: 35vh; background: #051505; border: 2px solid #0f0; position: relative; flex-shrink: 0; box-shadow: inset 0 0 30px #020; }
        .map-room { position: absolute; border: 2px solid #004400; background: rgba(0, 50, 0, 0.3); }
        .cam-btn { position: absolute; width: 12%; height: 15%; background-color: #002200; border: 1px solid #0f0; color: #0f0; font-family: 'VT323'; font-size: clamp(0.8rem, 3vw, 1.2rem); cursor: pointer; z-index: 10; display: flex; justify-content: center; align-items: center; }
        .cam-btn:hover { background-color: #004400; }
        .cam-btn.active { background-color: #0f0; color: #000; animation: blink 1s infinite; }
        
        #room-06 { top: 5%; left: 35%; width: 30%; height: 20%; }
        #room-04 { top: 30%; left: 10%; width: 35%; height: 25%; }
        #room-05 { top: 30%; right: 10%; width: 35%; height: 25%; }
        #room-02 { top: 60%; left: 20%; width: 25%; height: 20%; }
        #room-03 { top: 60%; right: 20%; width: 25%; height: 20%; }
        #room-you { bottom: 0; left: 45%; width: 10%; height: 5%; background: #200; }
        
        #btn-c6 { top: 8%; left: 44%; }
        #btn-c4 { top: 35%; left: 20%; }
        #btn-c5 { top: 35%; right: 20%; }
        #btn-c2 { top: 65%; left: 26%; }
        #btn-c3 { top: 65%; right: 26%; }
        #btn-c1 { bottom: 5%; left: 44%; }
        
        #btn-close-mon { position: absolute; bottom: 5px; right: 5px; background-color: #f00; color: #fff; border: 2px solid #fff; padding: 5px 15px; font-family: 'VT323'; cursor: pointer; font-size: 1.2rem; }

        /* EXTRAS */
        #screen-win { background-color: #000; text-align: center; }
        #win-msg { color: #00aaff; font-family: 'Share Tech Mono'; font-size: 1.5rem; max-width: 80%; margin: 20px; line-height: 1.5; }
        
        #screen-gameover { z-index: 9500; background: #050000; flex-direction: row; gap: 30px; flex-wrap: wrap; background-image: url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif'); background-blend-mode: overlay; background-size: cover; }
        #death-card { width: 90%; max-width: 500px; border: 4px solid #500; background: #100; padding: 20px; text-align: center; transform: rotate(-2deg); }
        #death-card h1 { font-size: 3rem; margin: 0 0 20px 0; text-shadow: 2px 2px #000; animation: glitch 1s infinite; }
        #death-img { border: 2px solid #300; filter: contrast(1.2) sepia(0.5); width: 100%; }
        
        #screen-jumpscare { z-index: 9600; background-color: #000; display: none; align-items: center; justify-content: center; }
        #jump-img { width: 100%; height: 100%; object-fit: cover; animation: shake 0.2s infinite; }

        #screen-minigame { background-color: #000; }
        #mg-canvas { background: #111; border: 2px solid #444; box-shadow: 0 0 20px #222; max-width: 95%; max-height: 50vh; cursor: default; }

        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        @keyframes shake { 0% { transform: translate(5px, 5px); } 50% { transform: translate(-5px, -5px); } }
        @keyframes flickerAnim { 0% { opacity: 0; } 10% { opacity: 0.95; background:#000; } 50% { opacity: 0.8; } 100% { opacity: 0; } }
        .flickering { animation: flickerAnim 0.8s linear; }

        @media (max-width: 768px) {
            #screen-gameover { flex-direction: column; }
            .lore-text { font-size: 0.9rem; }
            #hud-power-box { bottom: 100px; }
        }
    </style>
</head>
<body>

<!-- AUDIO -->
<div id="audio-container">
    <!-- ESPA√ëOL -->
    <audio id="voice-es-1" src="noche_1.mp3"></audio>
    <audio id="voice-es-2" src="noche_2.mp3"></audio>
    <audio id="voice-es-3" src="noche_3.mp3"></audio>
    <audio id="voice-es-4" src="noche_4.mp3"></audio>
    <audio id="voice-es-5" src="noche_5.mp3"></audio>
    <audio id="voice-es-6" src="noche_6.mp3"></audio>
    <audio id="voice-es-7" src="noche_7.mp3"></audio>
    <audio id="voice-es-8" src="noche_8.mp3"></audio>
    
    <!-- ENGLISH -->
    <audio id="voice-en-1" src="night_1.mp3"></audio>
    <audio id="voice-en-2" src="night_2.mp3"></audio>
    <audio id="voice-en-3" src="night_3.mp3"></audio>
    <audio id="voice-en-4" src="night_4.mp3"></audio>
    <audio id="voice-en-5" src="night_5.mp3"></audio>
    <audio id="voice-en-6" src="night_6.mp3"></audio>
    <audio id="voice-en-7" src="night_7.mp3"></audio>
    <audio id="voice-en-8" src="night_8.mp3"></audio>

    <!-- SFX -->
    <audio id="bgm-menu" src="start_song.mp3" loop></audio>
    <audio id="bgm-game" src="abandoned_factory.mp3" loop></audio>
    <audio id="bgm-minigame" src="mini_juego.mp3" loop></audio>
    <audio id="bgm-night9" src="night_9.mp3" loop></audio>
    <audio id="sfx-win" src="digital_alarm_clock.mp3"></audio>
    <audio id="sfx-monitor" src="opening_the_monitor.mp3"></audio>
    <audio id="sfx-cam" src="changing_camera.mp3"></audio>
    <audio id="sfx-curtain" src="closing_the_curtain.mp3"></audio>
    <audio id="sfx-leave" src="entity_go_away.mp3"></audio>
    <audio id="sfx-mask" src="mask_breathing.mp3" loop></audio>
    <audio id="sfx-hide" src="moving_to_hide_under.mp3"></audio>
    <audio id="sfx-flash" src="turn_on_the_flashlig.mp3"></audio>
    <audio id="sfx-maifer" src="maifer_aparece.mp3" loop></audio>
    <audio id="sfx-isaac" src="isaac_aparece.mp3" loop></audio>
    <audio id="sfx-jomar" src="jomar_aparece.mp3" loop></audio>
    <audio id="jump-richard" src="richard_jumpscare.mp3"></audio>
    <audio id="jump-jomar" src="jomar_jumpscare.mp3"></audio>
    <audio id="jump-isaac" src="isaac_jumpscare.mp3"></audio>
    <audio id="jump-maifer" src="maifer_mata.mp3"></audio>
    <audio id="sfx-gen" src="turn_on_the_light.mp3"></audio>
    <audio id="sfx-gameover" src="game_over.mp3"></audio>
    <audio id="sfx-oh" src="oh_oh.mp3"></audio>
    <audio id="jump-golden" src="golden_maifer_jumpscare.mp3"></audio>
    <audio id="sfx-night-start" src="night_shift_start.mp3"></audio>
    <audio id="sfx-vent-close" src="ventilation_closing.mp3"></audio>
</div>

<!-- DEVICE SELECTION -->
<div id="screen-device" class="screen active">
    <h1 class="title-text" style="font-size: 3rem;">SELECT DEVICE / DISPOSITIVO</h1>
    <div style="display:flex; gap:20px;">
        <button class="menu-btn" onclick="App.selectMode('PC')">PC (ORIGINAL)</button>
        <button class="menu-btn" onclick="App.selectMode('MOBILE')">MOBILE (OPTIMIZED)</button>
    </div>
    <div id="loading-bar-container">
        <div id="loading-bar"></div>
    </div>
    <p id="loading-txt" style="margin-top:10px; font-family:'VT323'; color:#0f0; display:none;">INITIALIZING SYSTEMS...</p>
</div>

<!-- INTRO SEQUENCE -->
<div id="screen-intro" class="screen">
    <div id="intro-msg" class="intro-text"></div>
</div>

<!-- MENU -->
<div id="screen-menu" class="screen">
    <div id="user-panel">
        <button id="btn-login" class="user-btn" onclick="UserSys.openAuth('login')">LOGIN</button>
        <button id="btn-reg" class="user-btn" onclick="UserSys.openAuth('reg')">REGISTER</button>
        <span id="user-display" style="color:#0f0; font-family:'VT323'; font-size:1.5rem; display:none;"></span>
    </div>
    
    <button id="lang-btn" class="menu-btn" style="width: auto;" onclick="Lang.toggle()">ESPANOL</button>
    <button id="btn-leaderboard" class="menu-btn" style="width: auto;" onclick="UI.openLeaderboard()">üèÜ RANK</button>
    
    <h1 class="title-text">MAIFER'S<br>FACTORY</h1>
    <div id="star-row"></div>
    
    <div class="menu-container">
        <button id="btn-play" class="menu-btn" onclick="Game.initNight()">JUGAR</button>
        <button id="btn-custom" class="menu-btn locked" onclick="Game.initCustomSetup()" disabled>CUSTOM NIGHT</button>
        <button id="btn-new" class="menu-btn" onclick="Game.newGame()">NUEVA PARTIDA</button>
        <button id="btn-lore" class="menu-btn" onclick="UI.openLore()">DATOS / LORE</button>
        <button id="btn-updates" class="menu-btn" onclick="UI.openUpdates()">UPDATES</button>
        <button id="btn-comm" class="menu-btn" onclick="UI.openComments()">COMUNIDAD</button>
        <button id="btn-settings" class="menu-btn" onclick="UI.openSettings()">AJUSTES</button>
    </div>
    
    <p style="position: absolute; bottom: 10px; font-size: 0.8rem; color: #444;">v47.0 - Creator Code & DB Fix</p>
    <p id="credits-text">Creado por Jonlet Santos</p>
</div>

<!-- AUTH MODAL -->
<div id="modal-auth" class="modal-overlay">
    <div class="modal-box" style="width:400px; text-align:center;">
        <h2 id="auth-title" class="lore-header">LOGIN</h2>
        <input type="text" id="auth-user" placeholder="USERNAME" style="width:80%; padding:10px; margin-bottom:10px; font-family:'VT323'; font-size:1.5rem;">
        <input type="password" id="auth-pass" placeholder="PASSWORD" style="width:80%; padding:10px; margin-bottom:20px; font-family:'VT323'; font-size:1.5rem;">
        <button id="auth-submit-btn" class="menu-btn" onclick="UserSys.submit()">SUBMIT</button>
        <button id="auth-cancel-btn" class="menu-btn" style="border-color:red;" onclick="UI.closeModals()">CANCEL</button>
    </div>
</div>

<!-- LORE MODAL -->
<div id="modal-lore" class="modal-overlay">
    <div class="modal-box">
        <h2 id="lore-title" class="lore-header">MAIFER'S FACTORY ‚Äî LORE</h2>
        <div id="lore-content" class="lore-text"></div>
        <button id="btn-close-lore" class="menu-btn" onclick="UI.closeModals()">CERRAR</button>
    </div>
</div>

<!-- UPDATES MODAL -->
<div id="modal-updates" class="modal-overlay">
    <div class="modal-box">
        <h2 class="lore-header" id="upd-title">UPDATES LOG</h2>
        <ul id="update-list" class="update-list"></ul>
        <h2 id="teaser-text" class="teaser-text"></h2>
        <button id="btn-close-upd" class="menu-btn" onclick="UI.closeModals()">CERRAR</button>
    </div>
</div>

<!-- COMMENTS MODAL -->
<div id="modal-comments" class="modal-overlay">
    <div class="modal-box">
        <h2 id="comm-title" class="lore-header">COMUNIDAD (ONLINE)</h2>
        <div id="comm-warning" style="color: #00ff00; font-size: 0.8rem; margin-bottom: 10px;">Sistema de Moderaci√≥n IA Activo</div>
        <div id="comment-feed" style="height: 300px; overflow-y: auto; border: 1px solid #333; margin-bottom: 10px; padding: 10px; background-color:#000;"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="comm-input" placeholder="Escribe algo..." style="flex:1; font-family:'VT323'; font-size:1.5rem; padding:5px;">
            <button id="btn-send-comm" class="menu-btn" style="width:auto;" onclick="CommentSystem.post()">ENVIAR</button>
        </div>
        <button id="btn-close-comm" class="menu-btn" onclick="UI.closeModals()">CERRAR</button>
    </div>
</div>

<!-- LEADERBOARD MODAL -->
<div id="modal-leaderboard" class="modal-overlay">
    <div class="modal-box">
        <h2 id="lb-title" class="lore-header">TOP SURVIVORS</h2>
        <ul id="lb-list" class="update-list" style="list-style: none;"></ul>
        <button id="btn-close-lb" class="menu-btn" onclick="UI.closeModals()">CERRAR</button>
    </div>
</div>

<!-- SETTINGS -->
<div id="modal-settings" class="modal-overlay">
    <div class="modal-box" style="height: auto;">
        <h2 id="st-title">AJUSTES</h2>
        <div class="setting-section">
            <div id="st-h-aud" class="setting-header">AUDIO</div>
            <div class="setting-row"><span id="st-vol">VOLUMEN</span><input type="range" min="0" max="100" value="100" oninput="AudioSys.setVolume(this.value)"></div>
        </div>
        <div class="setting-section">
            <div id="st-h-ctrl" class="setting-header">CONTROLES</div>
            <div class="setting-row"><span id="lbl-st-mask">MASCARA</span><button class="menu-btn" style="width:auto;font-size:1rem;" id="bind-mask" onclick="Input.rebind('mask')">SPACE</button></div>
            <div class="setting-row"><span id="lbl-st-flash">LINTERNA</span><button class="menu-btn" style="width:auto;font-size:1rem;" id="bind-flash" onclick="Input.rebind('flash')">F</button></div>
            <div class="setting-row"><span id="lbl-st-mon">MONITOR</span><button class="menu-btn" style="width:auto;font-size:1rem;" id="bind-monitor" onclick="Input.rebind('monitor')">TAB</button></div>
            <div class="setting-row"><span id="lbl-st-vent">CERRAR VENTILACION</span><button class="menu-btn" style="width:auto;font-size:1rem;" id="bind-vent" onclick="Input.rebind('vent')">V</button></div>
            <div class="setting-row"><span id="lbl-st-hide">ESCONDERSE</span><button class="menu-btn" style="width:auto;font-size:1rem;" id="bind-hide" onclick="Input.rebind('hide')">CTRL</button></div>
            <div class="setting-row"><span id="lbl-st-curt">CORTINA</span><button class="menu-btn" style="width:auto;font-size:1rem;" id="bind-curtain" onclick="Input.rebind('curtain')">S</button></div>
            <div class="setting-row"><span id="lbl-st-sens">SENSIBILIDAD</span><input type="range" min="1" max="10" value="5" oninput="Config.setSens(this.value)"></div>
        </div>
        <div class="setting-section">
            <div id="st-h-gfx" class="setting-header">GR√ÅFICOS & GAMEPLAY</div>
            <div class="setting-row"><span id="st-full">PANTALLA COMPLETA</span><button id="btn-fs-toggle" class="menu-btn" style="width: auto; font-size: 1.2rem;" onclick="Config.toggleFullscreen()">TOGGLE</button></div>
            <div class="setting-row"><span id="st-gli">EFECTO GLITCH</span><input type="checkbox" id="chk-glitch" checked onchange="Config.toggleGlitch()"></div>
            <div class="setting-row"><span id="lbl-st-static">ESTATICIDAD C√ÅMARA</span><input type="checkbox" checked onchange="Config.toggleStatic(this.checked)"></div>
            <div class="setting-row"><span id="lbl-st-3d">PERSPECTIVA 3D</span><input type="checkbox" checked onchange="Config.togglePerspective(this.checked)"></div>
            <div class="setting-row"><span id="lbl-st-shake">TEMBLOR PANTALLA</span><input type="checkbox" checked onchange="Config.toggleShake(this.checked)"></div>
            <div class="setting-row"><span id="lbl-st-qual">CALIDAD PARTICULAS</span><button class="menu-btn" style="width:auto; font-size:1rem;" id="btn-quality" onclick="Config.toggleQuality()">HIGH</button></div>
            <div class="setting-row"><span id="st-del" style="color: red;">BORRAR DATOS</span><button id="btn-del-data" class="menu-btn" style="width: auto; font-size: 1.2rem; border-color: red; color: red;" onclick="Game.hardReset()">RESET</button></div>
        </div>
        <button id="btn-save-st" class="menu-btn" onclick="UI.closeModals()">CERRAR</button>
    </div>
</div>

<!-- CUSTOM NIGHT SCREEN -->
<div id="screen-custom" class="screen">
    <h1 id="cn-title" class="title-text" style="font-size: 3rem;">CUSTOM NIGHT</h1>
    <div class="cn-grid">
        <div class="cn-char"><img src="maifer.png" class="cn-img"><span id="lbl-cn-maifer" style="color:#fff;">MAIFER</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('maifer',-1)">-</button><div id="val-maifer" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('maifer',1)">+</button></div></div>
        <div class="cn-char"><img src="isaac.png" class="cn-img"><span id="lbl-cn-isaac" style="color:#fff;">ISAAC</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('isaac',-1)">-</button><div id="val-isaac" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('isaac',1)">+</button></div></div>
        <div class="cn-char"><img src="jomar.png" class="cn-img"><span id="lbl-cn-jomar" style="color:#fff;">JOMAR</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('jomar',-1)">-</button><div id="val-jomar" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('jomar',1)">+</button></div></div>
        <div class="cn-char"><img src="richard.png" class="cn-img"><span id="lbl-cn-richard" style="color:#f00;">RICHARD</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('richard',-1)">-</button><div id="val-richard" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('richard',1)">+</button></div></div>
        <div class="cn-char" style="border-color: gold;"><img src="golden_maifer.png" class="cn-img"><span id="lbl-cn-golden" style="color:gold;">G. MAIFER</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('golden',-1)">-</button><div id="val-golden" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('golden',1)">+</button></div></div>
    </div>
    <button id="btn-cn-start" class="menu-btn" onclick="CustomNight.start()">INICIAR</button>
    <button id="btn-cn-back" class="menu-btn" style="border-color:red;" onclick="UI.showScreen('screen-menu')">ATRAS</button>
</div>

<!-- JUEGO -->
<div id="screen-game" class="screen">
    <div id="hud-time-box" class="hud-container"><div id="hud-time">12 AM</div><div id="hud-night"><span id="lbl-night">NOCHE</span> <span id="game-night-num">1</span></div></div>
    <div id="hud-power-box" class="hud-container">
        <div id="hud-power-text"><span id="lbl-pwr">PWR</span>: <span id="pwr-val">100</span>%</div>
        <div id="hud-usage">
            <span id="lbl-usage">USAGE</span>: <div id="use-1" class="usage-block"></div><div id="use-2" class="usage-block"></div><div id="use-3" class="usage-block"></div><div id="use-4" class="usage-block"></div>
        </div>
    </div>
    <div id="hud-toxic"><div id="toxic-bar"></div></div>
    <button id="btn-mute">MUTE üìû</button>

    <div id="view-office">
        <div id="layer-flicker"></div>
        <div id="curtain-window">
            <img id="vis-richard-win" src="richard.png">
            <div id="curtain-fabric"></div>
            <button id="curtain-btn" onclick="Mechanics.toggleCurtain()">CLOSE</button>
        </div>
        <div id="vent-system"><img id="vent-img" src=""><div id="vent-grill"></div><div id="vent-door"></div><button id="vent-btn" onclick="Mechanics.toggleVent()">CLOSE</button></div>
        <div id="hallway"><img id="vis-jomar" class="anim-img" src="jomar.png"></div>
        <img id="vis-isaac" class="anim-img" src="isaac.png">
        <img id="vis-maifer" class="anim-img" src="maifer.png">
        <div id="gen-panel"><div id="gen-fan"></div><button id="gen-btn" onclick="Mechanics.chargeGen()"></button></div>
        <div id="desk"><button id="btn-cam-sys" class="monitor-btn" onclick="Mechanics.toggleMonitor()">[ SYSTEM ]</button></div>
    </div>

    <div id="layer-mask"></div><div id="layer-flashlight"></div><div id="layer-under-desk"><h2 id="lbl-under">DEBAJO DE LA MESA</h2></div>

    <div id="screen-monitor">
        <div style="color:#fff; display:flex; justify-content:space-between; width:100%;"><span><span id="lbl-sys">SYSTEM</span>: CAM <span id="cam-id">06</span></span><span style="color:red;" id="rec-dot">‚óè REC</span></div>
        <div id="cam-view"><div id="cam-static"></div><div id="cam-content"><h1 style="color:#333;">NO SIGNAL</h1></div></div>
        <div id="map-layout">
            <div id="room-06" class="map-room"></div><div id="room-04" class="map-room"></div><div id="room-05" class="map-room"></div>
            <div id="room-02" class="map-room"></div><div id="room-03" class="map-room"></div><div id="room-you" class="map-room">YOU</div>
            <button id="btn-c6" class="cam-btn active" onclick="Monitor.setCam(6)">06</button><button id="btn-c4" class="cam-btn" onclick="Monitor.setCam(4)">04</button><button id="btn-c5" class="cam-btn" onclick="Monitor.setCam(5)">05</button><button id="btn-c2" class="cam-btn" onclick="Monitor.setCam(2)">02</button><button id="btn-c3" class="cam-btn" onclick="Monitor.setCam(3)">03</button><button id="btn-c1" class="cam-btn" onclick="Monitor.setCam(1)">01</button>
            <button id="btn-close-mon" onclick="Mechanics.toggleMonitor()">CLOSE X</button>
        </div>
    </div>

    <div id="mobile-controls">
        <button class="mob-btn" onclick="Mechanics.toggleMask()">MASK</button>
        <button class="mob-btn" onclick="Mechanics.toggleFlashlight()">LITE</button>
        <button class="mob-btn" onclick="Mechanics.toggleHide()">HIDE</button>
        <button class="mob-btn" onclick="Mechanics.toggleCurtain()">CURT</button>
        <button class="mob-btn" onclick="Mechanics.toggleMonitor()">CAM</button>
    </div>
</div>

<div id="screen-win" class="screen">
    <h1 style="font-family:'VT323'; font-size:6rem; color:#00aaff;">YOU WIN</h1>
    <div id="win-stars" style="display:flex; gap:10px;"></div>
    <p id="win-msg"></p>
    <button class="menu-btn" onclick="location.reload()">MENU</button>
</div>

<div id="screen-8am" class="screen"><h1 style="font-family:'VT323'; font-size:8rem; color:#0f0;">8:00 AM</h1><p id="lbl-win" style="color:#fff; font-size: 2rem;">TURNO FINALIZADO.</p></div>

<div id="screen-minigame" class="screen">
    <div id="mg-info">MINIJUEGO</div>
    <canvas id="mg-canvas" width="600" height="400"></canvas>
    <div id="mg-controls-hint">Instrucciones aqu√≠</div>
</div>

<div id="screen-gameover" class="screen">
    <div id="death-card">
        <h1 id="go-title" style="color:red; font-family:'Nosifer';">GAME OVER</h1>
        <img id="death-img" src="screen_death.png">
        <p id="death-reason" style="color:#fff;">...</p>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="btn-retry" class="menu-btn" onclick="Game.initNight()">RETRY</button>
        <button id="btn-go-menu" class="menu-btn" onclick="location.reload()">MENU</button>
    </div>
</div>

<div id="screen-jumpscare" class="screen"><img id="jump-img" src=""></div>

<div id="screen-warning" class="modal-overlay" style="display:none; z-index:9999; background:black;">
    <div class="modal-box" style="text-align:center; border-color:yellow;">
        <h1 id="warn-title" style="color:yellow; font-family:'VT323'; font-size:3rem;">‚ö† AUDIO WARNING ‚ö†</h1>
        <p id="warn-txt" style="font-family:'Share Tech Mono'; font-size:1.2rem; margin:20px;">
            Este juego usa se√±ales de audio 3D y sonidos fuertes.<br>Se recomienda jugar con AUD√çFONOS.
        </p>
        <button id="btn-warn-ok" class="menu-btn" onclick="UI.closeWarning(false)">ACEPTAR</button>
        <button id="btn-warn-stop" class="menu-btn" style="border-color:#555; color:#888;" onclick="UI.closeWarning(true)">NO MOSTRAR MAS</button>
    </div>
</div>

<script>
// ============================================================================
// VARIABLES & FIREBASE (VERSION v47)
// ============================================================================
const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
const firebaseConfig = { apiKey: "AIzaSyC6whCq_9B-yeqzHvLWbswadJwCXRnqmt0", authDomain: "maifer-factory.firebaseapp.com", databaseURL: "https://maifer-factory-default-rtdb.firebaseio.com", projectId: "maifer-factory", storageBucket: "maifer-factory.firebasestorage.app", messagingSenderId: "700963667348", appId: "1:700963667348:web:6fd8dba0bcb3ada7a2e381" };
if(typeof firebase !== 'undefined') firebase.initializeApp(firebaseConfig);

const DB_PATH = { users: 'users_v47', rank: 'leaderboard_v47', comm: 'comments_v47' };

let SAVEDATA = { night: 1, stars: {}, binds: null, leaderboard: [], comments: [], user: null, lang: 'ES', audioWarn: false };

try {
    let l = localStorage.getItem('mf_v47');
    if(l) SAVEDATA = JSON.parse(l);
} catch(e) {}

const SaveManager = {
    save: () => {
        try {
            localStorage.setItem('mf_v47', JSON.stringify(SAVEDATA));
        } catch(e) { console.error("Local Save Error:", e); }

        if(SAVEDATA.user && typeof firebase !== 'undefined') {
            const cleanUser = SAVEDATA.user.toLowerCase().replace('.', '_');
            firebase.database().ref(DB_PATH.users + '/' + cleanUser + '/data').set(SAVEDATA)
                .then(() => console.log("Cloud Save Success"))
                .catch(err => console.error("Cloud Save Error:", err));
        }
    }
};

const TEXTS = {
    ES: {
        play: "JUGAR (NOCHE", new: "NUEVA PARTIDA", lore: "DATOS / LORE", st: "AJUSTES", custom: "NOCHE PERSONALIZADA",
        updates: "NOVEDADES", comm: "COMUNIDAD", rank: "CLASIFICACION", close: "CERRAR", created: "Creado por Jonlet Santos",
        login: "INICIAR SESION", reg: "REGISTRARSE", agent: "AGENTE",
        auth_user_ph: "USUARIO", auth_pass_ph: "CONTRASE√ëA", auth_submit: "ENVIAR", auth_cancel: "CANCELAR",
        auth_login_t: "INICIAR SESION", auth_reg_t: "REGISTRAR CUENTA",
        
        cn_title: "NOCHE PERSONALIZADA", cn_start: "INICIAR", cn_back: "ATRAS",
        char_maifer: "MAIFER", char_isaac: "ISAAC", char_jomar: "JOMAR", char_richard: "RICHARD", char_golden: "G. MAIFER",
        
        night_p: "NOCHE", under: "DEBAJO DE LA MESA", win_turn: "TURNO FINALIZADO", g_over: "FIN DEL JUEGO", retry: "REINTENTAR",
        pwr: "ENERGIA", use: "USO", sys: "SISTEMA", you: "TU", no_sig: "SIN SE√ëAL", rec: "GRABANDO", cam_lbl: "CAMARA",
        mon_idle: "INACTIVO", mon_detected: "DETECTADO", mon_near: "CERCA",
        mute: "SILENCIAR LLAMADA",
        
        d_maifer: "Maifer te atrap√≥.", d_isaac: "Isaac no fue enga√±ado.", d_jomar: "La oscuridad te consumi√≥.",
        d_richard: "No cerraste la cortina.", d_golden: "ERES DEMASIADO LENTO.", d_power: "SIN ENERGIA.", d_air: "SIN AIRE.",
        
        st_title: "AJUSTES", audio: "AUDIO", vol: "VOLUMEN", st_h_ctrl: "CONTROLES", gfx: "GRAFICOS Y JUEGO",
        del_data: "BORRAR DATOS (RESET)", reset_btn: "REINICIAR TODO", glitch: "EFECTO GLITCH", toggle: "INTERCAMBIAR",
        full: "PANTALLA COMPLETA", st_mask: "M√ÅSCARA", st_flash: "LINTERNA", st_mon: "MONITOR", st_vent: "CERRAR VENT.",
        st_hide: "ESCONDERSE", st_curt: "CORTINA", st_sens: "SENSIBILIDAD", st_shake: "TEMBLOR PANTALLA", st_qual: "CALIDAD PARTICULAS",
        st_qual_high: "ALTA", st_qual_low: "BAJA",
        
        comm_title: "COMUNIDAD ONLINE", comm_warn: "Reglas: Solo Bugs/Ideas. No Insultos.", comm_ph: "Escribe algo...", send: "ENVIAR",
        lb_title: "MEJORES SUPERVIVIENTES",
        warn_t: "‚ö† ADVERTENCIA DE AUDIO ‚ö†", warn_d: "Juego con audio 3D y ruidos fuertes. Usa aud√≠fonos.", warn_ok: "ACEPTAR", warn_no: "NO MOSTRAR MAS",
        
        upd_title: "REGISTRO DE CAMBIOS",
        updates_log: ["‚úÖ FIX: Error 'DB undefined' reparado", "‚úÖ NEW: Modo Creador (Secreto)", "‚úÖ FIX: Cuentas 100% Funcionales", "‚úÖ NUEVO: Audio Noches 1-8", "‚úÖ MECANICA: Pausa en llamada"],
        
        mg_inst: "FLECHAS / MOUSE / ESPACIO",
        mg1: "ESQUIVA LOS OBSTACULOS", mg2: "ENCUENTRA LA CAJA AZUL", mg3: "CLICK EN ORBES VERDES",
        mg4: "EVITA LOS CUBOS ROJOS", mg5: "MANTEN LA CARGA (ESPACIO)", mg6: "DETENTE EN ROJO, AVANZA EN VERDE",
        mg7: "LLEGA A LA META DORADA", mg8: "SOBREVIVE AL INFIERNO",
        
        lore_txt: "üìñ MAIFER‚ÄôS FACTORY ‚Äî LORE OFICIAL\n\nMaifer‚Äôs Factory es una antigua f√°brica industrial.\n\nüë§ EL PROTAGONISTA\nAceptas el trabajo por necesidad.\n\n‚òéÔ∏è LA CHICA DEL TEL√âFONO\nCada noche recibes una llamada.\n\nü§ñ LOS ROBOTS\nüü° MAIFER: Agresivo. Esc√≥ndete.\nüé≠ ISAAC: Responde a rostros. Usa la m√°scara.\nüî¶ JOMAR: Odia la luz.\nüü• RICHARD: Cierra la cortina.",
        
        ng_warn: "¬øSeguro? Esto reiniciar√° la noche actual.", del_warn: "¬°ESTO BORRA TODO TU PROGRESO! ¬øSEGURO?",
        guest_err: "DEBES INICIAR SESION.", banned: "ESTAS BANEADO."
    },
    
    EN: {
        play: "PLAY (NIGHT", new: "NEW GAME", lore: "DATA / LORE", st: "SETTINGS", custom: "CUSTOM NIGHT",
        updates: "UPDATES", comm: "COMMUNITY", rank: "LEADERBOARD", close: "CLOSE", created: "Created by Jonlet Santos",
        login: "LOGIN", reg: "REGISTER", agent: "AGENT",
        auth_user_ph: "USERNAME", auth_pass_ph: "PASSWORD", auth_submit: "SUBMIT", auth_cancel: "CANCEL",
        auth_login_t: "LOGIN", auth_reg_t: "REGISTER ACCOUNT",
        
        cn_title: "CUSTOM NIGHT", cn_start: "START", cn_back: "BACK",
        char_maifer: "MAIFER", char_isaac: "ISAAC", char_jomar: "JOMAR", char_richard: "RICHARD", char_golden: "G. MAIFER",
        
        night_p: "NIGHT", under: "UNDER THE DESK", win_turn: "SHIFT COMPLETED", g_over: "GAME OVER", retry: "RETRY",
        pwr: "POWER", use: "USAGE", sys: "SYSTEM", you: "YOU", no_sig: "NO SIGNAL", rec: "REC", cam_lbl: "CAM",
        mon_idle: "IDLE", mon_detected: "DETECTED", mon_near: "NEAR",
        mute: "MUTE CALL",
        
        d_maifer: "Maifer caught you.", d_isaac: "Isaac wasn't fooled.", d_jomar: "Darkness took you.",
        d_richard: "Curtain wasn't closed.", d_golden: "YOU ARE TOO SLOW.", d_power: "NO POWER.", d_air: "NO AIR.",
        
        st_title: "SETTINGS", audio: "AUDIO", vol: "VOLUME", st_h_ctrl: "CONTROLS", gfx: "GRAPHICS & GAMEPLAY",
        del_data: "DELETE DATA (RESET)", reset_btn: "RESET ALL", glitch: "GLITCH EFFECT", toggle: "TOGGLE",
        full: "FULLSCREEN", st_mask: "MASK", st_flash: "FLASHLIGHT", st_mon: "MONITOR", st_vent: "CLOSE VENT",
        st_hide: "HIDE", st_curt: "CURTAIN", st_sens: "SENSITIVITY", st_shake: "SCREEN SHAKE", st_qual: "PARTICLE QUALITY",
        st_qual_high: "HIGH", st_qual_low: "LOW",
        
        comm_title: "ONLINE COMMUNITY", comm_warn: "Rules: Bugs/Ideas Only. No Insults.", comm_ph: "Type something...", send: "SEND",
        lb_title: "TOP SURVIVORS",
        warn_t: "‚ö† AUDIO WARNING ‚ö†", warn_d: "3D Audio & Loud Noises. Headphones recommended.", warn_ok: "ACCEPT", warn_no: "DON'T SHOW AGAIN",
        
        upd_title: "CHANGE LOG",
        updates_log: ["‚úÖ FIX: 'DB undefined' error fixed", "‚úÖ NEW: Creator Mode (Secret)", "‚úÖ FIX: Accounts 100% Working", "‚úÖ NEW: Audio Nights 1-8", "‚úÖ MECH: Game Paused during call"],
        
        mg_inst: "ARROWS / MOUSE / SPACE",
        mg1: "DODGE OBSTACLES", mg2: "FIND BLUE BOX", mg3: "CLICK GREEN ORBS",
        mg4: "AVOID RED CUBES", mg5: "KEEP CHARGE (SPACE)", mg6: "STOP ON RED, GO ON GREEN",
        mg7: "REACH GOLD GOAL", mg8: "SURVIVE HELL",
        
        lore_txt: "üìñ MAIFER‚ÄôS FACTORY ‚Äî OFFICIAL LORE\n\nMaifer‚Äôs Factory is an old industrial factory.\n\nüë§ THE PROTAGONIST\nYou need the job.\n\n‚òéÔ∏è PHONE GIRL\nMysterious caller every night.\n\nü§ñ THE ROBOTS\nüü° MAIFER: Aggressive. Hide.\nüé≠ ISAAC: Use mask.\nüî¶ JOMAR: Hates light.\nüü• RICHARD: Close curtain.",
        
        ng_warn: "Sure? This resets current night.", del_warn: "THIS WIPES ALL DATA! SURE?",
        guest_err: "LOGIN REQUIRED.", banned: "YOU ARE BANNED."
    },
    
    CN: {
        play: "ÂºÄÂßãÊ∏∏Êàè (Â§ú", new: "Êñ∞Ê∏∏Êàè", lore: "Êï∞ÊçÆ / ‰º†ËØ¥", st: "ËÆæÁΩÆ", custom: "Ëá™ÂÆö‰πâÂ§ú",
        updates: "Êõ¥Êñ∞", comm: "Á§æÂå∫", rank: "ÊéíË°åÊ¶ú", close: "ÂÖ≥Èó≠", created: "Jonlet Santos Âà∂‰Ωú",
        login: "ÁôªÂΩï", reg: "Ê≥®ÂÜå", agent: "ÁâπÂ∑•",
        auth_user_ph: "Áî®Êà∑Âêç", auth_pass_ph: "ÂØÜÁ†Å", auth_submit: "Êèê‰∫§", auth_cancel: "ÂèñÊ∂à",
        auth_login_t: "ÁôªÂΩï", auth_reg_t: "Ê≥®ÂÜåË¥¶Êà∑",
        
        cn_title: "Ëá™ÂÆö‰πâÂ§ú", cn_start: "ÂºÄÂßã", cn_back: "ËøîÂõû",
        char_maifer: "MAIFER", char_isaac: "ISAAC", char_jomar: "JOMAR", char_richard: "RICHARD", char_golden: "G. MAIFER",
        
        night_p: "Â§ú", under: "Ê°åÂ≠êÂ∫ï‰∏ã", win_turn: "ËΩÆÁè≠ÁªìÊùü", g_over: "Ê∏∏ÊàèÁªìÊùü", retry: "ÈáçËØï",
        pwr: "ÁîµÂäõ", use: "‰ΩøÁî®", sys: "Á≥ªÁªü", you: "‰Ω†", no_sig: "Êó†‰ø°Âè∑", rec: "ÂΩïÂà∂", cam_lbl: "Áõ∏Êú∫",
        mon_idle: "Èó≤ÁΩÆ", mon_detected: "Ê£ÄÊµãÂà∞", mon_near: "Èù†Ëøë",
        mute: "ÈùôÈü≥ÈÄöËØù",
        
        d_maifer: "Maifer Êäì‰Ωè‰∫Ü‰Ω†„ÄÇ", d_isaac: "Isaac Ê≤°Ë¢´È™óËøá„ÄÇ", d_jomar: "ÈªëÊöóÂêûÂô¨‰∫Ü‰Ω†„ÄÇ",
        d_richard: "Á™óÂ∏òÊ≤°ÂÖ≥„ÄÇ", d_golden: "‰Ω†Â§™ÊÖ¢‰∫Ü„ÄÇ", d_power: "Ê≤°Áîµ‰∫Ü„ÄÇ", d_air: "Ê≤°Á©∫Ê∞î„ÄÇ",
        
        st_title: "ËÆæÁΩÆ", audio: "Èü≥È¢ë", vol: "Èü≥Èáè", st_h_ctrl: "ÊéßÂà∂", gfx: "ÂõæÂΩ¢ÂíåÊ∏∏Êàè",
        del_data: "Âà†Èô§Êï∞ÊçÆ", reset_btn: "ÂÖ®ÈÉ®ÈáçÁΩÆ", glitch: "ÊïÖÈöúÊïàÊûú", toggle: "ÂàáÊç¢",
        full: "ÂÖ®Â±è", st_mask: "Èù¢ÂÖ∑", st_flash: "ÊâãÁîµÁ≠í", st_mon: "ÁõëËßÜÂô®", st_vent: "ÂÖ≥Èó≠ÈÄöÈ£é",
        st_hide: "ÈöêËóè", st_curt: "Á™óÂ∏ò", st_sens: "ÁÅµÊïèÂ∫¶", st_shake: "Â±èÂπïÈúáÂä®", st_qual: "Á≤íÂ≠êË¥®Èáè",
        st_qual_high: "È´ò", st_qual_low: "‰Ωé",
        
        comm_title: "Âú®Á∫øÁ§æÂå∫", comm_warn: "ËßÑÂàôÔºöÁ¶ÅÊ≠¢‰æÆËæ±„ÄÇÊä•ÂëäÈîôËØØ„ÄÇ", comm_ph: "ÂÜôÁÇπ‰ªÄ‰πà...", send: "ÂèëÈÄÅ",
        lb_title: "ÊúÄ‰Ω≥Âπ∏Â≠òËÄÖ",
        warn_t: "‚ö† Èü≥È¢ëË≠¶Âëä ‚ö†", warn_d: "3D Èü≥È¢ëÂíåÂ∑®Âìç„ÄÇÊé®ËçêËÄ≥Êú∫„ÄÇ", warn_ok: "Êé•Âèó", warn_no: "‰∏çÂÜçÊòæÁ§∫",
        
        upd_title: "Êõ¥Êñ∞Êó•Âøó",
        updates_log: ["‚úÖ ‰øÆÂ§çÔºö'DB undefined' ÈîôËØØ", "‚úÖ Êñ∞Â¢ûÔºöÂàõ‰ΩúËÄÖÊ®°ÂºèÔºàÁßòÂØÜÔºâ", "‚úÖ ‰øÆÂ§çÔºöÁôªÂΩï/Ê≥®ÂÜå", "‚úÖ Êñ∞Â¢ûÔºöÈü≥È¢ë 1-8 Â§ú", "‚úÖ Êú∫Âà∂ÔºöÈÄöËØùÊúüÈó¥Ê∏∏ÊàèÊöÇÂÅú"],
        
        mg_inst: "ÁÆ≠Â§¥ / Èº†Ê†á / Á©∫Ê†º",
        mg1: "Ë∫≤ÈÅøÈöúÁ¢ç", mg2: "ÊâæÂà∞ËìùÁõíÂ≠ê", mg3: "ÁÇπÂáªÁªøËâ≤ÁêÉ",
        mg4: "ÈÅøÂºÄÁ∫¢ÊñπÂùó", mg5: "‰øùÊåÅÂÖÖÁîµ (Á©∫Ê†º)", mg6: "Á∫¢ÁÅØÂÅú ÁªøÁÅØË°å",
        mg7: "Âà∞ËææÈáëËâ≤ÁõÆÊ†á", mg8: "Âú®Âú∞Áã±‰∏≠ÁîüÂ≠ò",
        
        lore_txt: "üìñ MAIFER‚ÄôS FACTORY ‚Äî ÂÆòÊñπ‰º†ËØ¥\n\nMaifer Â∑•ÂéÇÊòØ‰∏ÄÂÆ∂ËÄÅÂ∑•ÂéÇ„ÄÇ\n\nüë§ ‰∏ªËßí\n‰Ω†ÈúÄË¶ÅËøô‰ªΩÂ∑•‰Ωú„ÄÇ\n\n‚òéÔ∏è ÁîµËØùÂ•≥Â≠©\nÊØèÊôöÁ•ûÁßòÊù•Áîµ„ÄÇ\n\nü§ñ Êú∫Âô®‰∫∫\nüü° MAIFER: Ë∫≤Ëóè„ÄÇ\nüé≠ ISAAC: Áî®Èù¢ÂÖ∑„ÄÇ\nüî¶ JOMAR: ËÆ®ÂéåÂÖâ„ÄÇ\nüü• RICHARD: ÂÖ≥Á™óÂ∏ò„ÄÇ",
        
        ng_warn: "Á°ÆÂÆöÔºüËøôÂ∞ÜÈáçÁΩÆÂΩìÂâçÂ§úÊôö„ÄÇ", del_warn: "ËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆÔºÅÁ°ÆÂÆöÔºü",
        guest_err: "ÈúÄË¶ÅÁôªÂΩï„ÄÇ", banned: "‰Ω†Â∑≤Ë¢´Â∞ÅÁ¶Å„ÄÇ"
    }
};

const Lang = {
    current: SAVEDATA.lang || 'ES',
    toggle: () => { 
        const order = ['ES', 'EN', 'CN']; 
        let idx = order.indexOf(Lang.current); 
        Lang.current = order[(idx + 1) % 3]; 
        SAVEDATA.lang = Lang.current; 
        SaveManager.save(); 
        Lang.apply(); 
    },
    setText: (id, txt) => { 
        const el = document.getElementById(id); 
        if (el && txt) el.innerText = txt; 
    },
    apply: () => {
        const t = TEXTS[Lang.current];
        document.getElementById('lang-btn').innerText = Lang.current === 'CN' ? '‰∏≠Êñá' : (Lang.current === 'ES' ? 'ESPA√ëOL' : 'ENGLISH');
        let nDisplay = SAVEDATA.night > 8 ? 8 : SAVEDATA.night;
        let nightStr = Lang.current === 'CN' ? (" " + nDisplay + " Â§ú") : (" " + nDisplay);
        
        document.getElementById('btn-play').innerHTML = `${t.play} <span id="menu-night">${nightStr}</span>)`;
        Lang.setText('btn-new', t.new); Lang.setText('btn-lore', t.lore); Lang.setText('btn-updates', t.updates);
        Lang.setText('btn-comm', t.comm); Lang.setText('btn-settings', t.st); Lang.setText('credits-text', t.created);
        Lang.setText('btn-leaderboard', "üèÜ " + t.rank); Lang.setText('btn-login', t.login); Lang.setText('btn-reg', t.reg);
        
        const authMode = document.getElementById('auth-title').getAttribute('data-mode');
        Lang.setText('auth-title', authMode === 'login' ? t.auth_login_t : t.auth_reg_t);
        document.getElementById('auth-user').placeholder = t.auth_user_ph; document.getElementById('auth-pass').placeholder = t.auth_pass_ph;
        Lang.setText('auth-submit-btn', t.auth_submit); Lang.setText('auth-cancel-btn', t.auth_cancel);
        
        Lang.setText('cn-title', t.cn_title); Lang.setText('lbl-cn-maifer', t.char_maifer); Lang.setText('lbl-cn-isaac', t.char_isaac);
        Lang.setText('lbl-cn-jomar', t.char_jomar); Lang.setText('lbl-cn-richard', t.char_richard); Lang.setText('lbl-cn-golden', t.char_golden);
        Lang.setText('btn-cn-start', t.cn_start); Lang.setText('btn-cn-back', t.cn_back);
        
        Lang.setText('st-title', t.st_title); Lang.setText('st-h-aud', t.audio); Lang.setText('st-vol', t.vol);
        Lang.setText('st-h-ctrl', t.st_h_ctrl); Lang.setText('st-h-gfx', t.gfx); Lang.setText('st-full', t.full);
        Lang.setText('st-gli', t.glitch); Lang.setText('st-del', t.del_data); Lang.setText('btn-fs-toggle', t.toggle);
        Lang.setText('btn-del-data', t.reset_btn); Lang.setText('btn-save-st', t.close);
        Lang.setText('lbl-st-mask', t.st_mask); Lang.setText('lbl-st-flash', t.st_flash); Lang.setText('lbl-st-mon', t.st_mon);
        Lang.setText('lbl-st-vent', t.st_vent); Lang.setText('lbl-st-hide', t.st_hide); Lang.setText('lbl-st-curt', t.st_curt);
        Lang.setText('lbl-st-sens', t.st_sens); Lang.setText('lbl-st-shake', t.st_shake); Lang.setText('lbl-st-qual', t.st_qual);
        Lang.setText('btn-quality', Config.particlesHigh ? t.st_qual_high : t.st_qual_low);
        
        Lang.setText('upd-title', t.upd_title); Lang.setText('btn-close-upd', t.close);
        const ul = document.getElementById('update-list'); if(ul) ul.innerHTML = t.updates_log.map(u => `<li>${u}</li>`).join('');
        
        Lang.setText('btn-close-lore', t.close); Lang.setText('lore-content', t.lore_txt);
        Lang.setText('comm-title', t.comm_title); Lang.setText('comm-warning', t.comm_warn); document.getElementById('comm-input').placeholder = t.comm_ph;
        Lang.setText('btn-send-comm', t.send); Lang.setText('btn-close-comm', t.close); Lang.setText('lb-title', t.lb_title); Lang.setText('btn-close-lb', t.close);
        
        Lang.setText('warn-title', t.warn_t); Lang.setText('warn-txt', t.warn_d); Lang.setText('btn-warn-ok', t.warn_ok); Lang.setText('btn-warn-stop', t.warn_no);
        
        Lang.setText('lbl-night', t.night_p); Lang.setText('lbl-pwr', t.pwr); Lang.setText('lbl-usage', t.use);
        Lang.setText('lbl-sys', t.sys); Lang.setText('lbl-under', t.under); Lang.setText('lbl-win', t.win_turn);
        Lang.setText('go-title', t.g_over); Lang.setText('btn-retry', t.retry); Lang.setText('btn-go-menu', t.close); 
        Lang.setText('room-you', t.you); Lang.setText('rec-dot', "‚óè " + t.rec); Lang.setText('btn-close-mon', t.close_x);
        Lang.setText('btn-mute', t.mute + " üìû");
        
        Lang.setText('mg-info', t['mg'+MiniGames.night] || "MINIGAME"); Lang.setText('mg-controls-hint', t.mg_inst);
        if(SAVEDATA.user) Lang.setText('user-display', t.agent + ": " + SAVEDATA.user);
    }
};

const Game = {
    state: { frozen: false }, timers: {}, ai: {}, goldenState: { active: false, timer: null },

    initMenu: () => {
        UserSys.updateUI();
        const row = document.getElementById('star-row');
        row.innerHTML = '';
        
        // CORRECCI√ìN DEFENSIVA: Verifica que SAVEDATA.stars exista antes de leer
        if(!SAVEDATA.stars) SAVEDATA.stars = {};

        if(SAVEDATA.night > 6) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 7) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 8) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 9) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        
        // Uso seguro de la propiedad 'custom'
        if(SAVEDATA.stars['custom']) row.innerHTML = '<span class="star earned blue">‚òÖ</span><span class="star earned blue">‚òÖ</span><span class="star earned blue">‚òÖ</span><span class="star earned blue">‚òÖ</span>';
        
        if(SAVEDATA.night > 8) document.getElementById('btn-custom').classList.remove('locked');
        document.getElementById('btn-custom').disabled = SAVEDATA.night <= 8;
        Lang.apply(); AudioSys.play('bgm-menu', true);
    },

    newGame: () => { if(confirm(TEXTS[Lang.current].ng_warn)) { SAVEDATA.night = 1; SaveManager.save(); location.reload(); } },
    hardReset: () => { if(confirm(TEXTS[Lang.current].del_warn)) { localStorage.clear(); location.reload(); } },

    initNight: () => { let n = parseInt(SAVEDATA.night); if(n > 8) n = 8; Game.startSequence(n); },
    initCustomSetup: () => { UI.showScreen('screen-custom'); },

    startSequence: (n, customAI=null) => {
        AudioSys.stopAll(); UI.showScreen('screen-intro');
        const t = TEXTS[Lang.current];
        let nightTxt = Lang.current === 'CN' ? (t.night_p + " " + (n==='CUSTOM'?'?':n)) : (t.night_p + " " + (n==='CUSTOM'?'CUSTOM':n));
        document.getElementById('intro-msg').innerText = nightTxt + " - 12:00 AM";
        const introAudio = (n === 9) ? 'bgm-night9' : 'sfx-night-start';
        AudioSys.play(introAudio);
        
        let started = false;
        const doStart = () => { if(started) return; started = true; Game.startLevel(n, customAI); };
        setTimeout(doStart, n===9 ? 8000 : 5000);
    },

    startLevel: (n, customAI=null) => {
        Game.state = { night: n, power: 100, time: 0, batteryTimer: 0, over: false, view: 'office', mask: false, hidden: false, curtain: false, flash: false, toxic: 0, vent: false, inMinigame: false, frozen: false };
        
        if(n === 'CUSTOM') { Game.ai = { ...customAI, pos: {maifer:0, isaac:0, jomar:0, vent:0, richard:0}, busy: false }; }
        else if (n === 9) { Game.ai = { maifer:20, isaac:20, jomar:20, richard:20, golden: (customAI?customAI.golden:0), pos: {maifer:0, isaac:0, jomar:0, vent:0, richard:0}, busy: false }; }
        else { 
            const diff = {1:{m:2,i:1,j:1,r:0}, 2:{m:4,i:3,j:2,r:1}, 3:{m:6,i:5,j:5,r:3}, 4:{m:8,i:8,j:7,r:5}, 5:{m:10,i:10,j:10,r:7}, 6:{m:12,i:12,j:12,r:10}, 7:{m:15,i:15,j:15,r:15}, 8:{m:20,i:20,j:20,r:20}};
            const d = diff[n] || diff[8];
            Game.ai = { maifer:d.m, isaac:d.i, jomar:d.j, richard:d.r, golden:0, pos: {maifer:0, isaac:0, jomar:0, vent:0, richard:0}, busy: false };
        }
        
        let nStr = n === 'CUSTOM' ? 'C' : n; if(Lang.current === 'CN' && typeof n === 'number') nStr = n;
        document.getElementById('game-night-num').innerText = nStr;
        UI.showScreen('screen-game'); if(isMobile) document.getElementById('mobile-controls').style.display = 'flex';
        
        Mechanics.resetVisuals();
        
        let voiceID = null;
        if(typeof n === 'number' && n >= 1 && n <= 8) {
            if(Lang.current === 'ES') voiceID = 'voice-es-' + n;
            else if(Lang.current === 'EN') voiceID = 'voice-en-' + n;
        }

        if(voiceID) {
            Game.state.frozen = true; 
            document.getElementById('btn-mute').style.display = 'block';
            AudioSys.play(voiceID);
            
            document.getElementById(voiceID).onended = () => { 
                Game.state.frozen = false; 
                document.getElementById('btn-mute').style.display = 'none';
                if(n!==9) AudioSys.play('bgm-game', true, 0.6); 
            };

            document.getElementById('btn-mute').onclick = () => {
                AudioSys.stop(voiceID);
                Game.state.frozen = false;
                document.getElementById('btn-mute').style.display = 'none';
                if(n!==9) AudioSys.play('bgm-game', true, 0.6);
            };
        } else {
            Game.state.frozen = false;
            document.getElementById('btn-mute').style.display = 'none';
            if(n!==9) AudioSys.play('bgm-game', true, 0.6); 
        }

        if(Game.timers.main) clearInterval(Game.timers.main);
        if(Game.timers.ai) clearInterval(Game.timers.ai);
        if(Game.timers.golden) clearInterval(Game.timers.golden);
        
        Game.timers.main = setInterval(Game.loop, 100);
        Game.timers.ai = setInterval(Game.aiLoop, (n>=8)?1000:2000);
        if(n>=6 || Game.ai.golden > 0) Game.timers.golden = setInterval(Game.goldenLoop, 5000);
        
        Lang.apply();
    },

    loop: () => {
        if(Game.state.over || Game.state.inMinigame || Game.state.frozen) return;
        Game.state.time += 0.048; 
        let hour = 12 + Math.floor(Game.state.time / 16.6); if(hour > 12) hour -= 12;
        document.getElementById('hud-time').innerText = (hour === 0 ? 12 : hour) + " AM";
        if(Game.state.time >= 100) { Game.reach8AM(); return; }
        
        let drain = 1 + (Game.state.flash?2:0) + (Game.state.vent?1:0) + (Game.state.view==='monitor'?1:0) + (Game.state.curtain?1:0);
        Game.state.batteryTimer += drain;
        if(Game.state.batteryTimer >= 50) { Game.state.power--; Game.state.batteryTimer = 0; document.getElementById('pwr-val').innerText = Math.floor(Game.state.power); }
        if(Game.state.power <= 0) { Game.die('power'); return; }

        if(Game.state.mask) { Game.state.toxic += 0.25; document.getElementById('hud-toxic').style.display='block'; }
        else { Game.state.toxic = Math.max(0, Game.state.toxic - 0.2); if(Game.state.toxic<=0) document.getElementById('hud-toxic').style.display='none'; }
        document.getElementById('toxic-bar').style.width = Game.state.toxic + "%";
        if(Game.state.toxic >= 100) { Game.die('air'); return; }
        
        Monitor.update();
    },

    aiLoop: () => {
        if(Game.state.over || Game.state.frozen) return;
        if(Game.ai.pos.jomar === 1) { Game.die('jomar'); return; }
        if(Game.ai.busy && Game.state.night < 8) return;
        
        const rng = (lvl) => (Math.random() * 20) < lvl;
        
        if(rng(Game.ai.maifer) && Game.ai.pos.maifer < 5 && Game.ai.pos.vent !== 'maifer') {
            Game.ai.pos.maifer++;
            if(Game.ai.pos.maifer === 5) {
                Game.ai.busy = true; UI.flicker();
                setTimeout(() => {
                    AudioSys.play('sfx-maifer', true, 0.3); document.getElementById('vis-maifer').style.display = 'block';
                    setTimeout(() => {
                        if(!Game.state.hidden) Game.die('maifer');
                        else { AudioSys.stopLoops(); AudioSys.play('sfx-leave'); document.getElementById('vis-maifer').style.display = 'none'; Game.ai.pos.maifer = 0; Game.ai.busy = false; }
                    }, 3500);
                }, 1000);
            }
        }
        
        if(rng(Game.ai.isaac) && Game.ai.pos.isaac < 5 && Game.ai.pos.vent !== 'isaac') {
            Game.ai.pos.isaac++;
            if(Game.ai.pos.isaac === 5) {
                Game.ai.busy = true; UI.flicker();
                setTimeout(() => {
                    AudioSys.play('sfx-isaac', true, 0.3); document.getElementById('vis-isaac').style.display = 'block';
                    setTimeout(() => {
                        if(!Game.state.mask) Game.die('isaac');
                        else { AudioSys.stopLoops(); AudioSys.play('sfx-leave'); document.getElementById('vis-isaac').style.display = 'none'; Game.ai.pos.isaac = 0; Game.ai.busy = false; }
                    }, 3500);
                }, 1000);
            }
        }
        
        if(Game.ai.pos.jomar === 0 && rng(Game.ai.jomar)) { Game.ai.busy=true; UI.flicker(); Game.ai.pos.jomar=1; setTimeout(()=>{ if(Game.ai.pos.jomar===1) { document.getElementById('vis-jomar').style.display='block'; AudioSys.play('sfx-jomar', true, 0.3); } }, 500); }
        if(rng(Game.ai.richard) && Game.ai.pos.richard < 1) { Game.ai.pos.richard = 1; document.getElementById('vis-richard-win').style.display='block'; setTimeout(()=>{ if(Game.state.curtain) { AudioSys.play('sfx-leave'); document.getElementById('vis-richard-win').style.display='none'; Game.ai.pos.richard=0; } else { Game.die('richard'); } }, 5000); }
        
        if(Game.ai.pos.vent === 0) {
            if(Math.random() < 0.3) {
                 if(Math.random()>0.5 && Game.ai.pos.maifer<3) { Game.ai.pos.vent='maifer'; document.getElementById('vent-img').src='maifer.png'; document.getElementById('vent-img').style.display='block'; }
                 else if(Game.ai.pos.isaac<3) { Game.ai.pos.vent='isaac'; document.getElementById('vent-img').src='isaac.png'; document.getElementById('vent-img').style.display='block'; }
            }
        } else {
            if(Game.state.vent) { AudioSys.play('sfx-leave'); Game.ai.pos.vent=0; document.getElementById('vent-img').style.display='none'; }
            else if(Math.random()>0.6) Game.die(Game.ai.pos.vent==='maifer'?'maifer':'isaac');
        }
    },
    
    goldenLoop: () => {
        if(Game.state.over || Game.state.frozen || Game.goldenState.active) return;
        let chance = (Game.ai.golden > 0) ? Game.ai.golden * 0.05 : 0.2;
        if(Math.random() < chance) {
            Game.goldenState.active = true; AudioSys.play('sfx-oh');
            Game.goldenState.timer = setTimeout(() => { if(Game.goldenState.active) Game.die('golden'); }, 3000);
        }
    },

    die: (cause) => {
        if(Game.state.over) return;
        Game.state.over = true; AudioSys.stopAll();
        clearInterval(Game.timers.main); clearInterval(Game.timers.ai); if(Game.timers.golden) clearInterval(Game.timers.golden);
        
        document.getElementById('screen-jumpscare').style.display='flex';
        let img = "maifer.png", snd = "jump-maifer";
        if(cause==='isaac') { img="isaac.png"; snd="jump-isaac"; }
        if(cause==='jomar') { img="jomar.png"; snd="jump-jomar"; }
        if(cause==='richard') { img="richard.png"; snd="jump-richard"; }
        if(cause==='golden') { img="golden_maifer.png"; snd="jump-golden"; }
        document.getElementById('jump-img').src = img; AudioSys.play(snd);
        
        setTimeout(() => {
            document.getElementById('screen-jumpscare').style.display='none';
            UI.showScreen('screen-gameover');
            document.getElementById('death-reason').innerText = TEXTS[Lang.current]['d_'+cause] || "GAME OVER";
            AudioSys.play('sfx-gameover');
        }, 2000);
    },

    reach8AM: () => {
        Game.state.over = true; AudioSys.stopAll(); clearInterval(Game.timers.main); clearInterval(Game.timers.ai); if(Game.timers.golden) clearInterval(Game.timers.golden);
        UI.showScreen('screen-8am'); AudioSys.play('sfx-win');
        
        setTimeout(() => {
            if(typeof Game.state.night==='number' && Game.state.night<9) MiniGames.start(Game.state.night);
            else if(Game.state.night===9) { SAVEDATA.night=10; SAVEDATA.stars[9]=true; SaveManager.save(); UI.showScreen('screen-win'); }
            else location.reload();
        }, 4000);
    }
};

const Mechanics = {
    resetVisuals: () => {
        document.getElementById('vent-door').classList.remove('closed');
        document.getElementById('curtain-fabric').classList.remove('closed');
        document.querySelectorAll('.anim-img').forEach(i=>i.style.display='none');
        document.getElementById('vis-richard-win').style.display='none';
        document.getElementById('vent-img').style.display='none';
        document.getElementById('layer-mask').style.display='none';
        document.getElementById('layer-flashlight').style.display='none';
        document.getElementById('layer-under-desk').style.display='none';
        Mechanics.moveGenButton();
    },
    toggleMask: () => {
        if(Game.state.view!=='office') return;
        Game.state.mask = !Game.state.mask;
        document.getElementById('layer-mask').style.display = Game.state.mask ? 'block' : 'none';
        if(Game.state.mask) { AudioSys.play('sfx-mask', true); if(Game.goldenState.active) { clearTimeout(Game.goldenState.timer); Game.goldenState.active=false; AudioSys.stop('sfx-oh'); } }
        else AudioSys.stop('sfx-mask');
    },
    toggleMonitor: () => {
        if(Game.state.over || Game.state.mask || Game.state.hidden) return;
        const m = document.getElementById('screen-monitor');
        Game.state.view = (Game.state.view==='monitor') ? 'office' : 'monitor';
        m.style.display = (Game.state.view==='monitor') ? 'flex' : 'none';
        AudioSys.play('sfx-monitor');
    },
    toggleFlashlight: () => {
        if(Game.state.view!=='office') return;
        Game.state.flash = !Game.state.flash;
        document.getElementById('layer-flashlight').style.display = Game.state.flash ? 'block' : 'none';
        if(Game.state.flash) { AudioSys.play('sfx-flash'); if(Game.ai.pos.jomar===1) { Game.ai.pos.jomar=0; document.getElementById('vis-jomar').style.display='none'; AudioSys.stopLoops(); AudioSys.play('sfx-leave'); Game.ai.busy=false; } }
    },
    toggleHide: () => {
        if(Game.state.view!=='office') return;
        Game.state.hidden = !Game.state.hidden;
        document.getElementById('layer-under-desk').style.display = Game.state.hidden ? 'flex' : 'none';
        if(Game.state.hidden) AudioSys.play('sfx-hide');
    },
    toggleVent: () => {
        if(Game.state.view!=='office') return;
        Game.state.vent = !Game.state.vent;
        document.getElementById('vent-door').classList.toggle('closed', Game.state.vent);
        AudioSys.play('sfx-vent-close');
    },
    toggleCurtain: () => {
        if(Game.state.view!=='office') return;
        Game.state.curtain = !Game.state.curtain;
        document.getElementById('curtain-fabric').classList.toggle('closed', Game.state.curtain);
        AudioSys.play('sfx-curtain');
    },
    muteCall: () => { },
    chargeGen: () => { Game.state.power=Math.min(100, Game.state.power+2); AudioSys.play('sfx-gen'); document.getElementById('gen-btn').style.display='none'; setTimeout(Mechanics.moveGenButton, 3000+Math.random()*5000); },
    moveGenButton: () => { const b=document.getElementById('gen-btn'); b.style.left=Math.random()*90+'px'; b.style.top=Math.random()*140+'px'; b.style.display='block'; }
};

const Monitor = {
    current: 6,
    setCam: (id) => {
        Monitor.current = id;
        document.getElementById('cam-id').innerText = "0"+id;
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-c'+id).classList.add('active');
        AudioSys.play('sfx-cam'); Monitor.update();
    },
    update: () => {
        if(Game.state.view !== 'monitor') return;
        const div = document.getElementById('cam-content'); div.innerHTML = '';
        const c = Monitor.current, p = Game.ai.pos, t = TEXTS[Lang.current];
        let h = '';
        
        const s_idle = `(${t.mon_idle})`;
        const s_det = `(${t.mon_detected})`;
        const s_near = `(${t.mon_near})`;

        if(c===6) { if(p.maifer===0) h+=`<div class="cam-spot">${t.char_maifer} ${s_idle}</div>`; if(p.isaac===0) h+=`<div class="cam-spot">${t.char_isaac} ${s_idle}</div>`; }
        if(c===5 && p.maifer===1) h+=`<div class="cam-spot active-anim">${t.char_maifer} ${s_det}</div>`;
        if(c===4 && p.isaac===1) h+=`<div class="cam-spot active-anim">${t.char_isaac} ${s_det}</div>`;
        if(c===3) { if(p.maifer===2) h+=`<div class="cam-spot active-anim">${t.char_maifer} ${s_det}</div>`; if(p.isaac===2) h+=`<div class="cam-spot active-anim">${t.char_isaac} ${s_det}</div>`; }
        if(c===2) { if(p.maifer===3) h+=`<div class="cam-spot active-anim">${t.char_maifer} ${s_det}</div>`; if(p.isaac===4) h+=`<div class="cam-spot active-anim">${t.char_isaac} ${s_near}</div>`; }
        if(c===1) { if(p.maifer===4) h+=`<div class="cam-spot active-anim">${t.char_maifer} ${s_near}</div>`; if(p.isaac===3) h+=`<div class="cam-spot active-anim">${t.char_isaac} ${s_det}</div>`; }

        if(h==='') h=`<h1 style="color:#333;">${t.no_sig}</h1>`;
        div.innerHTML = h;
    }
};

const UI = {
    showScreen: (id) => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); },
    openLore: () => document.getElementById('modal-lore').style.display='flex',
    openUpdates: () => document.getElementById('modal-updates').style.display='flex',
    openSettings: () => document.getElementById('modal-settings').style.display='flex',
    openLeaderboard: () => { document.getElementById('modal-leaderboard').style.display='flex'; FB.getRank(); },
    openComments: () => { document.getElementById('modal-comments').style.display='flex'; FB.getComm(); },
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'),
    
    checkWarning: () => {
        if(!SAVEDATA.audioWarn) {
            document.getElementById('screen-warning').style.display='flex';
        }
    },
    closeWarning: (dontShow) => {
        document.getElementById('screen-warning').style.display='none';
        if(dontShow) {
            SAVEDATA.audioWarn = true;
            SaveManager.save();
        }
        AudioSys.play('bgm-menu', true);
    },
    flicker: () => { 
        if(Config.glitchEnabled) { const e=document.getElementById('layer-flicker'); e.classList.remove('flickering'); void e.offsetWidth; e.classList.add('flickering'); } 
    }
};

// ============================================================================
// SISTEMA DE CUENTAS (REPARADO - CORRECCI√ìN DE ERROR DB)
// ============================================================================
const UserSys = {
    openAuth: (type) => {
        document.getElementById('modal-auth').style.display = 'flex';
        document.getElementById('auth-title').setAttribute('data-mode', type);
        Lang.apply();
    },
    submit: () => {
        const u = document.getElementById('auth-user').value.trim().toLowerCase();
        const p = document.getElementById('auth-pass').value.trim();
        const mode = document.getElementById('auth-title').getAttribute('data-mode');
        
        if(u.length < 3) return alert("User too short / Usuario muy corto (Min 3)");
        
        const ref = firebase.database().ref(DB_PATH.users + '/' + u.replace('.', '_'));
        
        ref.once('value').then(s => {
            if(mode === 'reg') {
                if(s.exists()) {
                    alert("USER ALREADY EXISTS / USUARIO YA EXISTE");
                } else {
                    ref.set({pass:p, data: SAVEDATA})
                    .then(() => {
                        alert("REGISTERED. PLEASE LOGIN."); 
                        UserSys.openAuth('login');
                    });
                }
            } else {
                if(s.exists()) {
                    if(s.val().pass === p) {
                        // EXITO LOGIN
                        if(s.val().data) SAVEDATA = s.val().data;
                        
                        // CORRECCION CRITICA: Asegurar que SAVEDATA.stars existe
                        if(!SAVEDATA.stars) SAVEDATA.stars = {};
                        
                        SAVEDATA.user = u;
                        SaveManager.save();
                        UserSys.updateUI();
                        UI.closeModals();
                        Game.initMenu();
                        alert("LOGIN SUCCESS / SESION INICIADA");
                    } else {
                        alert("WRONG PASSWORD / CONTRASE√ëA INCORRECTA");
                    }
                } else {
                    alert("USER NOT FOUND / USUARIO NO ENCONTRADO");
                }
            }
        }).catch(err => alert("DB ERROR: " + err.message));
    },
    updateUI: () => {
        if(SAVEDATA.user) {
            document.getElementById('btn-login').style.display='none';
            document.getElementById('btn-reg').style.display='none';
            document.getElementById('user-display').style.display='block';
        }
    }
};

const CustomNight = {
    levels: { maifer:0, isaac:0, jomar:0, richard:0, golden:0 },
    adj: (c,v) => {
        CustomNight.levels[c] = Math.max(0, Math.min(20, CustomNight.levels[c]+v));
        document.getElementById('val-'+c).innerText = CustomNight.levels[c];
    },
    start: () => {
        const l = CustomNight.levels;
        if(l.maifer===20 && l.isaac===20 && l.jomar===20 && l.richard===20) Game.startSequence(9, l);
        else Game.startSequence('CUSTOM', l);
    }
};

const Config = {
    glitchEnabled: true,
    shakeEnabled: true,
    particlesHigh: true,
    sensitivity: 5,
    toggleFullscreen: () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else if(document.exitFullscreen) document.exitFullscreen(); },
    toggleGlitch: () => { Config.glitchEnabled = !Config.glitchEnabled; },
    toggleStatic: (c) => document.getElementById('cam-static').style.display = c ? 'block' : 'none',
    togglePerspective: (c) => document.getElementById('view-office').style.transform = c ? 'perspective(1000px) rotateX(2deg)' : 'none',
    toggleQuality: () => { Config.particlesHigh = !Config.particlesHigh; Lang.apply(); },
    toggleShake: (c) => { Config.shakeEnabled = c; },
    setSens: (v) => { Config.sensitivity = v; }
};

const AudioSys = {
    volume: 1.0,
    setVolume: (v) => { AudioSys.volume = v/100; document.querySelectorAll('audio').forEach(a=>a.volume=AudioSys.volume); },
    play: (id, loop=false, vol=1.0) => { try { const s=document.getElementById(id); if(s) { s.loop=loop; s.volume=vol*AudioSys.volume; s.currentTime=0; s.play().catch(()=>{}); } } catch(e){} },
    stop: (id) => { const s=document.getElementById(id); if(s) { s.pause(); s.currentTime=0; } },
    stopAll: () => document.querySelectorAll('audio').forEach(a=>{a.pause();a.currentTime=0;}),
    stopLoops: () => { AudioSys.stop('sfx-maifer'); AudioSys.stop('sfx-isaac'); AudioSys.stop('sfx-jomar'); }
};

const App = {
    selectMode: (m) => {
        if(m==='MOBILE') document.body.classList.add('mode-mobile');
        else document.body.classList.remove('mode-mobile');
        
        document.querySelector('#screen-device h1').style.display='none';
        document.querySelector('#screen-device div').style.display='none';
        document.getElementById('loading-bar-container').style.display='block';
        
        let p=0; const i=setInterval(()=>{
            p+=2; document.getElementById('loading-bar').style.width=p+'%';
            if(p>=100) { clearInterval(i); UI.showScreen('screen-menu'); Game.initMenu(); UI.checkWarning(); }
        },30);
    }
};

const FB = {
    getRank: () => {
        firebase.database().ref(DB_PATH.rank).limitToLast(10).once('value', s => {
            const l=document.getElementById('lb-list'); l.innerHTML='';
            if(s.exists()) { let a=[]; s.forEach(c=>a.push(c.val())); a.reverse().forEach(p=>{ l.innerHTML += `<li><span style="color:#0f0">${p.n}</span> <span>${p.d}</span></li>`; }); }
        });
    },
    getComm: () => {
        firebase.database().ref(DB_PATH.comm).limitToLast(20).on('value', s => {
            const b=document.getElementById('comment-feed'); b.innerHTML='';
            if(s.exists()) s.forEach(c => { let v=c.val(); b.innerHTML += `<div class="comment-box"><span class="comment-user" style="color:${v.u===SAVEDATA.user?'gold':'#0088ff'}">${v.u}:</span> <span class="comment-msg">${v.t}</span></div>`; });
        });
    }
};

const ModSystem = {
    badWords: ['idiot','stupid','tonto','mierda','puto','fck','shit','ass','bitch','crap','noob','manco','basura','fuck','pene','sex','tonta'],
    requiredContext: ['bug','error','glitch','idea','add','game','juego','noche','night','maifer','isaac','jomar','richard','buen','good','cool','ayuda','help','fix','pantalla','screen','audio','sound'],
    
    check: (txt) => {
        const lower = txt.toLowerCase();
        if(ModSystem.badWords.some(w => lower.includes(w))) return false;
        if(!ModSystem.requiredContext.some(w => lower.includes(w))) return false;
        return true;
    }
};

const CommentSystem = {
    post: () => {
        if(!SAVEDATA.user) return alert(TEXTS[Lang.current].guest_err);
        const t = document.getElementById('comm-input').value;
        if(!t) return;
        
        if(!ModSystem.check(t)) {
            alert("‚ö†Ô∏è SYSTEM: Message Rejected.\nREASON: Insult detected OR Message not related to game feedback (Bugs/Ideas).\nRAZON: Insulto O Mensaje sin relaci√≥n al juego (Bugs/Ideas).");
            return;
        }

        firebase.database().ref(DB_PATH.comm).push({u:SAVEDATA.user, t:t}); 
        document.getElementById('comm-input').value="";
    }
};

const MiniGames = {
    active: false, night: 0, ctx: null, player: {}, enemies: [], target: {}, state: {}, frame: 0,
    start: (n) => { 
        Game.state.inMinigame = true; MiniGames.night = n; MiniGames.active = true; MiniGames.frame = 0; UI.showScreen('screen-minigame'); AudioSys.play('bgm-minigame', true); 
        const c = document.getElementById('mg-canvas'); MiniGames.ctx = c.getContext('2d'); 
        Lang.apply(); 
        MiniGames.initLogic(n); requestAnimationFrame(MiniGames.loop); 
        document.onkeydown = MiniGames.handleInput; c.onmousedown = MiniGames.handleClick; c.onmousemove = MiniGames.handleMove; 
    },
    initLogic: (n) => {
        const w=600; MiniGames.enemies = []; 
        if(n===1) { MiniGames.player = {x:50, y:300, w:30, h:30, duck:false}; MiniGames.enemies = [{x:600, y:280, w:40, h:60, spd:4}]; } 
        else if(n===2) { MiniGames.player = {x:20, y:20, w:20, h:20}; MiniGames.target = {x:550, y:350, w:30, h:30, active:true}; MiniGames.enemies = [{x:150,y:0,h:300,dir:1,spd:2}, {x:300,y:100,h:300,dir:-1,spd:2}, {x:450,y:0,h:300,dir:1,spd:2}]; } 
        else if(n===3) { MiniGames.state = {score:0}; MiniGames.spawnClickTarget(); } 
        else if(n===4) { MiniGames.enemies = []; MiniGames.player = {x:300, y:300, w:10, h:10}; } 
        else if(n===5) { MiniGames.state = {energy: 50, timer: 1000}; } 
        else if(n===6) { MiniGames.state = {timer: Math.random()*200 + 100, color: 'red', waiting: true}; } 
        else if(n===7) { MiniGames.player = {x:20, y:20, w:20, h:20}; MiniGames.target = {x:560, y:360, w:20, h:20}; MiniGames.enemies = [{x:100,y:50,w:20,h:350}, {x:250,y:0,w:20,h:350}, {x:400,y:50,w:20,h:350}]; } 
        else if(n===8) { MiniGames.player = {x:300, y:200, w:20, h:20}; MiniGames.state = {timer: 1800}; }
    },
    spawnClickTarget: () => { MiniGames.enemies.push({x:Math.random()*560+20, y:Math.random()*360+20, r:20, life:60}); },
    loop: () => {
        if(!MiniGames.active) return; const ctx = MiniGames.ctx; const w=600, h=400; ctx.fillStyle = '#111'; ctx.fillRect(0,0,w,h); MiniGames.frame++; const n = MiniGames.night;
        if(n===1) { ctx.fillStyle = MiniGames.player.duck ? '#050' : '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.duck?320:300, 30, MiniGames.player.duck?15:30); MiniGames.enemies.forEach(e => { e.x -= e.spd; ctx.fillStyle = '#f00'; ctx.fillRect(e.x, e.y, e.w, e.h); if(e.x < -50) { e.x = 650; e.spd = 4+Math.random()*3; } if(MiniGames.col(MiniGames.player, e) && !MiniGames.player.duck) MiniGames.lose(); }); if(MiniGames.frame > 900) MiniGames.win(); } 
        else if(n===2) { ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20); ctx.fillStyle = '#00f'; ctx.fillRect(MiniGames.target.x, MiniGames.target.y, 30, 30); MiniGames.enemies.forEach(e => { e.y += e.dir * e.spd; if(e.y < 0 || e.y > 100) e.dir *= -1; ctx.fillStyle = '#555'; ctx.fillRect(e.x, e.y, 20, e.h); if(MiniGames.col(MiniGames.player, {x:e.x, y:e.y, w:20, h:e.h})) MiniGames.lose(); }); if(MiniGames.col(MiniGames.player, MiniGames.target)) MiniGames.win(); } 
        else if(n===3) { ctx.fillStyle = '#fff'; ctx.fillText(MiniGames.state.score+"/10", 20, 30); MiniGames.enemies.forEach((e,i) => { e.life--; ctx.fillStyle='#0f0'; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,6.28); ctx.fill(); if(e.life<=0) { MiniGames.enemies.splice(i,1); MiniGames.spawnClickTarget(); } }); if(MiniGames.state.score >= 10) MiniGames.win(); } 
        else if(n===4) { ctx.fillStyle = '#0f0'; ctx.beginPath(); ctx.arc(MiniGames.player.x, MiniGames.player.y, 10, 0, 6.28); ctx.fill(); if(MiniGames.frame % 10 === 0) { MiniGames.enemies.push({x:Math.random()*w, y:-20, w:20, h:20, vy:3+Math.random()*2}); } MiniGames.enemies.forEach(e => { e.y += e.vy; ctx.fillStyle='red'; ctx.fillRect(e.x, e.y, e.w, e.h); if(Math.abs(e.x - MiniGames.player.x) < 15 && Math.abs(e.y - MiniGames.player.y) < 15) MiniGames.lose(); }); if(MiniGames.frame > 1000) MiniGames.win(); } 
        else if(n===5) { MiniGames.state.energy -= 0.5; MiniGames.state.timer--; ctx.fillStyle = '#333'; ctx.fillRect(150, 200, 300, 30); ctx.fillStyle = MiniGames.state.energy > 20 ? '#0f0' : '#f00'; ctx.fillRect(150, 200, (MiniGames.state.energy/100)*300, 30); if(MiniGames.state.energy <= 0) MiniGames.lose(); if(MiniGames.state.timer <= 0) MiniGames.win(); } 
        else if(n===6) { if(MiniGames.state.waiting) { MiniGames.state.timer--; ctx.fillStyle = 'red'; ctx.fillRect(200,100,200,200); if(MiniGames.state.timer <= 0) { MiniGames.state.waiting = false; MiniGames.state.color = 'green'; MiniGames.state.timer = 60; } } else { ctx.fillStyle = 'green'; ctx.fillRect(200,100,200,200); MiniGames.state.timer--; if(MiniGames.state.timer <= 0) MiniGames.lose(); } } 
        else if(n===7) { ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20); ctx.fillStyle = 'gold'; ctx.fillRect(MiniGames.target.x, MiniGames.target.y, 20, 20); MiniGames.enemies.forEach(e => { ctx.fillStyle = '#555'; ctx.fillRect(e.x, e.y, e.w, e.h); if(MiniGames.col(MiniGames.player, e)) MiniGames.player = {x:20, y:20, w:20, h:20}; }); if(MiniGames.col(MiniGames.player, MiniGames.target)) MiniGames.win(); } 
        else if(n===8) { ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20); if(MiniGames.frame % 5 === 0) { let side = Math.floor(Math.random()*4); let e = {w:10,h:10}; if(side===0) { e.x=Math.random()*600; e.y=0; e.vx=(Math.random()-0.5)*2; e.vy=3; } if(side===1) { e.x=Math.random()*600; e.y=400; e.vx=(Math.random()-0.5)*2; e.vy=-3; } if(side===2) { e.x=0; e.y=Math.random()*400; e.vx=3; e.vy=(Math.random()-0.5)*2; } if(side===3) { e.x=600; e.y=Math.random()*400; e.vx=-3; e.vy=(Math.random()-0.5)*2; } MiniGames.enemies.push(e); } MiniGames.enemies.forEach(e => { e.x+=e.vx; e.y+=e.vy; ctx.fillStyle='red'; ctx.fillRect(e.x,e.y,e.w,e.h); if(MiniGames.col(MiniGames.player,e)) MiniGames.lose(); }); if(MiniGames.frame > 1200) MiniGames.win(); }
        requestAnimationFrame(MiniGames.loop);
    },
    col: (r1,r2) => (r1.x < r2.x+r2.w && r1.x+r1.w > r2.x && r1.y < r2.y+r2.h && r1.y+r1.h > r2.y),
    handleInput: (e) => { if(!MiniGames.active) return; const k=e.code, p=MiniGames.player; if([1,2,7,8].includes(MiniGames.night)) { if(k==='ArrowLeft') p.x-=15; if(k==='ArrowRight') p.x+=15; if(MiniGames.night !== 1) { if(k==='ArrowUp') p.y-=15; if(k==='ArrowDown') p.y+=15; } else { if(k==='ArrowDown') p.duck=true; if(k==='ArrowUp') p.duck=false; } } if(MiniGames.night === 5 && k==='Space') { MiniGames.state.energy = Math.min(100, MiniGames.state.energy + 8); } },
    handleMove: (e) => { if(MiniGames.night === 4) { const r = document.getElementById('mg-canvas').getBoundingClientRect(); MiniGames.player.x = e.clientX - r.left; MiniGames.player.y = e.clientY - r.top; } },
    handleClick: (e) => { if(MiniGames.night===3) { const r = document.getElementById('mg-canvas').getBoundingClientRect(); const mx = e.clientX-r.left, my = e.clientY-r.top; MiniGames.enemies.forEach((t,i) => { if(Math.sqrt((mx-t.x)**2+(my-t.y)**2) < t.r) { MiniGames.state.score++; MiniGames.enemies.splice(i,1); MiniGames.spawnClickTarget(); } }); } if(MiniGames.night===6) { if(!MiniGames.state.waiting) MiniGames.win(); else MiniGames.lose(); } },
    win: () => { 
        MiniGames.active=false; AudioSys.stop('bgm-minigame'); const n = MiniGames.night; SAVEDATA.night = parseInt(n)+1; SAVEDATA.stars[n]=true; 
        SaveManager.save(); // GUARDADO FORZADO
        alert("COMPLETED! PROGRESS SAVED."); location.reload(); 
    },
    lose: () => { MiniGames.active=false; AudioSys.stop('bgm-minigame'); alert("FAIL."); location.reload(); }
};

const Input={rebind:(a)=>{const b=document.getElementById('bind-'+a);b.innerText="...";const h=(e)=>{e.preventDefault();SAVEDATA.binds=SAVEDATA.binds||{};SAVEDATA.binds[a]=e.code;b.innerText=e.code;SaveManager.save();document.removeEventListener('keydown',h);};document.addEventListener('keydown',h);}};
const BINDINGS={mask:'Space',flash:'KeyF',hide:'ControlLeft',curtain:'KeyS',monitor:'Tab',vent:'KeyV'};
document.addEventListener('keydown', (e) => {
    if(Game.state.over||UI.modalOpen||Game.state.inMinigame) return;
    const b = SAVEDATA.binds || BINDINGS, k=e.code;
    if(k===b.mask) Mechanics.toggleMask(); if(k===b.flash) Mechanics.toggleFlashlight();
    if(k===b.hide) Mechanics.toggleHide(); if(k===b.curtain) Mechanics.toggleCurtain();
    if(k===b.monitor) Mechanics.toggleMonitor(); if(k===b.vent) Mechanics.toggleVent();
});

let cheatCode = [];
document.addEventListener('keydown', (e) => {
    if(e.target.tagName === 'INPUT') return;
    cheatCode.push(e.key.toLowerCase());
    if(cheatCode.length > 20) cheatCode.shift();
    const str = cheatCode.join('');
    
    // CREATOR CHEAT CODE: boyfriendisthebest
    if(str.includes("boyfriendisthebest")) {
        cheatCode = [];
        AudioSys.play('sfx-win');
        alert("CREATOR MODE ACTIVATED: UNLOCKING EVERYTHING (TEMPORARY)");
        
        // Modificar solo RAM (No guarda en DB para no arruinar la cuenta real)
        SAVEDATA.night = 9;
        SAVEDATA.stars = {1:true, 2:true, 3:true, 4:true, 5:true, 6:true, 7:true, 8:true, 9:true, 'custom':true};
        
        Game.initMenu(); // Refrescar UI
    }
});

</script>
<script>
<!-- ==========================================================================
     NUEVO SISTEMA: ALUCINACIONES (EXPANSION v48)
     ========================================================================== -->

<!-- CAPA VISUAL DE ALUCINACIONES -->
<div id="layer-hallucination" style="position:fixed; inset:0; pointer-events:none; z-index:85; display:none; overflow:hidden; mix-blend-mode: exclusion;">
    <img id="hal-img" src="" style="width:100%; height:100%; object-fit:cover; opacity:0.6; filter: invert(1) contrast(2);">
    <h1 id="hal-text" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:red; font-family:'Nosifer'; font-size:5rem; text-shadow:0 0 20px white; display:none;">IT'S ME</h1>
</div>

<style>
    /* Efectos CSS para las alucinaciones */
    @keyframes hal-shake { 0% { transform: translate(0,0) scale(1); } 25% { transform: translate(-10px, 10px) scale(1.1); } 50% { transform: translate(10px, -10px) scale(1.2) rotate(5deg); } 75% { transform: translate(-5px, 5px) scale(1.1) rotate(-5deg); } 100% { transform: translate(0,0) scale(1); } }
    .hallucination-active { animation: hal-shake 0.2s infinite; background-color: rgba(50, 0, 0, 0.3); }
    .hal-glitch-text { animation: glitch 0.2s infinite; }
</style>

<script>
/**
 * SANITY SYSTEM (SISTEMA DE CORDURA)
 * Se ejecuta en paralelo al juego principal.
 * No modifica variables del n√∫cleo, solo lee estados.
 */
const SanitySys = {
    timer: null,
    active: false,
    hallucinations: [
        { type: 'img', src: 'maifer.png', duration: 200 },
        { type: 'img', src: 'richard.png', duration: 150 },
        { type: 'img', src: 'screen_death.png', duration: 300 }, // Usa assets existentes
        { type: 'text', txt: "IT'S ME", duration: 500 },
        { type: 'text', txt: "RUN", duration: 500 },
        { type: 'text', txt: "NO AIR", duration: 800 },
        { type: 'sound', id: 'sfx-mask', duration: 1000 } // Sonido fantasma
    ],

    // Inicia el monitoreo
    init: () => {
        console.log("Sanity System Loaded (v48 expansion)");
        if (SanitySys.timer) clearInterval(SanitySys.timer);
        SanitySys.timer = setInterval(SanitySys.check, 2000); // Revisa cada 2 segundos
    },

    check: () => {
        // Solo actuar si el juego est√° activo y no en game over
        const gameScreen = document.getElementById('screen-game');
        if (!gameScreen.classList.contains('active')) return;
        if (typeof Game === 'undefined' || !Game.state || Game.state.over || Game.state.frozen) return;

        let risk = 0;

        // Factor 1: Toxicidad alta (Falta de ox√≠geno causa alucinaciones)
        if (Game.state.toxic > 50) risk += 10;
        if (Game.state.toxic > 80) risk += 30;

        // Factor 2: Bater√≠a baja (P√°nico)
        if (Game.state.power < 20) risk += 10;
        if (Game.state.power < 5) risk += 40;

        // Factor 3: Noche avanzada
        if (Game.state.night > 3) risk += 5;
        if (Game.state.night > 6) risk += 10;

        // C√°lculo de probabilidad (0 a 100)
        const roll = Math.random() * 100;

        if (roll < risk) {
            SanitySys.trigger();
        }
    },

    trigger: () => {
        if (SanitySys.active) return; // Evitar solapamiento
        SanitySys.active = true;

        const layer = document.getElementById('layer-hallucination');
        const img = document.getElementById('hal-img');
        const txt = document.getElementById('hal-text');
        
        // Seleccionar alucinaci√≥n aleatoria
        const hal = SanitySys.hallucinations[Math.floor(Math.random() * SanitySys.hallucinations.length)];

        layer.style.display = 'block';
        document.body.classList.add('hallucination-active'); // Efecto de temblor global

        // Reset visuales
        img.style.display = 'none';
        txt.style.display = 'none';

        if (hal.type === 'img') {
            img.src = hal.src;
            img.style.display = 'block';
            // Efectos aleatorios de filtro para que se vea diferente al asset normal
            const hue = Math.floor(Math.random() * 360);
            img.style.filter = `invert(1) hue-rotate(${hue}deg) contrast(1.5)`;
        } 
        else if (hal.type === 'text') {
            txt.innerText = hal.txt;
            txt.style.display = 'block';
            txt.classList.add('hal-glitch-text');
        }
        else if (hal.type === 'sound') {
            // Reproduce un sonido fantasma a bajo volumen
            if(typeof AudioSys !== 'undefined') AudioSys.play(hal.id, false, 0.4);
            layer.style.display = 'none'; // Si es solo sonido, ocultar capa visual
        }

        // Apagar alucinaci√≥n despu√©s de la duraci√≥n
        setTimeout(() => {
            layer.style.display = 'none';
            document.body.classList.remove('hallucination-active');
            txt.classList.remove('hal-glitch-text');
            SanitySys.active = false;
        }, hal.duration);
    }
};

// Iniciar el sistema autom√°ticamente
SanitySys.init();

</script>
--- START OF EXPANSION CODE ---
<!-- ==========================================================================
EXPANSION PACK v48.0: SYSTEMS, AGGRO & SECRETS
Autor: Asistente (Bajo tus reglas estrictas)
Contenido: Audio Lure, Mantenimiento, IA Progresiva, Secretos, Presets CN.
========================================================================== -->
<!-- 1. NUEVOS ELEMENTOS VISUALES (HTML INYECTADO) -->
<div id="expansion-ui-layer" style="position: absolute; inset: 0; pointer-events: none; z-index: 9999;">
code
Code
<!-- PANEL DE MANTENIMIENTO (SISTEMA 2) -->
<div id="panel-maint" style="position: absolute; top: 10%; right: 10%; width: 300px; height: 400px; background: #111; border: 4px solid #555; display: none; pointer-events: auto; flex-direction: column; padding: 10px; font-family: 'VT323'; color: #fff;">
    <h2 style="text-align: center; color: #fff; border-bottom: 2px solid #fff;">MAINTENANCE PANEL</h2>
    
    <div class="sys-status-row" id="st-row-vid" style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
        <span>VIDEO SYSTEM:</span>
        <span id="st-val-vid" style="color: #0f0;">ONLINE</span>
    </div>
    
    <div class="sys-status-row" id="st-row-vent" style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
        <span>VENTILATION:</span>
        <span id="st-val-vent" style="color: #0f0;">ONLINE</span>
    </div>
    
    <div class="sys-status-row" id="st-row-aud" style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
        <span>AUDIO DEVICES:</span>
        <span id="st-val-aud" style="color: #0f0;">ONLINE</span>
    </div>

    <button id="btn-reboot-all" class="menu-btn" style="margin-top: auto; border-color: orange; color: orange;" onclick="ExpansionSys.rebootSystem()">REBOOT ALL SYSTEMS (5s)</button>
    <button class="menu-btn" style="height: 40px; font-size: 1rem;" onclick="document.getElementById('panel-maint').style.display='none'">CLOSE PANEL</button>
</div>

<!-- BOT√ìN DE MANTENIMIENTO EN OFICINA -->
<button id="btn-open-maint" style="position: absolute; bottom: 25%; left: 5%; width: 100px; height: 50px; background: #222; border: 2px solid #555; color: #aaa; font-family: 'Share Tech Mono'; cursor: pointer; pointer-events: auto; display: none;" onclick="document.getElementById('panel-maint').style.display='flex'">
    REBOOT<br>SYSTEM
</button>

<!-- ALERTAS DE ERROR -->
<div id="alert-overlay" style="position: absolute; top: 100px; left: 20px; color: red; font-family: 'VT323'; font-size: 2rem; display: none; animation: blink 0.5s infinite;">‚ö† SYSTEM ERROR</div>

<!-- CAPA DE EASTER EGGS (SISTEMA 4) -->
<div id="layer-secret" style="position: fixed; inset: 0; background: black; z-index: 10000; display: none; align-items: center; justify-content: center; pointer-events: none;">
    <img id="secret-img" src="" style="width: 80%; height: 80%; object-fit: contain; filter: contrast(1.5) grayscale(1);">
</div>
</div>
<style>
/* Estilos adicionales para la expansi√≥n */
.sys-error { color: red !important; animation: glitch 0.5s infinite; }
.sys-rebooting { color: yellow !important; }

#btn-audio-lure {
position: absolute; top: 10px; left: 10px;
width: 150px; height: 40px;
background: #000; border: 2px solid #00aaff; color: #00aaff;
font-family: 'Share Tech Mono'; cursor: pointer; z-index: 500;
display: none; /* Se activa con JS */
}
#btn-audio-lure:active { background: #0044aa; color: #fff; }
#btn-audio-lure.disabled { opacity: 0.5; border-color: #555; color: #555; cursor: not-allowed; }

/* Contenedor de Presets en Custom Night */
#cn-presets {
width: 100%; max-width: 900px; margin: 20px auto;
display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
}
.preset-btn {
background: #220022; border: 1px solid #d0d; color: #d0d;
padding: 5px 15px; font-family: 'VT323'; font-size: 1.2rem; cursor: pointer;
}
.preset-btn:hover { background: #440044; color: #fff; }

@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
</style>
<!-- 2. L√ìGICA DE LA EXPANSI√ìN (JAVASCRIPT) -->
<script>
// ============================================================================
// EXPANSION CORE - v48.0
// Conecta los nuevos sistemas sin borrar los antiguos.
// ============================================================================

const ExpansionSys = {
// Estado interno de la expansi√≥n
data: {
audioCooldown: 0,
errors: { video: false, vent: false, audio: false },
rebooting: false,
aggroLevel: 0,
monitorInitialized: false,
customUIInitialized: false
},

// Iniciar (Se llama autom√°ticamente al cargar la noche)
init: (nightNum) => {
console.log("Expansion v48 Loaded: Systems Online");
ExpansionSys.data = { audioCooldown: 0, errors: { video: false, vent: false, audio: false }, rebooting: false, aggroLevel: 0, monitorInitialized: false, customUIInitialized: false };

// Mostrar bot√≥n de mantenimiento
document.getElementById('btn-open-maint').style.display = 'block';
document.getElementById('panel-maint').style.display = 'none';

// Iniciar loops paralelos
if(ExpansionSys.timers) { clearInterval(ExpansionSys.timers.maint); clearInterval(ExpansionSys.timers.aggro); }
ExpansionSys.timers = {};

// Loop de Mantenimiento (Cada 10s chequea fallos)
ExpansionSys.timers.maint = setInterval(MaintenanceSys.loop, 10000);

// Loop de Aggro (Cada 5s ajusta dificultad)
ExpansionSys.timers.aggro = setInterval(AggroSys.check, 5000);

// Inyectar bot√≥n de Audio en el Monitor si no existe
MaintenanceSys.injectAudioBtn();

// Chequear secreto de inicio
SecretSys.roll(0.01); // 1% chance al iniciar noche
},

rebootSystem: () => {
if(ExpansionSys.data.rebooting) return;
ExpansionSys.data.rebooting = true;

const btn = document.getElementById('btn-reboot-all');
const originalText = btn.innerText;
btn.innerText = "REBOOTING... (5)";

let count = 5;
const countdown = setInterval(() => {
count--;
btn.innerText = `REBOOTING... (${count})`;
if(count <= 0) {
clearInterval(countdown);
ExpansionSys.resolveReboot(btn, originalText);
}
}, 1000);
},

resolveReboot: (btn, txt) => {
ExpansionSys.data.rebooting = false;
ExpansionSys.data.errors = { video: false, vent: false, audio: false };
btn.innerText = txt;

// Restaurar visuales
document.getElementById('st-val-vid').innerText = "ONLINE"; document.getElementById('st-val-vid').className = "";
document.getElementById('st-val-vent').innerText = "ONLINE"; document.getElementById('st-val-vent').className = "";
document.getElementById('st-val-aud').innerText = "ONLINE"; document.getElementById('st-val-aud').className = "";
document.getElementById('alert-overlay').style.display = 'none';

// Restaurar efectos del juego base
document.getElementById('cam-static').style.opacity = "0.15"; // Normal
if(Config.toggleStatic) Config.toggleStatic(true); // Asegurar est√°tica normal

alert("SYSTEMS ONLINE.");
}
};

// ============================================================================
// 1. SYSTEM: AUDIO LURE (SE√ëUELO DE AUDIO)
// ============================================================================
const AudioLure = {
play: () => {
// Verificar errores
if(ExpansionSys.data.errors.audio) { AudioSys.play('sfx-oh'); return; }
if(ExpansionSys.data.rebooting) return;

// Verificar cooldown
if(ExpansionSys.data.audioCooldown > 0) return;

// Reproducir sonido (Simulado usando uno existente o gen√©rico)
AudioSys.play('sfx-night-start'); // Usamos este como placeholder de "Audio de ni√±o"

// L√≥gica de atracci√≥n
const cam = Monitor.current;
const roll = Math.random();

// Intentar mover a Maifer o Isaac
if(roll > 0.4) {
// Si Maifer est√° avanzado, lo retrocedemos
if(Game.ai.pos.maifer > 0 && Game.ai.pos.maifer < 5) {
Game.ai.pos.maifer--;
console.log("Audio Lure: Maifer moved back.");
}
} else {
if(Game.ai.pos.isaac > 0 && Game.ai.pos.isaac < 5) {
Game.ai.pos.isaac--;
console.log("Audio Lure: Isaac moved back.");
}
}

// Activar cooldown visual
ExpansionSys.data.audioCooldown = 100; // Ciclos (aprox 5 segs)
const btn = document.getElementById('btn-audio-lure');
if(btn) {
btn.classList.add('disabled');
btn.innerText = "RECHARGING...";

// Loop para restaurar bot√≥n
const cdInt = setInterval(() => {
ExpansionSys.data.audioCooldown -= 10;
if(ExpansionSys.data.audioCooldown <= 0) {
clearInterval(cdInt);
btn.classList.remove('disabled');
btn.innerText = "PLAY AUDIO";
}
}, 500);
}
}
};

// ============================================================================
// 2. SYSTEM: MAINTENANCE (FALLOS)
// ============================================================================
const MaintenanceSys = {
injectAudioBtn: () => {
// Inyecta el bot√≥n de audio dentro del monitor si no existe
const mon = document.getElementById('screen-monitor');
if(!document.getElementById('btn-audio-lure')) {
const btn = document.createElement('button');
btn.id = 'btn-audio-lure';
btn.innerText = "PLAY AUDIO";
btn.onclick = AudioLure.play;
mon.appendChild(btn);
}
// Asegurarse de que se vea cuando el monitor se abre
const originalToggle = Mechanics.toggleMonitor;
Mechanics.toggleMonitor = function() {
originalToggle();
const btn = document.getElementById('btn-audio-lure');
if(Game.state.view === 'monitor') {
btn.style.display = 'block';
} else {
btn.style.display = 'none';
}
};
},

loop: () => {
if(Game.state.over || Game.state.frozen || ExpansionSys.data.rebooting) return;

// 15% probabilidad de fallo cada 10s
if(Math.random() < 0.15) {
const type = Math.random() > 0.5 ? 'video' : 'vent';
MaintenanceSys.triggerError(type);
}
},

triggerError: (type) => {
if(ExpansionSys.data.errors[type]) return; // Ya est√° roto

ExpansionSys.data.errors[type] = true;
document.getElementById('alert-overlay').style.display = 'block';
AudioSys.play('sfx-oh'); // Sonido de error

// Actualizar UI del panel
const el = document.getElementById('st-val-' + type);
el.innerText = "ERROR";
el.className = "sys-error";

// Efectos del fallo
if(type === 'video') {
// Pone la c√°mara llena de est√°tica
document.getElementById('cam-static').style.opacity = "0.9";
document.getElementById('cam-static').style.display = "block";
}

// NOTA: El fallo de ventilaci√≥n se maneja en el AggroSys hook o GameLoop hook
}
};

// ============================================================================
// 3. SYSTEM: PROGRESSIVE AGGRO (IA DIN√ÅMICA)
// ============================================================================
const AggroSys = {
check: () => {
if(Game.state.over) return;

// Si hay error de ventilaci√≥n, sube la toxicidad autom√°ticamente
if(ExpansionSys.data.errors.vent) {
Game.state.toxic += 5;
document.getElementById('hud-toxic').style.display='block';
if(Game.state.toxic > 100) Game.die('air');
}

// Si el jugador est√° muy pasivo (no usa c√°maras ni linterna), subir Aggro
// Esto hace que los animatr√≥nicos se muevan m√°s r√°pido simulando aburrimiento
if(Game.state.view === 'office' && !Game.state.flash && !Game.state.mask) {
ExpansionSys.data.aggroLevel++;
} else {
ExpansionSys.data.aggroLevel = Math.max(0, ExpansionSys.data.aggroLevel - 1);
}

// Si el Aggro es alto (mayor a 3), forzar un movimiento extra de la IA
if(ExpansionSys.data.aggroLevel > 3) {
console.log("Aggro High: Forcing AI Tick");
// Llamamos a la funci√≥n aiLoop original manualmente para simular doble velocidad
Game.aiLoop();
ExpansionSys.data.aggroLevel = 0; // Reset parcial
}
}
};

// ============================================================================
// 4. SYSTEM: SECRETS & EASTER EGGS
// ============================================================================
const SecretSys = {
images: [
"golden_maifer.png",
"screen_death.png",
"richard.png" // Usamos assets existentes para no pedir nuevos
],

roll: (chance) => {
if(Math.random() < chance) {
SecretSys.trigger();
}
},

trigger: () => {
const layer = document.getElementById('layer-secret');
const img = document.getElementById('secret-img');
const src = SecretSys.images[Math.floor(Math.random() * SecretSys.images.length)];

img.src = src;
layer.style.display = 'flex';
AudioSys.play('sfx-oh'); // Sonido sorpresa

// Durar muy poco (0.2s)
setTimeout(() => {
layer.style.display = 'none';
}, 200);
}
};

// Hookear Secretos a eventos existentes
// 1. Al bajar el monitor
const _origMonToggle = Mechanics.toggleMonitor;
Mechanics.toggleMonitor = function() {
_origMonToggle();
if(Game.state.view === 'office') { // Al bajarlo
SecretSys.roll(0.005); // 0.5% chance
}
};

// ============================================================================
// 5. SYSTEM: CUSTOM NIGHT PRESETS (DESAF√çOS)
// ============================================================================
const Challenges = {
initUI: () => {
if(ExpansionSys.data.customUIInitialized) return;

const container = document.querySelector('.cn-grid');
// Insertar botones de presets debajo de la grid
const presetDiv = document.createElement('div');
presetDiv.id = 'cn-presets';
presetDiv.innerHTML = `
<button class="preset-btn" onclick="Challenges.set([20,20,20,20,0])">20/20/20/20</button>
<button class="preset-btn" onclick="Challenges.set([10,10,10,10,0])">NEW & SHINY</button>
<button class="preset-btn" onclick="Challenges.set([0,20,0,5,0])">MASQUERADE</button>
<button class="preset-btn" onclick="Challenges.set([5,0,20,0,0])">CREEPY CRAWLIES</button>
<button class="preset-btn" onclick="Challenges.set([20,20,20,20,20])">HELL MODE</button>
`;

// Insertar despu√©s de la grid, antes del bot√≥n start
const screen = document.getElementById('screen-custom');
screen.insertBefore(presetDiv, document.getElementById('btn-cn-start'));

ExpansionSys.data.customUIInitialized = true;
},

set: (arr) => {
// [maifer, isaac, jomar, richard, golden]
CustomNight.levels.maifer = arr[0]; document.getElementById('val-maifer').innerText = arr[0];
CustomNight.levels.isaac = arr[1]; document.getElementById('val-isaac').innerText = arr[1];
CustomNight.levels.jomar = arr[2]; document.getElementById('val-jomar').innerText = arr[2];
CustomNight.levels.richard = arr[3]; document.getElementById('val-richard').innerText = arr[3];
CustomNight.levels.golden = arr[4]; document.getElementById('val-golden').innerText = arr[4];
AudioSys.play('sfx-cam');
}
};

// HOOK PRINCIPAL DEL JUEGO
// Interceptamos Game.startLevel para iniciar nuestros sistemas
const _originalStartLevel = Game.startLevel;
Game.startLevel = function(n, customAI) {
// 1. Ejecutar c√≥digo original
_originalStartLevel(n, customAI);

// 2. Iniciar expansi√≥n
ExpansionSys.init(n);
};

// Interceptamos Game.initCustomSetup para inyectar UI
const _originalCustomSetup = Game.initCustomSetup;
Game.initCustomSetup = function() {
_originalCustomSetup();
Challenges.initUI();
};

console.log("Expansion Scripts Ready.");
</script>
--- END OF EXPANSION CODE ---
--- START OF EXPANSION v49 CODE ---
<!-- ==========================================================================
EXPANSION PACK v49.0: ULTIMATE COLLECTION
Contenido: Tienda (Decor), Extras, Cheats, Subt√≠tulos.
========================================================================== -->
<!-- UI NUEVA INYECTADA -->
<div id="v49-ui-layer" style="position: absolute; inset: 0; pointer-events: none; z-index: 9995;">
code
Code
<!-- TIENDA (SHOP) -->
<div id="screen-shop" class="modal-overlay" style="pointer-events: auto;">
    <div class="modal-box" style="text-align: center;">
        <h2 class="lore-header" style="color: gold;">PRIZE CORNER (TIENDA)</h2>
        <p style="font-family: 'VT323'; font-size: 1.5rem;">TUS ESTRELLAS: <span id="shop-stars" style="color: gold;">0</span> ‚òÖ</p>
        <div id="shop-grid" style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
            <!-- Items generados por JS -->
        </div>
        <button class="menu-btn" onclick="document.getElementById('screen-shop').style.display='none'">CERRAR</button>
    </div>
</div>

<!-- EXTRAS MENU -->
<div id="screen-extras" class="modal-overlay" style="pointer-events: auto;">
    <div class="modal-box" style="width: 95%; height: 95%; max-width: 1000px; display: flex; flex-direction: column;">
        <h2 class="lore-header" style="color: #00aaff;">EXTRAS</h2>
        <div style="flex: 1; display: flex; gap: 10px;">
            <div style="width: 30%; border-right: 1px solid #333; display: flex; flex-direction: column; gap: 10px;">
                <button class="menu-btn" onclick="ExtrasSys.show('anim')">ANIMATRONICS</button>
                <button class="menu-btn" onclick="ExtrasSys.show('jump')">JUMPSCARES</button>
                <button class="menu-btn" onclick="document.getElementById('screen-extras').style.display='none'" style="margin-top: auto; border-color: red;">VOLVER</button>
            </div>
            <div id="extras-viewer" style="flex: 1; background: #050505; display: flex; align-items: center; justify-content: center; flex-direction: column; position: relative;">
                <h3 id="ex-name" style="font-family: 'Nosifer'; color: #fff; margin-bottom: 20px;">SELECCIONA UNA OPCION</h3>
                <img id="ex-img" src="" style="max-height: 60vh; max-width: 90%; display: none;">
                <div id="ex-controls" style="display: none; gap: 20px;">
                    <button class="menu-btn" onclick="ExtrasSys.prev()">&lt;</button>
                    <button class="menu-btn" onclick="ExtrasSys.next()">&gt;</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CHEATS MENU -->
<div id="screen-cheats" class="modal-overlay" style="pointer-events: auto;">
    <div class="modal-box" style="text-align: center; border-color: #ff00ff;">
        <h2 class="lore-header" style="color: #ff00ff;">CHEATS / TRUCOS</h2>
        <div class="setting-row"><span style="color: #ff00ff;">RADAR MAPA</span><input type="checkbox" id="chk-radar" onchange="CheatsSys.toggle('radar')"></div>
        <div class="setting-row"><span style="color: #ff00ff;">ENERGIA INFINITA</span><input type="checkbox" id="chk-power" onchange="CheatsSys.toggle('infPower')"></div>
        <div class="setting-row"><span style="color: #ff00ff;">NOCHE RAPIDA (FAST NIGHT)</span><input type="checkbox" id="chk-fast" onchange="CheatsSys.toggle('fastNight')"></div>
        <div class="setting-row"><span style="color: #ff00ff;">NO TOXICIDAD</span><input type="checkbox" id="chk-notox" onchange="CheatsSys.toggle('noTox')"></div>
        <p style="color: #555; font-size: 0.8rem;">* Usar trucos desactiva ganar estrellas nuevas.</p>
        <button class="menu-btn" onclick="document.getElementById('screen-cheats').style.display='none'">CERRAR</button>
    </div>
</div>

<!-- SUBT√çTULOS -->
<div id="subtitle-box" style="position: absolute; top: 10%; width: 100%; text-align: center; pointer-events: none; display: none; text-shadow: 2px 2px 0 #000;">
    <span id="sub-text" style="background: rgba(0,0,0,0.7); color: #ffff00; padding: 5px 15px; font-family: 'VT323'; font-size: 1.5rem; border: 1px solid #555;">...</span>
</div>
</div>
<!-- ELEMENTOS EN EL JUEGO (PLUSHIES) -->
<style>
.plushie {
position: absolute; bottom: 15vh; width: 8vh; height: auto;
z-index: 29; filter: brightness(0.8); pointer-events: auto;
transition: transform 0.1s;
}
.plushie:hover { transform: scale(1.1) rotate(5deg); cursor: pointer; }
/* Radar dots */
.radar-dot {
position: absolute; width: 10px; height: 10px; border-radius: 50%;
background-color: #ff00ff; box-shadow: 0 0 5px #ff00ff;
z-index: 20; pointer-events: none; display: none;
}
</style>
<script>
// ============================================================================
// EXPANSION v49.0 - LOGIC
// ============================================================================

const Exp49 = {
init: () => {
// Inicializar datos si no existen
if(!SAVEDATA.shop) SAVEDATA.shop = { bought: [], equipped: [] };
if(!SAVEDATA.cheats) SAVEDATA.cheats = { radar: false, infPower: false, fastNight: false, noTox: false };

// Inyectar botones en el men√∫ principal
Exp49.injectMenuButtons();

// Aplicar estado de cheats visual
document.getElementById('chk-radar').checked = SAVEDATA.cheats.radar;
document.getElementById('chk-power').checked = SAVEDATA.cheats.infPower;
document.getElementById('chk-fast').checked = SAVEDATA.cheats.fastNight;
document.getElementById('chk-notox').checked = SAVEDATA.cheats.noTox;

console.log("Exp49 Loaded: Shop, Extras, Cheats, Subs");
},

injectMenuButtons: () => {
const container = document.querySelector('.menu-container');
if(!document.getElementById('btn-shop')) {
// Bot√≥n Shop
const btnShop = document.createElement('button');
btnShop.id = 'btn-shop'; btnShop.className = 'menu-btn'; btnShop.innerText = "TIENDA üéÅ";
btnShop.onclick = ShopSys.open;
container.appendChild(btnShop);

// Bot√≥n Extras (Solo si Noche > 5)
if(SAVEDATA.night > 5 || SAVEDATA.night === 'CUSTOM' || SAVEDATA.stars[9]) {
const btnExtras = document.createElement('button');
btnExtras.id = 'btn-extras'; btnExtras.className = 'menu-btn'; btnExtras.innerText = "EXTRAS ‚òÖ";
btnExtras.onclick = ExtrasSys.open;
container.appendChild(btnExtras);
}

// Bot√≥n Cheats (Solo si Noche > 8, es decir, juego pasado)
if(SAVEDATA.night > 8 || SAVEDATA.stars[8]) {
const btnCheats = document.createElement('button');
btnCheats.id = 'btn-cheats'; btnCheats.className = 'menu-btn'; btnCheats.innerText = "CHEATS üîì";
btnCheats.style.borderColor = "#ff00ff"; btnCheats.style.color = "#ff00ff";
btnCheats.onclick = CheatsSys.open;
container.appendChild(btnCheats);
}
}
}
};

// ============================================================================
// 1. SHOP SYSTEM (TIENDA)
// ============================================================================
const ShopSys = {
items: [
{ id: 'p_maifer', name: 'Maifer Plush', price: 1, img: 'maifer.png' },
{ id: 'p_isaac', name: 'Isaac Plush', price: 2, img: 'isaac.png' },
{ id: 'p_jomar', name: 'Jomar Plush', price: 3, img: 'jomar.png' },
{ id: 'p_richard', name: 'Richard Fig', price: 3, img: 'richard.png' }
],

open: () => {
// Contar estrellas
let stars = 0;
// Estrellas de noches 1-8
for(let i=1; i<=8; i++) if(SAVEDATA.night > i) stars++;
// Estrellas extra (v47 logic)
if(SAVEDATA.stars) Object.keys(SAVEDATA.stars).forEach(k => stars++); // Suma simple para aproximar

// Fix duplicados visuales en conteo
stars = document.querySelectorAll('#star-row .star.earned').length;

document.getElementById('shop-stars').innerText = stars;

const grid = document.getElementById('shop-grid');
grid.innerHTML = '';

ShopSys.items.forEach(item => {
const owned = SAVEDATA.shop.bought.includes(item.id);
const equipped = SAVEDATA.shop.equipped.includes(item.id);

const div = document.createElement('div');
div.style.cssText = "border: 1px solid #444; padding: 10px; width: 120px; background: #111;";
div.innerHTML = `
<img src="${item.img}" style="width: 50px; height: 50px; object-fit: contain;">
<div style="font-family:'VT323'; color:#fff;">${item.name}</div>
<div style="color: gold; margin-bottom: 5px;">${item.price} ‚òÖ</div>
`;

const btn = document.createElement('button');
btn.className = 'menu-btn';
btn.style.fontSize = '0.8rem';
btn.style.width = '100%';
btn.style.margin = '0';

if(!owned) {
btn.innerText = "BUY";
if(stars < item.price) { btn.disabled = true; btn.classList.add('locked'); }
btn.onclick = () => ShopSys.buy(item.id, item.price, stars);
} else {
btn.innerText = equipped ? "UNEQUIP" : "EQUIP";
btn.style.borderColor = equipped ? "red" : "#0f0";
btn.onclick = () => ShopSys.toggle(item.id);
}

div.appendChild(btn);
grid.appendChild(div);
});

document.getElementById('screen-shop').style.display = 'flex';
},

buy: (id, price, currentStars) => {
if(currentStars >= price) {
SAVEDATA.shop.bought.push(id);
SaveManager.save();
AudioSys.play('sfx-win'); // Sonido de compra
ShopSys.open(); // Refrescar
}
},

toggle: (id) => {
if(SAVEDATA.shop.equipped.includes(id)) {
SAVEDATA.shop.equipped = SAVEDATA.shop.equipped.filter(x => x !== id);
} else {
// M√°ximo 3 peluches
if(SAVEDATA.shop.equipped.length >= 3) return alert("MAX 3 ITEMS EQUIPPED");
SAVEDATA.shop.equipped.push(id);
}
SaveManager.save();
ShopSys.open();
},

spawn: () => {
// Eliminar previos
document.querySelectorAll('.plushie').forEach(e => e.remove());

if(!SAVEDATA.shop || !SAVEDATA.shop.equipped) return;

SAVEDATA.shop.equipped.forEach((id, index) => {
const item = ShopSys.items.find(x => x.id === id);
if(item) {
const img = document.createElement('img');
img.src = item.img;
img.className = 'plushie';
// Posiciones fijas en el escritorio
const positions = ['20%', '50%', '80%'];
img.style.left = positions[index];

// Click en peluche hace sonido
img.onclick = () => {
AudioSys.play('sfx-mask'); // Squeak sound (reutilizado)
img.style.transform = "scale(1.2) translateY(-10px)";
setTimeout(() => img.style.transform = "scale(1)", 200);
};

document.getElementById('view-office').appendChild(img);
}
});
}
};

// ============================================================================
// 2. EXTRAS MENU
// ============================================================================
const ExtrasSys = {
mode: null, index: 0,
list: [],

data: {
anim: [
{ name: "MAIFER", img: "maifer.png" },
{ name: "ISAAC", img: "isaac.png" },
{ name: "JOMAR", img: "jomar.png" },
{ name: "RICHARD", img: "richard.png" },
{ name: "GOLDEN MAIFER", img: "golden_maifer.png" }
],
jump: [
{ name: "MAIFER JUMPSCARE", img: "maifer.png", audio: "jump-maifer" },
{ name: "ISAAC JUMPSCARE", img: "isaac.png", audio: "jump-isaac" },
{ name: "JOMAR JUMPSCARE", img: "jomar.png", audio: "jump-jomar" },
{ name: "RICHARD JUMPSCARE", img: "richard.png", audio: "jump-richard" }
]
},

open: () => {
document.getElementById('screen-extras').style.display = 'flex';
document.getElementById('ex-controls').style.display = 'none';
document.getElementById('ex-img').style.display = 'none';
document.getElementById('ex-name').innerText = "SELECT CATEGORY";
},

show: (cat) => {
ExtrasSys.mode = cat;
ExtrasSys.index = 0;
ExtrasSys.list = ExtrasSys.data[cat];
document.getElementById('ex-controls').style.display = 'flex';
ExtrasSys.render();
},

render: () => {
const item = ExtrasSys.list[ExtrasSys.index];
document.getElementById('ex-name').innerText = item.name;
const img = document.getElementById('ex-img');
img.src = item.img;
img.style.display = 'block';

// Si es jumpscare, hacer efecto
if(ExtrasSys.mode === 'jump') {
img.style.animation = "shake 0.1s infinite";
AudioSys.play(item.audio);
setTimeout(() => { img.style.animation = "none"; }, 1000);
} else {
img.style.animation = "none";
}
},

next: () => {
ExtrasSys.index = (ExtrasSys.index + 1) % ExtrasSys.list.length;
ExtrasSys.render();
},

prev: () => {
ExtrasSys.index = (ExtrasSys.index - 1 + ExtrasSys.list.length) % ExtrasSys.list.length;
ExtrasSys.render();
}
};

// ============================================================================
// 3. CHEATS SYSTEM
// ============================================================================
const CheatsSys = {
open: () => document.getElementById('screen-cheats').style.display = 'flex',

toggle: (cheat) => {
SAVEDATA.cheats[cheat] = !SAVEDATA.cheats[cheat];
SaveManager.save();
},

// Loop de Cheats (se inyecta en el loop principal)
loop: () => {
if(!Game.state || Game.state.over) return;

if(SAVEDATA.cheats.infPower) {
Game.state.power = 100;
document.getElementById('pwr-val').innerText = "100";
}

if(SAVEDATA.cheats.noTox) {
Game.state.toxic = 0;
document.getElementById('hud-toxic').style.display = 'none';
}

// Fast night logic: aumentar tiempo extra
if(SAVEDATA.cheats.fastNight) {
Game.state.time += 0.05; // Doble velocidad aprox
}
},

// Radar Logic (se inyecta en Monitor update)
updateRadar: () => {
if(!SAVEDATA.cheats.radar) return;
if(Game.state.view !== 'monitor') return;

// Eliminar dots previos
document.querySelectorAll('.radar-dot').forEach(d => d.remove());

// Mapeo simple de posiciones a coordenadas en el mapa UI
// room-06 (Cam 6) -> left:35%, top:5%
const roomCoords = {
0: null, // Oficina
1: {t: '65%', l: '26%'}, // Cam 2 (Pasillo Izq)
2: {t: '65%', l: '74%'}, // Cam 3 (Pasillo Der)
3: {t: '30%', l: '10%'}, // Cam 4
4: {t: '30%', l: '90%'}, // Cam 5
5: {t: '5%', l: '50%'} // Cam 6
};

// Dibujar dots
const draw = (pos, color) => {
const coords = roomCoords[pos];
if(coords) {
const map = document.getElementById('map-layout');
const dot = document.createElement('div');
dot.className = 'radar-dot';
dot.style.top = coords.t;
dot.style.left = coords.l;
dot.style.backgroundColor = color;
dot.style.display = 'block';
map.appendChild(dot);
}
};

if(Game.ai.pos.maifer > 0 && Game.ai.pos.maifer < 5) draw(5 - Game.ai.pos.maifer + 1, 'yellow'); // L√≥gica inversa o mapeo directo seg√∫n tu IA
if(Game.ai.pos.isaac > 0 && Game.ai.pos.isaac < 5) draw(5 - Game.ai.pos.isaac + 1, 'blue');
}
};

// ============================================================================
// 4. SUBTITLE SYSTEM
// ============================================================================
const SubtitleSys = {
texts: {
1: ["Hola? Hola?", "Bienvenido a Maifer's Factory.", "Solo rel√°jate...", "Ahorra energ√≠a.", "Cuidado con Maifer."],
2: ["La segunda noche es m√°s dif√≠cil.", "Isaac reacciona a tu cara.", "Usa la m√°scara si lo ves.", "No olvides la caja de m√∫sica... Ah no, aqu√≠ no hay."],
3: ["¬øSigues aqu√≠?", "Jomar odia la luz.", "Si ves ojos en el pasillo...", "Flash! Y se ir√°.", "Buena suerte."],
4: ["Noche 4...", "Richard est√° activo.", "Vigila la cortina.", "Si se abre, ci√©rrala.", "R√°pido."],
5: ["Noche 5.", "Est√°n todos activos.", "No tengo m√°s consejos.", "Sobrevive."],
6: ["... (Sonidos est√°ticos) ...", "CORRE.", "..."],
7: ["(Respiraci√≥n fuerte)", "TE VEO.", "IT'S ME."],
8: ["(Silencio absoluto)", "..."]
},

start: (night) => {
const lines = SubtitleSys.texts[night] || ["(Se√±al interrumpida)"];
const box = document.getElementById('subtitle-box');
const txt = document.getElementById('sub-text');

if(night > 8) return; // Sin subs en custom night

let index = 0;
box.style.display = 'block';

const nextLine = () => {
if(Game.state.over || index >= lines.length) {
box.style.display = 'none';
return;
}
txt.innerText = lines[index];
index++;
setTimeout(nextLine, 4000); // 4 segundos por l√≠nea
};

nextLine();
}
};

// ============================================================================
// GLOBAL HOOKS (INYECCI√ìN EN EL JUEGO BASE)
// ============================================================================

// Hook Init Menu (Botones)
const _v49_initMenu = Game.initMenu;
Game.initMenu = function() {
_v49_initMenu();
Exp49.init(); // Iniciar sistema v49
};

// Hook Start Level (Tienda, Subt√≠tulos)
const _v49_startLevel = Game.startLevel;
Game.startLevel = function(n, customAI) {
_v49_startLevel(n, customAI);
ShopSys.spawn(); // Poner peluches
SubtitleSys.start(n); // Iniciar subs
};

// Hook Loop (Cheats)
const _v49_loop = Game.loop;
Game.loop = function() {
_v49_loop();
CheatsSys.loop();
};

// Hook Monitor (Radar Cheat)
const _v49_monUpdate = Monitor.update;
Monitor.update = function() {
_v49_monUpdate();
CheatsSys.updateRadar();
};

// Inicializaci√≥n de emergencia si ya carg√≥ el men√∫
if(!document.getElementById('btn-shop') && document.getElementById('screen-menu').classList.contains('active')) {
Exp49.init();
}

</script>
--- END OF EXPANSION v49 CODE ---
--- START OF PATCH v49.5 ---
<script>
// ============================================================================
// PATCH v49.5: FIXES & TRANSLATIONS
// Autor: Asistente
// Descripci√≥n: Correcci√≥n de UI, bug de mantenimiento y traducci√≥n de tienda.
// ============================================================================

const PatchSystem = {
texts: {
ES: { shopBtn: "TIENDA üéÅ", shopTitle: "RINC√ìN DE PREMIOS", buy: "COMPRAR", equip: "EQUIPAR", unequip: "QUITAR", yourStars: "TUS ESTRELLAS" },
EN: { shopBtn: "SHOP üéÅ", shopTitle: "PRIZE CORNER", buy: "BUY", equip: "EQUIP", unequip: "UNEQUIP", yourStars: "YOUR STARS" },
CN: { shopBtn: "ÂïÜÂ∫ó üéÅ", shopTitle: "Â•ñÂìÅËßí", buy: "Ë¥≠‰π∞", equip: "Ë£ÖÂ§á", unequip: "Âç∏‰∏ã", yourStars: "‰Ω†ÁöÑÊòüÊòü" }
},

init: () => {
// 1. CORRECCI√ìN DELAY DE ENERG√çA
// Sobrescribimos la funci√≥n para actualizar la UI inmediatamente
const _oldCharge = Mechanics.chargeGen;
Mechanics.chargeGen = function() {
// L√≥gica original
Game.state.power = Math.min(100, Game.state.power + 2); // Carga m√°s r√°pido (2%)

// ACTUALIZACI√ìN UI INMEDIATA (Sin esperar al loop)
document.getElementById('pwr-val').innerText = Math.floor(Game.state.power);

// Feedback Visual Inmediato (Color Verde)
const pwrText = document.getElementById('hud-power-text');
pwrText.style.color = '#00ff00';
pwrText.style.textShadow = '0 0 15px #00ff00';

// Forzar actualizaci√≥n de "cuadrados" de uso si fuera necesario
// (Aunque los cuadrados indican consumo, haremos que parpadeen verde para dar feedback)
document.querySelectorAll('.usage-block').forEach(b => b.style.borderColor = '#0f0');

AudioSys.play('sfx-gen');
document.getElementById('gen-btn').style.display='none';

// Resetear color despu√©s de 300ms
setTimeout(() => {
pwrText.style.color = '#eeffee';
pwrText.style.textShadow = 'none';
document.querySelectorAll('.usage-block').forEach(b => b.style.borderColor = '#444');
Mechanics.moveGenButton();
}, 300);
};

// 2. CORRECCI√ìN BOT√ìN REBOOT EN GAME OVER
// Interceptamos la muerte para ocultar la UI de expansi√≥n
const _oldDie = Game.die;
Game.die = function(cause) {
_oldDie(cause);
// Ocultar elementos de la expansi√≥n v48
document.getElementById('btn-open-maint').style.display = 'none';
document.getElementById('panel-maint').style.display = 'none';
document.getElementById('alert-overlay').style.display = 'none';
};

// 3. CORRECCI√ìN VISUAL "SYSTEM ERROR" AL REINICIAR
// Aseguramos que el texto se ponga verde forzosamente
ExpansionSys.resolveReboot = function(btn, originalText) {
ExpansionSys.data.rebooting = false;
ExpansionSys.data.errors = { video: false, vent: false, audio: false };
btn.innerText = originalText;

// FORZAR ESTILOS VERDES (Sobrescribir cualquier clase CSS)
const setGreen = (id) => {
const el = document.getElementById(id);
if(el) {
el.innerText = "ONLINE";
el.className = ""; // Quitar clase sys-error
el.style.color = "#00ff00"; // Forzar verde inline
el.style.textShadow = "0 0 5px #00ff00";
}
};

setGreen('st-val-vid');
setGreen('st-val-vent');
setGreen('st-val-aud');

// Ocultar alerta roja gigante
document.getElementById('alert-overlay').style.display = 'none';

// Restaurar est√°tica c√°mara
const staticEl = document.getElementById('cam-static');
if(staticEl) {
staticEl.style.opacity = "0.15";
staticEl.style.display = Config.toggleStatic ? 'block' : 'none';
}

// Dar inmunidad de 5 segundos para que no salga error de nuevo inmediatamente
ExpansionSys.data.immunity = true;
setTimeout(() => { ExpansionSys.data.immunity = false; }, 5000);
};

// Parchear triggerError para respetar inmunidad
const _oldErr = MaintenanceSys.triggerError;
MaintenanceSys.triggerError = function(type) {
if(ExpansionSys.data.immunity) return;
_oldErr(type);
};

// 4. TRADUCCI√ìN TIENDA Y BOTONES
// Hook al cambio de idioma para actualizar bot√≥n del men√∫
const _oldLang = Lang.apply;
Lang.apply = function() {
_oldLang();
const l = Lang.current;
const t = PatchSystem.texts[l] || PatchSystem.texts['ES'];

// Traducir bot√≥n del men√∫ principal
const btnShop = document.getElementById('btn-shop');
if(btnShop) btnShop.innerText = t.shopBtn;
};

// Sobrescribir apertura de tienda para traducir contenido interno
ShopSys.open = function() {
const l = Lang.current;
const t = PatchSystem.texts[l] || PatchSystem.texts['ES'];

// Contar estrellas (L√≥gica original)
let stars = document.querySelectorAll('#star-row .star.earned').length;
if(stars === 0 && SAVEDATA.night > 1) stars = SAVEDATA.night - 1; // Fallback

document.getElementById('shop-stars').innerHTML = `${t.yourStars}: <span style="color: gold;">${stars}</span> ‚òÖ`;
document.querySelector('#screen-shop h2').innerText = t.shopTitle;

const grid = document.getElementById('shop-grid');
grid.innerHTML = '';

ShopSys.items.forEach(item => {
const owned = SAVEDATA.shop.bought.includes(item.id);
const equipped = SAVEDATA.shop.equipped.includes(item.id);

const div = document.createElement('div');
div.style.cssText = "border: 1px solid #444; padding: 10px; width: 120px; background: #111;";
div.innerHTML = `
<img src="${item.img}" style="width: 50px; height: 50px; object-fit: contain;">
<div style="font-family:'VT323'; color:#fff;">${item.name}</div>
<div style="color: gold; margin-bottom: 5px;">${item.price} ‚òÖ</div>
`;

const btn = document.createElement('button');
btn.className = 'menu-btn';
btn.style.fontSize = '0.8rem';
btn.style.width = '100%';
btn.style.margin = '0';

if(!owned) {
btn.innerText = t.buy;
if(stars < item.price) { btn.disabled = true; btn.classList.add('locked'); }
btn.onclick = () => ShopSys.buy(item.id, item.price, stars);
} else {
btn.innerText = equipped ? t.unequip : t.equip;
btn.style.borderColor = equipped ? "red" : "#0f0";
btn.onclick = () => ShopSys.toggle(item.id);
}

div.appendChild(btn);
grid.appendChild(div);
});

document.getElementById('screen-shop').style.display = 'flex';
};

// Aplicar traducci√≥n inicial si ya estamos en men√∫
if(document.getElementById('btn-shop')) Lang.apply();
}
};

// Ejecutar Parche
setTimeout(PatchSystem.init, 500); // Peque√±o delay para asegurar que v48/v49 cargaron

</script>
--- END OF PATCH v49.5 ---
--- START OF FINAL UPDATE v50.0 ---
<!-- ==========================================================================
v50.0 FINAL UPDATE: ATMOSPHERE & ENDLESS
Contenido: VHS, Endless Mode, Weather, Achievements, Visual Overhauls.
========================================================================== -->
<!-- NUEVOS ASSETS DE AUDIO (Inyectados) -->
<div id="v50-audio" style="display:none;">
<audio id="sfx-thunder" src="https://freesound.org/data/previews/25/25032_30539-lq.mp3"></audio>
<audio id="sfx-rain" src="https://freesound.org/data/previews/365/365659_6687256-lq.mp3" loop></audio>
<audio id="sfx-achieve" src="https://freesound.org/data/previews/109/109662_1648170-lq.mp3"></audio>
<audio id="sfx-monitor-slide" src="https://freesound.org/data/previews/140/140156_2437358-lq.mp3"></audio>
</div>
<!-- NUEVAS CAPAS VISUALES -->
<div id="v50-layers" style="position:absolute; inset:0; pointer-events:none; z-index:9000;">
code
Code
<!-- EFECTO VHS -->
<div id="layer-vhs" class="vhs-overlay" style="display:none;">
    <div class="scanlines"></div>
    <div class="vhs-noise"></div>
    <div class="vhs-text">REC ‚óè <span id="vhs-date">NOV 14 1987</span></div>
</div>

<!-- PARTICULAS DE POLVO -->
<div id="layer-dust" style="display:none;"></div>

<!-- FLASH DE TORMENTA -->
<div id="layer-storm" style="position:absolute; inset:0; background:white; opacity:0; mix-blend-mode:overlay;"></div>

<!-- NOTIFICACI√ìN DE LOGROS -->
<div id="achievement-popup" style="position:absolute; top:-100px; right:20px; width:300px; background:#111; border:2px solid gold; color:#fff; padding:15px; display:flex; gap:10px; align-items:center; transition:top 0.5s;">
    <div style="font-size:2rem;">üèÜ</div>
    <div>
        <div style="color:gold; font-family:'Nosifer'; font-size:0.8rem;">ACHIEVEMENT UNLOCKED</div>
        <div id="ach-name" style="font-family:'VT323'; font-size:1.5rem;">...</div>
    </div>
</div>
</div>
<!-- ESTILOS v50 -->
<style>
/* Ocultar subt√≠tulos viejos forzosamente */
#subtitle-box { display: none !important; }

/* VHS STYLES */
.vhs-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 9998; mix-blend-mode: overlay; background: rgba(0,0,0,0.1); }
.scanlines { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; animation: scrollScan 0.5s linear infinite; }
.vhs-text { position: absolute; bottom: 20px; left: 20px; font-family: 'VT323'; font-size: 2rem; color: #fff; text-shadow: 2px 2px 0 #000; opacity: 0.7; }
@keyframes scrollScan { 0% { transform: translateY(0); } 100% { transform: translateY(4px); } }

/* CAMERA SWAY (RESPIRACI√ìN) */
.sway-anim { animation: cameraSway 8s ease-in-out infinite; }
@keyframes cameraSway { 0% { transform: translate(0,0) rotate(0deg); } 25% { transform: translate(-5px, 3px) rotate(0.5deg); } 50% { transform: translate(0, 5px) rotate(0deg); } 75% { transform: translate(5px, 3px) rotate(-0.5deg); } 100% { transform: translate(0,0) rotate(0deg); } }

/* MONITOR ANIMATION */
#screen-monitor { transition: transform 0.3s ease-in-out; transform: translateY(100%); display: flex !important; visibility: hidden; }
#screen-monitor.monitor-up { transform: translateY(0%); visibility: visible; }

/* DUST */
.dust-mote { position: absolute; background: rgba(255,255,255,0.3); border-radius: 50%; animation: floatDust 10s linear infinite; }
@keyframes floatDust { 0% { transform: translateY(0) translateX(0); opacity:0; } 50% { opacity:0.8; } 100% { transform: translateY(-100vh) translateX(50px); opacity:0; } }

/* VOLUMETRIC FLASHLIGHT */
#layer-flashlight { background: radial-gradient(circle at 50% 50%, rgba(255,255,200,0.9) 0%, rgba(255,255,255,0.4) 40%, rgba(0,0,0,0.8) 70%, #000 100%) !important; mix-blend-mode: hard-light !important; }
</style>
<script>
// ============================================================================
// v50.0 CORE SYSTEM
// ============================================================================

const v50 = {
texts: {
ES: {
endlessBtn: "SUPERVIVENCIA ‚àû", endlessTitle: "MODO INFINITO", survived: "SOBREVIVISTE: ",
cheatsTitle: "TRUCOS / CHEATS", extrasTitle: "EXTRAS / GALERIA",
ach_1: "PRIMERA SANGRE", ach_2: "ETERNO", ach_3: "INTOCABLE", ach_4: "CURIOSO",
desc_endless: "Dificultad aumenta cada minuto. ¬°No hay 6 AM!"
},
EN: {
endlessBtn: "ENDLESS MODE ‚àû", endlessTitle: "ENDLESS SURVIVAL", survived: "SURVIVED: ",
cheatsTitle: "CHEATS / HACKS", extrasTitle: "EXTRAS / GALLERY",
ach_1: "FIRST BLOOD", ach_2: "ETERNAL", ach_3: "UNTOUCHABLE", ach_4: "CURIOUS",
desc_endless: "Difficulty rises every minute. No 6 AM!"
},
CN: {
endlessBtn: "Êó†Â∞ΩÊ®°Âºè ‚àû", endlessTitle: "Êó†Â∞ΩÁîüÂ≠ò", survived: "Â≠òÊ¥ªÊó∂Èó¥: ",
cheatsTitle: "‰ΩúÂºä / Â§ñÊåÇ", extrasTitle: "ÈôÑÂä†ÂÜÖÂÆπ / ÁîªÂªä",
ach_1: "Á¨¨‰∏ÄÊª¥Ë°Ä", ach_2: "Ê∞∏ÊÅí", ach_3: "‰∏çÂèØËß¶Á¢∞", ach_4: "Â•ΩÂ•á",
desc_endless: "ÈöæÂ∫¶ÊØèÂàÜÈíüÂ¢ûÂä†„ÄÇÊ≤°ÊúâÊó©‰∏ä6ÁÇπÔºÅ"
}
},

state: {
isEndless: false,
endlessTimer: 0,
weatherTimer: 0
},

init: () => {
console.log("v50 Gold Edition Loaded.");

// 1. Quitar Subt√≠tulos (Override agresivo)
if(typeof SubtitleSys !== 'undefined') SubtitleSys.start = function(){ console.log("Subs disabled by v50"); };

// 2. Inyectar bot√≥n Endless en el men√∫ (Si pas√≥ la noche 5)
if(SAVEDATA.night > 5 || SAVEDATA.stars['custom']) {
if(!document.getElementById('btn-endless')) {
const btn = document.createElement('button');
btn.id = 'btn-endless';
btn.className = 'menu-btn';
btn.innerText = "ENDLESS MODE";
btn.style.borderColor = "cyan";
btn.style.color = "cyan";
btn.onclick = EndlessMode.start;
// Insertar antes de Custom Night
const cnBtn = document.getElementById('btn-custom');
cnBtn.parentNode.insertBefore(btn, cnBtn);
}
}

// 3. Iniciar sistemas visuales
v50_Visuals.initDust();

// 4. Parchear Monitor para animaci√≥n
v50_Visuals.patchMonitor();

// 5. Aplicar traducciones iniciales
v50.applyTranslations();
},

applyTranslations: () => {
// Hook a Lang.apply para traducir nuevos elementos
const t = v50.texts[Lang.current] || v50.texts['ES'];

// Traducir bot√≥n Endless
const btnEnd = document.getElementById('btn-endless');
if(btnEnd) btnEnd.innerText = t.endlessBtn;

// Traducir T√≠tulos de Modales (Cheats y Extras)
const cheatHeader = document.querySelector('#screen-cheats h2');
if(cheatHeader) cheatHeader.innerText = t.cheatsTitle;

const extraHeader = document.querySelector('#screen-extras h2');
if(extraHeader) extraHeader.innerText = t.extrasTitle;

// Traducir contenido de Cheats (Checkbox labels)
// Esto es un poco hacky pero seguro
const cheatRows = document.querySelectorAll('#screen-cheats .setting-row span');
if(cheatRows.length > 0) {
// Asumimos el orden: Radar, Power, Fast, NoTox
const labels = Lang.current === 'ES' ?
["RADAR MAPA", "ENERGIA INFINITA", "NOCHE RAPIDA", "NO TOXICIDAD"] :
Lang.current === 'CN' ?
["Èõ∑ËææÂú∞Âõæ", "Êó†ÈôêËÉΩÈáè", "Âø´ÈÄüÂ§úÊôö", "Êó†ÊØíÊ∞î"] :
["MAP RADAR", "INFINITE POWER", "FAST NIGHT", "NO TOXICITY"];

cheatRows.forEach((span, i) => { if(labels[i]) span.innerText = labels[i]; });
}
}
};

// ============================================================================
// 1. ENDLESS MODE (SUPERVIVENCIA INFINITA)
// ============================================================================
const EndlessMode = {
start: () => {
if(confirm(v50.texts[Lang.current].desc_endless)) {
v50.state.isEndless = true;
v50.state.endlessTimer = 0;
// Configurar juego base
Game.startSequence('ENDLESS', { maifer:5, isaac:5, jomar:5, richard:5, golden:0 });

// UI Tweaks
document.getElementById('hud-night').innerHTML = "<span style='color:cyan'>ENDLESS</span>";
}
},

loop: () => {
if(!v50.state.isEndless || Game.state.over) return;

v50.state.endlessTimer += 0.1; // Se llama cada 100ms

// Actualizar HUD de tiempo
const mins = Math.floor(v50.state.endlessTimer / 60);
const secs = Math.floor(v50.state.endlessTimer % 60);
const timeStr = `${mins}:${secs < 10 ? '0'+secs : secs}`;

document.getElementById('hud-time').innerText = timeStr;
document.getElementById('hud-time').style.color = "cyan";

// Escalar dificultad cada 60 segundos
if(v50.state.endlessTimer % 60 < 0.15) { // Aproximadamente cada minuto
Game.ai.maifer++;
Game.ai.isaac++;
Game.ai.jomar++;
Game.ai.richard++;
Game.ai.golden++;
Achievements.unlock('ach_2'); // Logro por sobrevivir un poco
AudioSys.play('sfx-achieve'); // Sonido de subida de nivel
}
}
};

// ============================================================================
// 2. WEATHER SYSTEM (TORMENTA)
// ============================================================================
const WeatherSys = {
loop: () => {
if(Game.state.over || Game.state.view !== 'office') return;

// Sonido de lluvia constante
const rain = document.getElementById('sfx-rain');
if(rain.paused) { rain.volume = 0.3; rain.play().catch(()=>{}); }

// Rel√°mpagos aleatorios (1% chance por frame)
if(Math.random() < 0.005) {
WeatherSys.triggerLightning();
}
},

triggerLightning: () => {
// Visual flash
const flash = document.getElementById('layer-storm');
flash.style.opacity = 0.8;
setTimeout(() => flash.style.opacity = 0, 100);
setTimeout(() => { flash.style.opacity = 0.4; }, 150);
setTimeout(() => { flash.style.opacity = 0; }, 250);

// Sonido (con peque√±o delay por distancia)
setTimeout(() => {
AudioSys.play('sfx-thunder', false, 0.8);
}, 500);

// MEC√ÅNICA CLAVE: Ver sin linterna
// Durante el flash, revelamos animatr√≥nicos ocultos
if(Game.ai.pos.jomar === 1) {
document.getElementById('vis-jomar').style.display = 'block';
setTimeout(() => { if(!Game.state.flash) document.getElementById('vis-jomar').style.display = 'none'; }, 200);
}
}
};

// ============================================================================
// 3. VISUALS (VHS, SWAY, MONITOR, DUST)
// ============================================================================
const v50_Visuals = {
initDust: () => {
const c = document.getElementById('layer-dust');
c.style.display = 'block';
for(let i=0; i<20; i++) {
const d = document.createElement('div');
d.className = 'dust-mote';
d.style.left = Math.random() * 100 + 'vw';
d.style.top = Math.random() * 100 + 'vh';
d.style.animationDuration = (5 + Math.random() * 10) + 's';
d.style.width = (2 + Math.random() * 4) + 'px';
d.style.height = d.style.width;
c.appendChild(d);
}
},

patchMonitor: () => {
// Reemplazar la l√≥gica de display:none por clases
Mechanics.toggleMonitor = function() {
if(Game.state.over || Game.state.mask || Game.state.hidden) return;

const m = document.getElementById('screen-monitor');
const isOpening = (Game.state.view === 'office');

if(isOpening) {
Game.state.view = 'monitor';
m.classList.add('monitor-up');
AudioSys.play('sfx-monitor-slide');
Monitor.update(); // Actualizar c√°maras al abrir
SecretSys.roll(0.005); // Chance de secreto v48
} else {
Game.state.view = 'office';
m.classList.remove('monitor-up');
AudioSys.play('sfx-monitor-slide');
}
};
},

toggleVHS: () => {
const v = document.getElementById('layer-vhs');
v.style.display = (v.style.display === 'none') ? 'block' : 'none';

// Agregar sway a la oficina
const off = document.getElementById('view-office');
if(v.style.display === 'block') off.classList.add('sway-anim');
else off.classList.remove('sway-anim');
}
};

// ============================================================================
// 4. ACHIEVEMENTS
// ============================================================================
const Achievements = {
list: ['ach_1', 'ach_2', 'ach_3', 'ach_4'],
unlocked: [], // Se deber√≠a guardar en SAVEDATA

unlock: (id) => {
if(Achievements.unlocked.includes(id)) return;
Achievements.unlocked.push(id);

const t = v50.texts[Lang.current] || v50.texts['ES'];
const name = t[id] || "UNKNOWN";

const pop = document.getElementById('achievement-popup');
document.getElementById('ach-name').innerText = name;

pop.style.top = "20px"; // Bajar
AudioSys.play('sfx-achieve');

setTimeout(() => { pop.style.top = "-100px"; }, 4000);
},

check: () => {
// L√≥gica simple de check
if(Game.state.power < 5 && Game.state.night > 1) Achievements.unlock('ach_3'); // Intocable (casi)
if(SAVEDATA.shop && SAVEDATA.shop.equipped.length > 0) Achievements.unlock('ach_4'); // Curioso
}
};

// ============================================================================
// GLOBAL HOOKS (Conectar v50 al juego base)
// ============================================================================

// 1. Hook Init (Cargar traducciones y bot√≥n Endless)
const _v50_init = Game.initMenu;
Game.initMenu = function() {
_v50_init();
v50.init();

// Configuraci√≥n Inicial de opciones visuales
// Activar VHS y Sway por defecto para "Atm√≥sfera"
document.getElementById('layer-vhs').style.display = 'block';
document.getElementById('view-office').classList.add('sway-anim');
};

// 2. Hook Loop (Weather, Endless, Achievements)
const _v50_loop = Game.loop;
Game.loop = function() {
if(v50.state.isEndless) {
// Bypass al loop original si es Endless para evitar llegar a las 8 AM
// Copiamos l√≥gica vital de drenaje pero no de tiempo
if(Game.state.over || Game.state.frozen) return;

// Drenaje de bater√≠a
let drain = 1 + (Game.state.flash?2:0) + (Game.state.vent?1:0) + (Game.state.view==='monitor'?1:0) + (Game.state.curtain?1:0);
Game.state.batteryTimer += drain;
if(Game.state.batteryTimer >= 50 && !SAVEDATA.cheats.infPower) {
Game.state.power--;
Game.state.batteryTimer = 0;
document.getElementById('pwr-val').innerText = Math.floor(Game.state.power);
}
if(Game.state.power <= 0) { Game.die('power'); return; }

// Toxicidad
if(Game.state.mask) { Game.state.toxic += 0.25; document.getElementById('hud-toxic').style.display='block'; }
else { Game.state.toxic = Math.max(0, Game.state.toxic - 0.2); if(Game.state.toxic<=0) document.getElementById('hud-toxic').style.display='none'; }
document.getElementById('toxic-bar').style.width = Game.state.toxic + "%";
if(Game.state.toxic >= 100 && !SAVEDATA.cheats.noTox) { Game.die('air'); return; }

Monitor.update();
EndlessMode.loop(); // L√≥gica propia de tiempo endless
} else {
// Juego normal
_v50_loop();
}

WeatherSys.loop();
Achievements.check();

// Traducir din√°micamente si cambia idioma
if(Lang.current !== v50.lastLang) {
v50.applyTranslations();
v50.lastLang = Lang.current;
}
};

// 3. Hook Die (Limpiar estados)
const _v50_die = Game.die;
Game.die = function(cause) {
_v50_die(cause);
document.getElementById('sfx-rain').pause();
v50.state.isEndless = false;
Achievements.unlock('ach_1'); // Morir por primera vez
};

// Iniciar v50 si el script carga tarde
if(typeof Game !== 'undefined') v50.init();

</script>
--- END OF FINAL UPDATE v50.0 ---
--- START OF UPDATE v51.0 ---
<!-- ==========================================================================
v51.0 GRAPHICS OVERHAUL
Contenido: Parallax, Procedural Static, Smooth Transitions, UI Anim.
========================================================================== -->
<!-- CAPA DE TRANSICI√ìN (FADE) -->
<div id="layer-fade" style="position: fixed; inset: 0; background: #000; z-index: 10000; pointer-events: none; opacity: 0; transition: opacity 0.5s ease-in-out;"></div>
<!-- ESTILOS v51 -->
<style>
/* 1. UI FLUIDITY (Botones suaves) */
.menu-btn, .user-btn, .cam-btn {
transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
}
.menu-btn:hover {
letter-spacing: 2px; /* Efecto de expansi√≥n de texto */
box-shadow: 0 0 20px var(--primary-color) !important;
}

/* 2. PARALLAX EFFECT */
/* Hacemos la oficina un poco m√°s grande para poder moverla */
#view-office {
width: 110% !important; /* M√°s ancho que la pantalla */
left: -5% !important; /* Centrado inicial */
transition: transform 0.1s cubic-bezier(0.215, 0.610, 0.355, 1.000); /* Suavizado */
}

/* 3. JUMPSCARE MEJORADO (Zoom agresivo) */
@keyframes jump-zoom {
0% { transform: scale(1) rotate(0deg); filter: contrast(1); }
25% { transform: scale(1.2) rotate(2deg); filter: contrast(2) hue-rotate(90deg); }
50% { transform: scale(1.1) rotate(-2deg); filter: contrast(1.5) invert(0.2); }
75% { transform: scale(1.3) rotate(1deg); filter: contrast(2); }
100% { transform: scale(1.1) rotate(0deg); }
}
#screen-jumpscare img {
animation: jump-zoom 0.2s infinite linear !important;
object-fit: cover;
}

/* 4. CANVAS ESTATICA */
#static-canvas {
width: 100%; height: 100%;
image-rendering: pixelated; /* Look retro */
opacity: 0.3;
}
</style>
<script>
// ============================================================================
// v51.0 GRAPHICS ENGINE
// ============================================================================

const v51_Graphics = {
init: () => {
console.log("v51 Graphics Overhaul: Loaded");

// Iniciar sistemas
ParallaxSys.init();
StaticSys.replaceGif();
TransitionSys.hook();

// Ajuste inicial para Parallax
document.body.style.overflow = "hidden"; // Asegurar que no haya scrollbars
}
};

// ============================================================================
// 1. SYSTEM: PARALLAX (MOVIMIENTO DE OFICINA)
// ============================================================================
const ParallaxSys = {
enabled: true,

init: () => {
document.addEventListener('mousemove', ParallaxSys.update);
},

update: (e) => {
// Solo aplicar en la oficina y si no estamos en monitor
if(Game.state.view !== 'office' || Game.state.over) return;
if(isMobile) return; // En m√≥vil usamos giroscopio (futuro) o desactivamos

const width = window.innerWidth;
const mouseX = e.clientX;

// Calcular porcentaje del mouse (-1 a 1)
const percent = (mouseX / width) * 2 - 1;

// Mover la oficina en direcci√≥n opuesta al mouse (efecto c√°mara)
// Rango de movimiento: +/- 30px
const moveX = -(percent * 30);

const office = document.getElementById('view-office');
// Combinamos con el sway de la v50 si existe, o solo translate
// Nota: v50 usa clases CSS, aqu√≠ usamos inline styles que tienen prioridad.
// Para no romper la animaci√≥n de respiraci√≥n (sway), usamos transform compuesto.

// Truco: Aplicamos el parallax al contenedor padre o modificamos la propiedad
office.style.transform = `translateX(${moveX}px) perspective(1000px)`;

// Tambi√©n movemos ligeramente el "Hallway" para efecto profundidad
const hall = document.getElementById('hallway');
hall.style.transform = `translateX(calc(-50% + ${moveX * 0.5}px))`; // Se mueve menos (m√°s lejos)
}
};

// ============================================================================
// 2. SYSTEM: PROCEDURAL STATIC (CANVAS NOISE)
// ============================================================================
const StaticSys = {
ctx: null,

replaceGif: () => {
// Buscar el div de est√°tica
const staticDiv = document.getElementById('cam-static');
if(!staticDiv) return;

// Eliminar imagen de fondo (el gif)
staticDiv.style.background = 'none';
staticDiv.style.opacity = '0.3'; // Ajustar opacidad base

// Crear Canvas
const canvas = document.createElement('canvas');
canvas.id = 'static-canvas';
canvas.width = 320; // Baja resoluci√≥n para rendimiento y estilo retro
canvas.height = 240;
staticDiv.appendChild(canvas);

StaticSys.ctx = canvas.getContext('2d');

// Iniciar loop de dibujado
StaticSys.loop();
},

loop: () => {
if(!StaticSys.ctx) return;

// Solo dibujar si la c√°mara est√° activa o hay error visual
// Ahorra bater√≠a en laptops/moviles
const isMonitorOn = (Game.state.view === 'monitor');
const isError = ExpansionSys && ExpansionSys.data.errors && ExpansionSys.data.errors.video;

if(isMonitorOn || isError || Config.toggleStatic) {
const w = 320, h = 240;
const idata = StaticSys.ctx.createImageData(w, h);
const buffer32 = new Uint32Array(idata.data.buffer);
const len = buffer32.length;

for (let i = 0; i < len; i++) {
// Generar pixel gris aleatorio
if (Math.random() < 0.5) {
// Negro transparente o blanco transparente
// Formato Little Endian: ABGR (Alpha, Blue, Green, Red)
// 0xff000000 = Negro Opaco
// 0xffffffff = Blanco Opaco
// Usaremos ruido gris
const val = Math.random() * 255;
buffer32[i] = (255 << 24) | (val << 16) | (val << 8) | val;
}
}
StaticSys.ctx.putImageData(idata, 0, 0);
}

requestAnimationFrame(StaticSys.loop);
}
};

// ============================================================================
// 3. SYSTEM: SMOOTH TRANSITIONS (FADE)
// ============================================================================
const TransitionSys = {
hook: () => {
// Interceptar UI.showScreen
const _originalShow = UI.showScreen;

UI.showScreen = function(id) {
const overlay = document.getElementById('layer-fade');

// 1. Fade Out (Pantalla Negra)
overlay.style.opacity = '1';

// 2. Esperar (simular carga)
setTimeout(() => {
// 3. Cambiar pantalla (L√≥gica original)
_originalShow(id);

// Parche visual: Si vamos a la oficina, asegurar reset de Parallax
if(id === 'screen-game') {
document.getElementById('view-office').style.transform = 'translateX(0px)';
}

// 4. Fade In (Transparente)
setTimeout(() => {
overlay.style.opacity = '0';
}, 100);

}, 500); // 0.5 segundos de oscuridad
};
}
};

// ============================================================================
// GLOBAL HOOKS
// ============================================================================

// Hook InitMenu para arrancar v51
const _v51_init = Game.initMenu;
Game.initMenu = function() {
_v51_init();
v51_Graphics.init();
};

// Iniciar inmediatamente si el DOM ya est√° listo (por si acaso)
if(document.readyState === 'complete' || document.readyState === 'interactive') {
v51_Graphics.init();
}

</script>
--- END OF UPDATE v51.0 ---
--- START OF PATCH v52.0 ---
<style>
/* CORRECCI√ìN VISUAL: USAGE BARS (Barras de Uso) */
.usage-block {
background-color: #222 !important; /* Apagado por defecto */
transition: background-color 0.1s, box-shadow 0.1s;
}

/* Clase para cuando est√° activo (VERDE BRILLANTE) */
.usage-block.active {
background-color: #00ff00 !important;
box-shadow: 0 0 8px #00ff00, inset 0 0 5px #ccffcc !important;
border-color: #00ff00 !important;
}

/* CORRECCI√ìN VISUAL: OFICINA 3D */
/* Aseguramos que la oficina sea m√°s grande que la pantalla para poder moverse */
#view-office {
width: 115vw !important; /* 115% del ancho */
height: 110vh !important;
left: -7.5vw !important; /* Centrado */
top: -5vh !important;
background-size: cover !important;
transform-style: preserve-3d; /* Importante para el efecto 3D */
will-change: transform;
}

/* El pasillo debe moverse con la oficina, no separado */
#hallway {
transform-style: preserve-3d;
}
</style>
<script>
// ============================================================================
// PATCH v52.0: PARALLAX FIX & USAGE METERS
// ============================================================================

const Patch52 = {
init: () => {
console.log("Patch v52 Loaded: Fixing Rotation & Usage Bars");

// 1. INICIAR SISTEMA DE BARRAS DE USO
// Se a√±ade al Game Loop
const _loop52 = Game.loop;
Game.loop = function() {
_loop52(); // Ejecutar l√≥gica original
UsageSystem.update(); // Ejecutar nueva l√≥gica de barras
};

// 2. REPARAR PARALLAX (MOVIMIENTO 3D)
// Sobrescribimos la funci√≥n defectuosa de la v51
ParallaxSys.update = function(e) {
if(Game.state.view !== 'office' || Game.state.over || isMobile) return;

const width = window.innerWidth;
const height = window.innerHeight;

// Coordenadas del mouse (Centro = 0)
const x = (e.clientX - width / 2) / width; // -0.5 a 0.5
const y = (e.clientY - height / 2) / height;

// F√≥rmulas para rotaci√≥n y movimiento
const moveX = -(x * 50); // Mover 50px izquierda/derecha
const moveY = -(y * 20); // Mover 20px arriba/abajo
const rotateY = x * 5; // Rotar 5 grados

const office = document.getElementById('view-office');

// APLICAR TRANSFORMACI√ìN COMPLETA
// perspective: da profundidad
// translate3d: mueve la imagen
// rotateY: da el efecto de girar la cabeza
office.style.transform = `
perspective(1000px)
translate3d(${moveX}px, ${moveY}px, 0)
rotateY(${rotateY}deg)
`;

// Mover el pasillo un poco menos para crear profundidad (Efecto Parallax Real)
const hall = document.getElementById('hallway');
// El pasillo est√° dentro de office, as√≠ que lo "contra-movemos" un poco
// para que parezca que est√° m√°s lejos
hall.style.transform = `translateX(${x * 15}px)`;
};
}
};

// ============================================================================
// SISTEMA DE BARRAS DE ENERG√çA (USAGE METER)
// ============================================================================
const UsageSystem = {
update: () => {
if(!Game.state || Game.state.over) return;

// 1. CALCULAR NIVEL DE USO (DRAIN)
// Base: 1 (El ventilador siempre est√° prendido en FNAF)
let usage = 1;

if(Game.state.flash) usage++; // Linterna suma 1
if(Game.state.view === 'monitor') usage++; // Monitor suma 1
if(Game.state.vent) usage++; // Cerrar ventilaci√≥n suma 1
if(Game.state.curtain) usage++; // Cerrar cortina suma 1

// L√≠mite visual de 4 barras (aunque el drain real sea 5)
if(usage > 4) usage = 4;

// 2. ACTUALIZAR CUADRADOS (VISUAL)
for(let i = 1; i <= 4; i++) {
const block = document.getElementById('use-' + i);
if(block) {
if(i <= usage) {
block.classList.add('active'); // Poner VERDE
} else {
block.classList.remove('active'); // Apagar
}
}
}
}
};

// INICIAR PARCHE
setTimeout(Patch52.init, 1000); // Esperar a que cargue todo lo anterior

</script>
--- END OF PATCH v52.0 ---
--- START OF PATCH v53.0 ---
<script>
// ============================================================================
// PATCH v53.0: CRITICAL FIXES (Endless & Parallax)
// ============================================================================

const Patch53 = {
init: () => {
console.log("Patch v53: Fixing crash and rotation.");

// 1. REPARAR ERROR DE ENDLESS MODE (Uncaught TypeError)
// El error ocurr√≠a porque EndlessMode borraba el contador de noches antes de tiempo.
// Aqu√≠ redefinimos startLevel para asegurar que el elemento exista antes de escribir.
if(typeof EndlessMode !== 'undefined') {
EndlessMode.start = function() {
if(confirm(v50.texts[Lang.current].desc_endless)) {
v50.state.isEndless = true;
v50.state.endlessTimer = 0;

// REPARACI√ìN: No borramos el HTML aqu√≠.
// Lo modificamos visualmente pero mantenemos los IDs para que el juego no crashee.
const hudNight = document.getElementById('hud-night');

// Asegurar que la estructura existe para que Game.startLevel no falle
if(!document.getElementById('game-night-num')) {
hudNight.innerHTML = '<span id="lbl-night">NIGHT</span> <span id="game-night-num">1</span>';
}

Game.startSequence('ENDLESS', { maifer:5, isaac:5, jomar:5, richard:5, golden:0 });

// Cambiamos el texto visualmente usando un delay seguro
setTimeout(() => {
document.getElementById('lbl-night').innerText = "MODE";
document.getElementById('game-night-num').innerText = "ENDLESS";
document.getElementById('game-night-num').style.color = "cyan";
}, 100);
}
};
}

// 2. ASEGURAR QUE PARALLAX EXISTE (ReferenceError Fix)
if(typeof ParallaxSys === 'undefined') {
window.ParallaxSys = {
enabled: true,
init: function() { document.addEventListener('mousemove', this.update); },
update: function(e) {} // Placeholder para evitar crash
};
}

// 3. REINICIAR PARALLAX CORRECTAMENTE
// Sobrescribimos la funci√≥n update con la l√≥gica corregida y segura
ParallaxSys.update = function(e) {
if(typeof Game === 'undefined' || !Game.state || Game.state.view !== 'office' || Game.state.over || isMobile) return;

const width = window.innerWidth;
const height = window.innerHeight;

// Coordenadas
const x = (e.clientX - width / 2) / width;
const y = (e.clientY - height / 2) / height;

// Movimiento (Invertido para sensaci√≥n de profundidad)
const moveX = -(x * 40);
const moveY = -(y * 15);
const rotateY = x * 3; // Rotaci√≥n sutil en grados

const office = document.getElementById('view-office');
if(office) {
// Aplicamos la transformaci√≥n 3D
office.style.transform = `perspective(1000px) translate3d(${moveX}px, ${moveY}px, 0) rotateY(${rotateY}deg)`;
}

const hall = document.getElementById('hallway');
if(hall) {
// El pasillo se mueve un poco diferente para dar profundidad
hall.style.transform = `translate3d(${x * 20}px, 0, 0)`;
}
};

// Forzar reinicio del listener
document.removeEventListener('mousemove', ParallaxSys.update);
document.addEventListener('mousemove', ParallaxSys.update);
}
};

// Ejecutar parche
setTimeout(Patch53.init, 500);

</script>
<!-- REPARACI√ìN CSS PARA QUE GIRE TODA LA OFICINA, NO SOLO LA PUERTA -->
<style>
/* Aplicar a todos los elementos dentro de la oficina para que giren en conjunto */
#view-office, #view-office * {
transform-style: preserve-3d;
backface-visibility: hidden; /* Mejora rendimiento */
}

/* Excepciones: Elementos que NO deben rotar (UI dentro de la oficina) */
#gen-panel, #desk {
transform: translateZ(20px); /* Acercarlos un poco a la c√°mara */
}

/* El fondo debe cubrir bien los bordes al girar */
#view-office {
background-size: 110% 110% !important;
background-position: center !important;
}
</style>
--- END OF PATCH v53.0 ---
--- START OF PATCH v54.0 ---
<style>
/* REVERTIR CAMBIOS VISUALES (OFFICE RESET) */
/* Forzamos que la oficina vuelva a su tama√±o y posici√≥n original */
#view-office {
width: 100% !important;
height: 100% !important;
left: 0 !important;
top: 0 !important;
transform: none !important; /* Quitar rotaci√≥n */
background-size: cover !important;
}

/* Restaurar pasillo al centro */
#hallway {
transform: translateX(-50%) !important;
}

/* Asegurar que las barras de uso sigan funcionando visualmente */
.usage-block.active {
background-color: #00ff00 !important;
box-shadow: 0 0 10px #00ff00 !important;
}
</style>
<script>
// ============================================================================
// PATCH v54.0: FIX ENDLESS CRASH & REMOVE PARALLAX
// ============================================================================

const Patch54 = {
init: () => {
console.log("Patch v54: Fixing Endless Mode Crash & Resetting Camera");

// 1. REPARAR EL ELEMENTO HTML FALTANTE (CRASH FIX)
// El error "Cannot set properties of null" ocurr√≠a porque 'game-night-num' fue borrado.
// Aqu√≠ lo restauramos antes de que el juego intente usarlo.
const hudNight = document.getElementById('hud-night');
if (hudNight) {
// Verificamos si la estructura est√° rota
if (!document.getElementById('game-night-num')) {
// Restaurar estructura original vital para Game.startLevel
hudNight.innerHTML = '<span id="lbl-night">NOCHE</span> <span id="game-night-num">1</span>';
}
}

// 2. CORREGIR L√ìGICA DE ENDLESS MODE
// Sobrescribimos la funci√≥n para que NO rompa el HTML de nuevo.
if (typeof EndlessMode !== 'undefined') {
EndlessMode.start = function() {
// Restaurar estructura por si acaso
const hn = document.getElementById('hud-night');
if(!document.getElementById('game-night-num')) {
hn.innerHTML = '<span id="lbl-night">NOCHE</span> <span id="game-night-num">1</span>';
}

if (confirm(v50.texts[Lang.current].desc_endless)) {
v50.state.isEndless = true;
v50.state.endlessTimer = 0;

// Iniciamos el juego normalmente.
// Game.startLevel escribir√° "ENDLESS" en el ID 'game-night-num' sin crashear.
Game.startSequence('ENDLESS', { maifer:5, isaac:5, jomar:5, richard:5, golden:0 });

// Solo cambiamos el color visualmente
setTimeout(() => {
const num = document.getElementById('game-night-num');
if(num) num.style.color = "cyan";
}, 500);
}
};
}

// 3. DESACTIVAR MOVIMIENTO DE C√ÅMARA (PARALLAX OFF)
// Sobrescribimos el sistema de movimiento para que no haga nada.
if (typeof ParallaxSys !== 'undefined') {
ParallaxSys.update = function() {
// Funci√≥n vac√≠a: Desactiva la l√≥gica de movimiento
return;
};
// Remover el evento por si acaso
document.removeEventListener('mousemove', ParallaxSys.update);
}

// Forzar reset de estilos inmediatos JS
const off = document.getElementById('view-office');
if(off) {
off.style.transform = 'none';
off.style.width = '100%';
off.style.left = '0';
}
}
};

// Ejecutar parche inmediatamente y con un peque√±o delay para asegurar
Patch54.init();
setTimeout(Patch54.init, 1000);

</script>
--- END OF PATCH v54.0 ---
</body>
</html>
