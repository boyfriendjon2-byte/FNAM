<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maifer's Factory: The 8 Nights</title>
    <style>
        /* ==========================================================================
           ESTILOS
           ========================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nosifer&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC&display=swap');

        :root { --primary: #ff0000; --bg-dark: #050505; }
        * { box-sizing: border-box; user-select: none; touch-action: none; cursor: crosshair; }
        body { margin: 0; background: var(--bg-dark); color: #ccc; font-family: 'Share Tech Mono', monospace; overflow: hidden; height: 100vh; }

        /* PANTALLAS */
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; z-index: 10; }
        .screen.active { display: flex; }

        /* MENU */
        #screen-menu { background: radial-gradient(circle at center, #1a0505, #000); }
        .title-text { font-family: 'Nosifer'; font-size: 3.5rem; color: var(--primary); text-shadow: 2px 2px 0 #fff; text-align: center; animation: glitch 3s infinite; }
        .menu-btn {
            background: rgba(0,0,0,0.8); border: 2px solid #444; color: #aaa;
            padding: 10px 20px; font-family: 'VT323'; font-size: 1.5rem; margin: 5px;
            cursor: pointer; text-transform: uppercase; transition: 0.2s; width: 340px; position: relative;
        }
        .menu-btn:hover:not(.locked) { border-color: var(--primary); color: #fff; background: #220000; }
        .menu-btn.locked { opacity: 0.5; cursor: not-allowed; }
        .icon-lock { position: absolute; right: 10px; }
        #lang-btn { position: absolute; top: 20px; left: 20px; width: auto; min-width: 80px; font-family: 'VT323'; font-size: 1.2rem; z-index: 200; }

        /* ESTRELLAS */
        #star-row { display: flex; gap: 5px; margin-bottom: 20px; height: 30px; }
        .star { font-size: 2rem; color: #111; }
        .star.earned { color: gold; text-shadow: 0 0 10px gold; }

        /* MODALES */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #0b0b0b; border: 2px solid var(--primary); width: 800px; max-width: 90%; max-height: 90vh; overflow-y: auto; padding: 20px; color: #fff; }
        .lore-text { font-family: 'Share Tech Mono'; white-space: pre-wrap; text-align: left; line-height: 1.4; color: #0f0; font-size: 0.9rem; }
        .lore-header { color: var(--primary); font-family: 'Nosifer'; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }

        /* JUEGO */
        #view-office { position: absolute; inset: 0; background: #111 url('https://www.transparenttextures.com/patterns/dark-concrete.png'); }
        #hallway { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 300px; height: 600px; background: #000; border: 30px solid #0d0d0d; overflow: hidden; }
        #window-frame { position: absolute; top: 20%; right: 10%; width: 220px; height: 300px; background: #050505; border: 8px solid #222; overflow: hidden; }
        #curtain { 
            width: 100%; height: 100%; background: repeating-linear-gradient(180deg, #151515, #151515 20px, #222 20px, #222 22px); 
            transition: transform 0.3s ease-in-out; transform: translateY(-85%); position: relative; z-index: 5; border-bottom: 10px solid #444;
        }
        #curtain.closed { transform: translateY(0%); }
        #richard-eyes { position: absolute; top: 40%; left: 25%; width: 50%; display: flex; justify-content: space-between; z-index: 2; opacity: 0; transition: opacity 0.5s; }
        .eye { width: 20px; height: 20px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 15px #00ff00; }

        /* GEN PANEL */
        #gen-panel { position: absolute; bottom: 220px; left: 20px; width: 150px; height: 200px; background: #222; border: 4px solid #444; z-index: 40; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #gen-fan { width: 80px; height: 80px; border-radius: 50%; border: 5px dashed #555; animation: spin 4s linear infinite; margin-bottom: 20px; }
        #gen-btn { width: 40px; height: 40px; background: radial-gradient(circle, #ff5555, #990000); border: 2px solid #fff; border-radius: 50%; cursor: pointer; position: absolute; box-shadow: 0 0 10px red; }

        /* HUD */
        #hud-time { position: fixed; top: 20px; right: 20px; font-size: 3rem; font-family: 'VT323'; color: #fff; z-index: 150; }
        #hud-night { position: fixed; top: 20px; right: 150px; font-size: 1.5rem; font-family: 'VT323'; color: #aaa; z-index: 150; }
        #hud-power { position: fixed; bottom: 20px; left: 20px; font-size: 1.5rem; font-family: 'VT323'; color: #fff; z-index: 150; }
        #hud-toxic { position: fixed; top: 20px; left: 20px; width: 150px; height: 10px; border: 1px solid #0f0; z-index: 150; display: none; }
        #toxic-bar { height: 100%; background: #0f0; width: 0%; }

        /* LAYERS */
        #layer-mask { position: fixed; inset: 0; z-index: 100; display: none; pointer-events: none; background: radial-gradient(circle at center, transparent 30%, rgba(0,20,0,0.8) 60%, #000 95%); box-shadow: inset 0 0 100px #000; }
        #layer-flashlight { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.3) 0%, transparent 60%); z-index: 50; display: none; mix-blend-mode: overlay; pointer-events: none; }
        #layer-under-desk { position: fixed; inset: 0; background: #000; z-index: 90; display: none; align-items: flex-end; justify-content: center; border-top: 150px solid #1a0f0b; }
        
        .anim-img { position: absolute; pointer-events: none; display: none; z-index: 20; filter: brightness(0.6); }
        #vis-maifer { right: 5%; bottom: 0; height: 85vh; }
        #vis-isaac { left: 5%; bottom: 0; height: 90vh; }
        #vis-jomar { left: 50%; bottom: 0; transform: translateX(-50%); height: 80vh; z-index: 4; }

        /* MONITOR */
        #screen-monitor { position: fixed; inset: 0; background: #111; z-index: 200; display: none; flex-direction: column; padding: 20px; }
        #cam-view { flex: 1; background: #000; border: 2px solid #333; position: relative; display: flex; align-items: center; justify-content: center; }
        #cam-static { position: absolute; inset: 0; opacity: 0.15; background: url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif'); pointer-events: none; }
        #map-controls { height: 100px; display: flex; justify-content: center; gap: 10px; background: #050505; padding: 10px; margin-top: 10px; }
        .cam-select { width: 60px; height: 40px; background: #002; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-family: 'VT323'; margin-top: 20px; }
        .cam-select.active { background: #0f0; color: #000; }

        /* MESA */
        #desk { position: absolute; bottom: 0; width: 100%; height: 180px; background: linear-gradient(#251812, #000); z-index: 30; display: flex; justify-content: center; align-items: flex-end; border-top: 5px solid #422; }
        .monitor-btn { width: 400px; background: #111; color: #0f0; border: 2px solid #0f0; border-bottom: 0; font-family: 'VT323'; font-size: 2rem; cursor: pointer; }
        .monitor-btn:hover { background: #002200; height: 60px; }

        /* MINIJUEGO */
        #screen-minigame { background: #000; }
        #mg-canvas { background: #111; border: 2px solid #444; box-shadow: 0 0 20px #222; max-width: 100%; }
        #mg-info { color: #fff; font-family: 'VT323'; font-size: 1.5rem; margin-bottom: 10px; text-align: center; }
        #mg-controls-hint { color: #888; margin-top: 10px; font-size: 0.9rem; }

        /* JUMPSCARE & GAME OVER */
        #screen-jumpscare { z-index: 9600; background: #000; }
        #jump-img { width: 100%; height: 100%; object-fit: cover; animation: shake 0.2s infinite; }
        #screen-gameover { z-index: 9500; background: #000; flex-direction: row; gap: 30px; }
        #death-card { width: 300px; border: 2px solid #500; background: #100; padding: 10px; text-align: center; }
        
        .setting-row { margin: 15px 0; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        input[type=range] { width: 150px; cursor: pointer; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        @keyframes shake { 0% { transform: translate(5px, 5px); } 25% { transform: translate(-5px, -5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, 5px); } }
    </style>
</head>
<body>

<div id="audio-container">
    <audio id="bgm-menu" src="start_song.mp3" loop></audio>
    <audio id="bgm-game" src="abandoned_factory.mp3" loop></audio>
    <audio id="sfx-win" src="digital_alarm_clock.mp3"></audio>
    <audio id="sfx-monitor" src="opening_the_monitor.mp3"></audio>
    <audio id="sfx-cam" src="changing_camera.mp3"></audio>
    <audio id="sfx-curtain" src="closing_the_curtain.mp3"></audio>
    <audio id="sfx-leave" src="entity_go_away.mp3"></audio>
    <audio id="sfx-mask" src="mask_breathing.mp3" loop></audio>
    <audio id="sfx-hide" src="moving_to_hide_under.mp3"></audio>
    <audio id="sfx-flash" src="turn_on_the_flashlig.mp3"></audio>
    <audio id="voice-1" src="phone_girl.mp3"></audio>
    <audio id="voice-2" src="phone_girl2.mp3"></audio>
    <audio id="sfx-maifer" src="maifer_aparece.mp3"></audio>
    <audio id="sfx-isaac" src="isaac_aparece.mp3"></audio>
    <audio id="sfx-jomar" src="jomar_aparece.mp3"></audio>
    
    <!-- JUMPSCARES RENOMBRADOS -->
    <audio id="jump-richard" src="richard_jumpscare.mp3"></audio>
    <audio id="jump-jomar" src="jomar_jumpscare.mp3"></audio>
    <audio id="jump-isaac" src="isaac_jumpscare.mp3"></audio>
    <audio id="jump-maifer" src="maifer_mata.mp3"></audio>
    <audio id="sfx-gen" src="turn_on_the_light.mp3"></audio> 
</div>

<div id="screen-menu" class="screen active">
    <button id="lang-btn" class="menu-btn" onclick="Lang.toggle()">ESPANOL</button>
    <h1 class="title-text">MAIFER'S<br>FACTORY</h1>
    <div id="star-row"></div>
    <div style="display: flex; flex-direction: column;">
        <button id="btn-play" class="menu-btn" onclick="Game.initNight()">JUGAR (NOCHE <span id="menu-night">1</span>)</button>
        <button id="btn-custom" class="menu-btn locked" onclick="Game.initCustom()" disabled>CUSTOM NIGHT <span class="icon-lock">üîí</span></button>
        <button id="btn-new" class="menu-btn" onclick="Game.newGame()">NUEVA PARTIDA</button>
        <button id="btn-lore" class="menu-btn" onclick="UI.openLore()">DATOS / LORE</button>
        <button id="btn-settings" class="menu-btn" onclick="UI.openSettings()">AJUSTES / CONTROLES</button>
    </div>
    <p style="position: absolute; bottom: 10px; font-size: 0.8rem; color: #444;">v4.0 - Lore Update</p>
</div>

<div id="modal-lore" class="modal-overlay">
    <div class="modal-box">
        <h2 id="lore-title" class="lore-header">MAIFER'S FACTORY ‚Äî LORE OFICIAL</h2>
        <div id="lore-content" class="lore-text">...</div>
        <button id="btn-close-lore" class="menu-btn" onclick="UI.closeModals()" style="width: 100%; margin-top:20px;">CERRAR</button>
    </div>
</div>

<div id="modal-settings" class="modal-overlay">
    <div class="modal-box" style="height: auto;">
        <h2 id="st-title">AJUSTES</h2>
        <div class="setting-row">
            <span id="st-vol">VOLUMEN</span>
            <input type="range" min="0" max="100" value="100" oninput="AudioSys.setVolume(this.value)">
        </div>
        <h3 id="st-ctrl">CONTROLES</h3>
        <p><span id="lbl-mask">M√ÅSCARA:</span> <b id="bind-mask">SPACE</b> <button onclick="Input.rebind('mask')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
        <p><span id="lbl-flash">LINTERNA:</span> <b id="bind-flash">F</b> <button onclick="Input.rebind('flash')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
        <p><span id="lbl-hide">ESCONDERSE:</span> <b id="bind-hide">CTRL</b> <button onclick="Input.rebind('hide')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
        <p><span id="lbl-curtain">CORTINA:</span> <b id="bind-curtain">S</b> <button onclick="Input.rebind('curtain')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
        <p><span id="lbl-mon">MONITOR:</span> <b id="bind-monitor">TAB</b> <button onclick="Input.rebind('monitor')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
        <button id="btn-save-st" class="menu-btn" onclick="UI.closeModals()">GUARDAR Y CERRAR</button>
    </div>
</div>

<div id="screen-game" class="screen">
    <div id="hud-time">12 AM</div>
    <div id="hud-night"><span id="lbl-night">NOCHE</span> <span id="game-night-num">1</span></div>
    <div id="hud-power"><span id="lbl-pwr">PWR</span>: <span id="pwr-val">100</span>%</div>
    <div id="hud-toxic"><div id="toxic-bar"></div></div>

    <div id="view-office">
        <div id="hallway"><img id="vis-jomar" class="anim-img" src="jomar.png"></div>
        <div id="window-frame">
            <div id="richard-eyes"><div class="eye"></div><div class="eye"></div></div>
            <div id="curtain" onclick="Mechanics.toggleCurtain()"></div>
        </div>
        <img id="vis-isaac" class="anim-img" src="isaac.png">
        <img id="vis-maifer" class="anim-img" src="maifer.png">
        
        <div id="gen-panel">
            <div id="gen-fan"></div>
            <button id="gen-btn" onclick="Mechanics.chargeGen()"></button>
        </div>

        <div id="desk">
            <button id="btn-cam-sys" class="monitor-btn" onclick="Mechanics.toggleMonitor()">[ SYSTEM ]</button>
        </div>
    </div>

    <div id="layer-mask"></div>
    <div id="layer-flashlight"></div>
    <div id="layer-under-desk"><h2 id="lbl-under">DEBAJO DE LA MESA</h2></div>

    <div id="screen-monitor">
        <div style="color:#fff;"><span id="lbl-sys">SYSTEM</span>: CAM <span id="cam-id">01</span></div>
        <div id="cam-view">
            <div id="cam-static"></div>
            <h1 style="color:#333;">NO SIGNAL</h1>
        </div>
        <div id="map-controls">
            <button class="cam-select" onclick="Monitor.setCam(1)">01</button>
            <button class="cam-select" onclick="Monitor.setCam(2)">02</button>
            <button class="cam-select" onclick="Monitor.setCam(3)">03</button>
            <button class="cam-select" onclick="Mechanics.toggleMonitor()">X</button>
        </div>
    </div>
</div>

<div id="screen-8am" class="screen" style="background:#000;">
    <h1 style="font-family:'VT323'; font-size:6rem; color:#0f0;">8:00 AM</h1>
    <p id="lbl-win" style="color:#fff;">TURNO FINALIZADO.</p>
</div>

<div id="screen-minigame" class="screen">
    <div id="mg-info">MINIJUEGO</div>
    <canvas id="mg-canvas" width="600" height="400"></canvas>
    <div id="mg-controls-hint">Instrucciones aqu√≠</div>
</div>

<div id="screen-gameover" class="screen">
    <div id="death-card">
        <h1 style="color:red; font-family:'Nosifer';">GAME OVER</h1>
        <img id="death-img" src="screen_death.png" style="width:100%; border:1px solid #333;">
        <p id="death-reason" style="color:#fff;">...</p>
    </div>
    <button id="btn-menu-go" class="menu-btn" onclick="location.reload()">MEN√ö</button>
</div>

<div id="screen-jumpscare" class="screen">
    <img id="jump-img" src="">
</div>

<script>
/* ==========================================================================
   IDIOMAS Y DATA
   ========================================================================== */
const LORE_ES = `üìñ MAIFER‚ÄôS FACTORY ‚Äî LORE OFICIAL

Maifer‚Äôs Factory es una antigua f√°brica industrial dedicada al desarrollo de robots de vigilancia y asistencia mec√°nica. El lugar pertenece a Michael Boyko, conocido √∫nicamente como Mr. Boyko, un empresario reservado que rara vez aparece en p√∫blico.

Durante a√±os, la f√°brica funcion√≥ con normalidad, pero con el tiempo la mayor√≠a de los empleados abandonaron el lugar. Los turnos nocturnos fueron los primeros en desaparecer. Desde entonces, la f√°brica opera casi exclusivamente con robots.

Ante la falta de personal, Mr. Boyko comenz√≥ a publicar anuncios buscando guardias nocturnos. El trabajo parec√≠a simple: vigilar la f√°brica durante la noche, controlar las c√°maras, administrar la energ√≠a del generador y evitar que los robots sufran da√±os hasta las 8:00 AM.
El salario es alto. Las condiciones, vagas. El contrato, inquietantemente corto.

üë§ EL PROTAGONISTA
Aceptas el trabajo por necesidad. No te explican por qu√© el puesto se renueva tan seguido. No te dicen qu√© ocurri√≥ con los anteriores guardias. Solo una advertencia: "No interfieras con los animatr√≥nicos. Sigue los protocolos."

‚òéÔ∏è LA CHICA DEL TEL√âFONO
Cada noche recibes una llamada de una mujer que trabaja ‚Äîo trabaj√≥‚Äî en la f√°brica. Nunca dice su nombre. Su tono cambia con el paso de las noches: Al principio intenta tranquilizarte. Luego se queja de los animatr√≥nicos. M√°s adelante parece cansada, frustrada‚Ä¶ casi resignada.

ü§ñ LOS ROBOTS
üü° MAIFER (El Prototipo): Agresivo. Maifer fue el primer robot que Mr. Boyko decidi√≥ no desactivar jam√°s.
üé≠ ISAAC (Experimental): Detecta rostros. La m√°scara lo enga√±a. Sin ella, Isaac act√∫a como si el guardia fuera una amenaza.
üî¶ JOMAR (Oscuridad): Odia la luz. Permanece cerca, esperando que la luz falle.
üü• RICHARD (Contenci√≥n): Unidad de contenci√≥n. Solo puede ser detenido bajando la cortina a tiempo.

‚ö° EL GENERADOR
La f√°brica funciona con un sistema de energ√≠a limitado. El generador debe recargarse manualmente. Si la energ√≠a se agota, los protocolos de seguridad fallan.

üß† MR. BOYKO
Para √©l, la noche no era un turno. Era una evaluaci√≥n. Sobrevivir hasta las 8:00 AM no significa que ganaste. Significa que fuiste tolerado.`;

const LORE_EN = `üìñ MAIFER‚ÄôS FACTORY ‚Äî OFFICIAL LORE

Maifer‚Äôs Factory is an old industrial facility dedicated to the development of surveillance robots. The place belongs to Michael Boyko, a reserved businessman who rarely appears in public.

For years, the factory operated normally, but over time most employees left. Night shifts were the first to disappear. Since then, the factory operates almost exclusively with robots.

Facing a staff shortage, Mr. Boyko began posting ads for night guards. The job seemed simple: watch the factory, check cameras, manage generator power, and prevent robot damage until 8:00 AM.
The salary is high. The conditions, vague. The contract, disturbingly short.

üë§ THE PROTAGONIST
You accept the job out of necessity. They don't explain why the position opens up so often. Only one warning: "Do not interfere with the animatronics. Follow protocols."

‚òéÔ∏è THE PHONE GIRL
Every night you receive a call from a woman who works‚Äîor worked‚Äîat the factory. She never says her name. Her tone changes: At first reassuring, then complaining, finally resigned.

ü§ñ THE ROBOTS
üü° MAIFER (Prototype): Aggressive. The first robot Mr. Boyko decided never to deactivate.
üé≠ ISAAC (Experimental): Detects faces. The mask fools him.
üî¶ JOMAR (Darkness): Hates light. Waits for the flashlight to fail.
üü• RICHARD (Containment): Only stopped by the curtain.

‚ö° THE GENERATOR
Power is limited. If it runs out, security protocols fail.

üß† MR. BOYKO
To him, the night wasn't a shift. It was an evaluation. Surviving until 8:00 AM doesn't mean you won. It means you were tolerated.`;

const LORE_CN = `üìñ MAIFER‚ÄôS FACTORY ‚Äî ÂÆòÊñπ‰º†ËØ¥

MaiferÂ∑•ÂéÇÊòØ‰∏ÄÂÆ∂Ëá¥Âäõ‰∫éÂºÄÂèëÁõëÊéßÊú∫Âô®‰∫∫ÁöÑËÄÅÂºèÂ∑•‰∏öËÆæÊñΩ„ÄÇËøô‰∏™Âú∞ÊñπÂ±û‰∫éËøàÂÖãÂ∞î¬∑Âçö‰ºäÁßëÔºàMichael BoykoÔºâÔºåËøôÊòØ‰∏Ä‰ΩçÂæàÂ∞ëÂú®ÂÖ¨‰ºóÈù¢ÂâçÈú≤Èù¢ÁöÑÁ•ûÁßòÂïÜ‰∫∫„ÄÇ

Â§öÂπ¥Êù•ÔºåÂ∑•ÂéÇËøêËΩ¨Ê≠£Â∏∏Ôºå‰ΩÜÈöèÁùÄÊó∂Èó¥ÁöÑÊé®ÁßªÔºåÂ§ßÂ§öÊï∞ÂëòÂ∑•Á¶ªÂºÄ‰∫Ü„ÄÇÂ§úÁè≠ÊòØÊúÄÂÖàÊ∂àÂ§±ÁöÑ„ÄÇ‰ªéÈÇ£Êó∂Ëµ∑ÔºåÂ∑•ÂéÇÂá†‰πéÂÆåÂÖ®Áî±Êú∫Âô®‰∫∫Êìç‰Ωú„ÄÇ

Áî±‰∫éÁº∫‰πè‰∫∫ÊâãÔºåÂçö‰ºäÁßëÂÖàÁîüÂºÄÂßãÂèëÂ∏ÉÂØªÊâæÂ§úÈó¥Ë≠¶Âç´ÁöÑÂπøÂëä„ÄÇÂ∑•‰ΩúÁúãËµ∑Êù•ÂæàÁÆÄÂçïÔºöÁõëËßÜÂ∑•ÂéÇÔºåÊéßÂà∂ÊëÑÂÉèÊú∫ÔºåÁÆ°ÁêÜÂèëÁîµÊú∫ËÉΩÈáèÔºåÂπ∂Âú®Êó©‰∏ä8:00‰πãÂâçÈò≤Ê≠¢Êú∫Âô®‰∫∫ÂèóÊçü„ÄÇ
Ëñ™Ê∞¥ÂæàÈ´ò„ÄÇÊù°‰ª∂Âê´Á≥ä„ÄÇÂêàÂêå‰ª§‰∫∫‰∏çÂÆâÂú∞Áü≠„ÄÇ

üë§ ‰∏ªËßí
‰Ω†Âõ†‰∏∫ÈúÄË¶ÅÊé•Âèó‰∫ÜËøô‰ªΩÂ∑•‰Ωú„ÄÇ‰ªñ‰ª¨Ê≤°ÊúâËß£Èáä‰∏∫‰ªÄ‰πàËøô‰∏™ËÅå‰ΩçÁªèÂ∏∏Êç¢‰∫∫„ÄÇÂè™Êúâ‰∏Ä‰∏™Ë≠¶ÂëäÔºö‚Äú‰∏çË¶ÅÂπ≤Êâ∞ÁîµÂ≠êÊú∫Âô®‰∫∫„ÄÇÈÅµÂÆàÂçèËÆÆ„ÄÇ‚Äù

‚òéÔ∏è ÁîµËØùÂ•≥Â≠©
ÊØèÂ§©Êôö‰∏ä‰Ω†ÈÉΩ‰ºöÊé•Âà∞‰∏Ä‰∏™Âú®Â∑•ÂéÇÂ∑•‰ΩúËøáÁöÑÂ•≥‰∫∫ÁöÑÁîµËØù„ÄÇÂ•π‰ªé‰∏çËØ¥ÂêçÂ≠ó„ÄÇËØ≠Ê∞îÈöèÊó∂Èó¥ÂèòÂåñÔºöËµ∑Âàù‰ª§‰∫∫ÊîæÂøÉÔºåÂêéÊù•Êä±ÊÄ®ÔºåÊúÄÂêéÂá†‰πéÊîæÂºÉ„ÄÇ

ü§ñ Êú∫Âô®‰∫∫
üü° MAIFERÔºàÂéüÂûãÔºâÔºöÂÖ∑ÊúâÊîªÂáªÊÄß„ÄÇ
üé≠ ISAACÔºàÂÆûÈ™åÊÄßÔºâÔºöÊ£ÄÊµãÈù¢ÈÉ®„ÄÇÈù¢ÂÖ∑ÂèØ‰ª•Ê¨∫È™ó‰ªñ„ÄÇ
üî¶ JOMARÔºàÈªëÊöóÔºâÔºöËÆ®ÂéåÂÖâ„ÄÇÁ≠âÂæÖÊâãÁîµÁ≠íÂ§±Êïà„ÄÇ
üü• RICHARDÔºàÈÅèÂà∂ÔºâÔºöÂè™ËÉΩÈÄöËøáÂèäÊó∂Êãâ‰∏ãÁ™óÂ∏òÊù•ÈòªÊ≠¢„ÄÇ

‚ö° ÂèëÁîµÊú∫
Â¶ÇÊûúËÉΩÈáèËÄóÂ∞ΩÔºåÂÆâÂÖ®ÂçèËÆÆÂ∞ÜÂ§±Êïà„ÄÇ

üß† Âçö‰ºäÁßëÂÖàÁîü
ÂØπ‰ªñÊù•ËØ¥ÔºåÂ§úÊôö‰∏çÊòØËΩÆÁè≠„ÄÇËøôÊòØ‰∏Ä‰∏™ËØÑ‰º∞„ÄÇÊ¥ªÂà∞Êó©‰∏ä8:00Âπ∂‰∏çÊÑèÂë≥ÁùÄ‰Ω†Ëµ¢‰∫Ü„ÄÇËøôÊÑèÂë≥ÁùÄ‰Ω†Ë¢´ÂÆπÂøç‰∫Ü„ÄÇ`;

const TEXTS = {
    ES: {
        play: "JUGAR (NOCHE", new: "NUEVA PARTIDA", lore: "DATOS / LORE", st: "AJUSTES", 
        custom: "NOCHE PERSONALIZADA", night: "NOCHE", under: "DEBAJO DE LA MESA", win: "TURNO FINALIZADO",
        g_over: "FIN DEL JUEGO", st_title: "AJUSTES", st_vol: "VOLUMEN", st_ctrl: "CONTROLES",
        btn_close: "CERRAR", btn_save: "GUARDAR Y CERRAR", lore_txt: LORE_ES,
        lbl_mask: "M√ÅSCARA", lbl_flash: "LINTERNA", lbl_hide: "ESCONDERSE", lbl_curtain: "CORTINA", lbl_mon: "MONITOR",
        lbl_sys: "SISTEMA", lbl_pwr: "PODER",
        d_maifer: "Maifer te vio fuera de la mesa.", d_isaac: "Isaac vio tu cara.", d_jomar: "Jomar odia la luz.",
        d_richard: "Richard entr√≥ por la ventana.", d_power: "Sin energ√≠a.", d_air: "Te asfixiaste con la m√°scara.",
        // LORE MINIJUEGOS
        lf_1: "N1: Maifer no olvida. El miedo es registro.",
        lf_2: "N2: Isaac sabe qui√©n eres. No olvida rostros.",
        lf_3: "N3: Sistema controlado por M. Boyko. La energ√≠a decide qui√©n sobrevive.",
        lf_4: "N4: Otros guardias cruzaron antes. La f√°brica recuerda nombres borrados.",
        lf_5: "N5: Jomar responde al miedo. Algo m√°s lo gu√≠a.",
        lf_6: "N6: Richard no busca da√±o. Solo corrige errores.",
        lf_7: "N7: No eres el primero en sobrevivir. Algunos desaparecieron despu√©s.",
        lf_8: "N8: Sobrevivir no significa ganar. La f√°brica elige qui√©n contin√∫a.",
        mg_1: "N1: ESQUIVAR (AG√ÅCHATE)", mg_2: "N2: RECOGE LA M√ÅSCARA", mg_3: "N3: CARGA GENERADOR",
        mg_4: "N4: EVITA LAS SOMBRAS", mg_5: "N5: APUNTA LINTERNA", mg_6: "N6: SECUENCIA CORTINA",
        mg_7: "N7: BUSCA LA LLAVE", mg_8: "N8: SOBREVIVE A TODO"
    },
    EN: {
        play: "PLAY (NIGHT", new: "NEW GAME", lore: "DATA / LORE", st: "SETTINGS",
        custom: "CUSTOM NIGHT", night: "NIGHT", under: "UNDER THE DESK", win: "SHIFT COMPLETED",
        g_over: "GAME OVER", st_title: "SETTINGS", st_vol: "VOLUME", st_ctrl: "CONTROLS",
        btn_close: "CLOSE", btn_save: "SAVE & CLOSE", lore_txt: LORE_EN,
        lbl_mask: "MASK", lbl_flash: "FLASHLIGHT", lbl_hide: "HIDE", lbl_curtain: "CURTAIN", lbl_mon: "MONITOR",
        lbl_sys: "SYSTEM", lbl_pwr: "POWER",
        d_maifer: "Maifer saw you outside.", d_isaac: "Isaac saw your face.", d_jomar: "Jomar hates light.",
        d_richard: "Richard entered.", d_power: "No power.", d_air: "Asphyxiation.",
        lf_1: "N1: Maifer does not forget. Fear is a record.",
        lf_2: "N2: Isaac knows who you are. He never forgets a face.",
        lf_3: "N3: System controlled by M. Boyko. Power decides survival.",
        lf_4: "N4: Others crossed before. The factory remembers deleted names.",
        lf_5: "N5: Jomar responds to fear. Something else guides him.",
        lf_6: "N6: Richard seeks no harm. He only corrects errors.",
        lf_7: "N7: You are not the first. Some disappeared later.",
        lf_8: "N8: Survival is not winning. The factory chooses who remains.",
        mg_1: "N1: DODGE (DUCK)", mg_2: "N2: GET THE MASK", mg_3: "N3: CHARGE GEN",
        mg_4: "N4: AVOID SHADOWS", mg_5: "N5: POINT FLASHLIGHT", mg_6: "N6: CURTAIN SEQ",
        mg_7: "N7: FIND KEY", mg_8: "N8: SURVIVE ALL"
    },
    CN: {
        play: "ÂºÄÂßãÊ∏∏Êàè (Â§ú", new: "Êñ∞Ê∏∏Êàè", lore: "Êï∞ÊçÆ / ‰º†ËØ¥", st: "ËÆæÁΩÆ",
        custom: "Ëá™ÂÆö‰πâÂ§ú", night: "Â§ú", under: "Ê°åÂ≠êÂ∫ï‰∏ã", win: "‰∏ãÁè≠‰∫Ü",
        g_over: "Ê∏∏ÊàèÁªìÊùü", st_title: "ËÆæÁΩÆ", st_vol: "Èü≥Èáè", st_ctrl: "ÊéßÂà∂",
        btn_close: "ÂÖ≥Èó≠", btn_save: "‰øùÂ≠òÂπ∂ÂÖ≥Èó≠", lore_txt: LORE_CN,
        lbl_mask: "Èù¢ÂÖ∑", lbl_flash: "ÊâãÁîµÁ≠í", lbl_hide: "ÈöêËóè", lbl_curtain: "Á™óÂ∏ò", lbl_mon: "ÁõëËßÜÂô®",
        lbl_sys: "Á≥ªÁªü", lbl_pwr: "ÂäüÁéá",
        d_maifer: "MaiferÁúãÂà∞‰∫Ü‰Ω†„ÄÇ", d_isaac: "IsaacÁúãÂà∞‰∫Ü‰Ω†ÁöÑËÑ∏„ÄÇ", d_jomar: "JomarËÆ®ÂéåÂÖâ„ÄÇ",
        d_richard: "RichardËøõÊù•‰∫Ü„ÄÇ", d_power: "ÂÅúÁîµ„ÄÇ", d_air: "Á™íÊÅØ„ÄÇ",
        lf_1: "N1: Maifer‰∏ç‰ºöÂøòËÆ∞„ÄÇÊÅêÊÉßÊòØËÆ∞ÂΩï„ÄÇ",
        lf_2: "N2: IsaacÁü•ÈÅì‰Ω†ÊòØË∞Å„ÄÇ‰ªñ‰ªé‰∏çÂøòËÆ∞‰∏ÄÂº†ËÑ∏„ÄÇ",
        lf_3: "N3: Á≥ªÁªüÁî±M. BoykoÊéßÂà∂„ÄÇËÉΩÈáèÂÜ≥ÂÆöÁîüÂ≠ò„ÄÇ",
        lf_4: "N4: ÂÖ∂‰ªñ‰∫∫‰ª•ÂâçÁ©øËøá„ÄÇÂ∑•ÂéÇËÆ∞ÂæóÂà†Èô§ÁöÑÂêçÂ≠ó„ÄÇ",
        lf_5: "N5: JomarÂØπÊÅêÊÉßÊúâÂèçÂ∫î„ÄÇÂà´ÁöÑ‰∏úË•øÂú®ÂºïÂØº‰ªñ„ÄÇ",
        lf_6: "N6: Richard‰∏çÂØªÊ±Ç‰º§ÂÆ≥„ÄÇ‰ªñÂè™Á∫†Ê≠£ÈîôËØØ„ÄÇ",
        lf_7: "N7: ‰Ω†‰∏çÊòØÁ¨¨‰∏Ä‰∏™„ÄÇÊúâ‰∫õ‰∫∫ÂêéÊù•Â§±Ë∏™‰∫Ü„ÄÇ",
        lf_8: "N8: ÁîüÂ≠ò‰∏çÊòØËÉúÂà©„ÄÇÂ∑•ÂéÇÈÄâÊã©Ë∞ÅÁïô‰∏ã„ÄÇ",
        mg_1: "N1: Ë∫≤ÈÅø (Ëπ≤‰∏ã)", mg_2: "N2: ÊãøÈù¢ÂÖ∑", mg_3: "N3: ÂÖÖÁîµÂèëÁîµÊú∫",
        mg_4: "N4: ÈÅøÂºÄÈò¥ÂΩ±", mg_5: "N5: ÊåáÂêëÊâãÁîµÁ≠í", mg_6: "N6: Á™óÂ∏òÂ∫èÂàó",
        mg_7: "N7: ÊâæÈí•Âåô", mg_8: "N8: ÂÖ®ÈÉ®ÁîüÂ≠ò"
    }
};

const Lang = {
    current: 'ES',
    toggle: () => {
        const order = ['ES', 'EN', 'CN'];
        let idx = order.indexOf(Lang.current);
        Lang.current = order[(idx + 1) % 3];
        Lang.apply();
    },
    apply: () => {
        const t = TEXTS[Lang.current];
        const n = document.getElementById('menu-night').innerText;
        
        document.getElementById('lang-btn').innerText = Lang.current === 'CN' ? '‰∏≠Êñá' : (Lang.current === 'ES' ? 'ESPA√ëOL' : 'ENGLISH');
        document.getElementById('btn-play').innerHTML = `${t.play} <span id="menu-night">${n}</span>)`;
        document.getElementById('btn-new').innerText = t.new;
        document.getElementById('btn-lore').innerText = t.lore;
        document.getElementById('btn-settings').innerText = t.st;
        document.getElementById('btn-custom').childNodes[0].nodeValue = t.custom + " "; 
        
        document.getElementById('lore-content').innerText = t.lore_txt;
        document.getElementById('btn-close-lore').innerText = t.btn_close;
        
        document.getElementById('st-title').innerText = t.st_title;
        document.getElementById('st-vol').innerText = t.st_vol;
        document.getElementById('st-ctrl').innerText = t.st_ctrl;
        document.getElementById('btn-save-st').innerText = t.btn_save;

        // AJUSTES LABELS
        document.getElementById('lbl-mask').innerText = t.lbl_mask;
        document.getElementById('lbl-flash').innerText = t.lbl_flash;
        document.getElementById('lbl-hide').innerText = t.lbl_hide;
        document.getElementById('lbl-curtain').innerText = t.lbl_curtain;
        document.getElementById('lbl-mon').innerText = t.lbl_mon;

        // HUD / GAME
        document.getElementById('lbl-night').innerText = t.night;
        document.getElementById('lbl-pwr').innerText = t.lbl_pwr;
        document.getElementById('lbl-sys').innerText = t.lbl_sys;
        document.getElementById('btn-cam-sys').innerText = `[ ${t.lbl_sys} ]`;
        document.getElementById('lbl-under').innerText = t.under;
        document.getElementById('lbl-win').innerText = t.win;
    }
};

const SAVEDATA = JSON.parse(localStorage.getItem('mf_save_v4') || '{"night":1, "stars":{}, "binds":null}');
const BINDINGS = SAVEDATA.binds || { mask: 'Space', flash: 'KeyF', hide: 'ControlLeft', curtain: 'KeyS', monitor: 'Tab' };
const NIGHT_CONFIG = {
    1: { maifer: 3, isaac: 0, jomar: 0, richard: 0, power: 100 },
    2: { maifer: 4, isaac: 4, jomar: 0, richard: 0, power: 100 },
    3: { maifer: 5, isaac: 5, jomar: 3, richard: 0, power: 95 },
    4: { maifer: 8, isaac: 8, jomar: 5, richard: 4, power: 90 },
    5: { maifer: 10, isaac: 10, jomar: 8, richard: 8, power: 85 },
    6: { maifer: 15, isaac: 12, jomar: 12, richard: 12, power: 85 },
    7: { maifer: 18, isaac: 15, jomar: 15, richard: 15, power: 80 },
    8: { maifer: 20, isaac: 20, jomar: 20, richard: 20, power: 75 },
    9: { maifer: 20, isaac: 20, jomar: 20, richard: 20, power: 100 }
};

/* ==========================================================================
   LOGICA DEL JUEGO
   ========================================================================== */
const AudioSys = {
    volume: 1.0,
    setVolume: (val) => {
        AudioSys.volume = val / 100;
        document.querySelectorAll('audio').forEach(a => a.volume = AudioSys.volume);
    },
    play: (id, loop=false) => {
        const s = document.getElementById(id);
        if(s){ s.loop = loop; s.volume = AudioSys.volume; s.currentTime = 0; s.play().catch(()=>{}); }
    },
    stopAll: () => document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime=0; })
};

const Input = {
    rebind: (action) => {
        const btn = document.getElementById('bind-' + action);
        btn.innerText = "...";
        const handler = (e) => {
            e.preventDefault();
            BINDINGS[action] = e.code;
            btn.innerText = e.code;
            SAVEDATA.binds = BINDINGS;
            localStorage.setItem('mf_save_v4', JSON.stringify(SAVEDATA));
            document.removeEventListener('keydown', handler);
        };
        document.addEventListener('keydown', handler);
    }
};

document.addEventListener('keydown', (e) => {
    if (Game.state.over || UI.modalOpen || Game.state.inMinigame) return;
    const k = e.code;
    if (k === BINDINGS.mask) Mechanics.toggleMask();
    if (k === BINDINGS.flash) Mechanics.toggleFlashlight();
    if (k === BINDINGS.hide) Mechanics.toggleHide();
    if (k === BINDINGS.curtain) Mechanics.toggleCurtain();
    if (k === BINDINGS.monitor) Mechanics.toggleMonitor();
});

const Game = {
    state: { night: 1, power: 100, time: 0, over: false, view: 'office', mask: false, hidden: false, curtain: false, flash: false, toxic: 0, inMinigame: false },
    timers: {}, ai: {},

    initMenu: () => {
        document.getElementById('menu-night').innerText = SAVEDATA.night;
        const row = document.getElementById('star-row');
        row.innerHTML = '';
        if(SAVEDATA.night > 6) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 7) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 8) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        const cnBtn = document.getElementById('btn-custom');
        if(SAVEDATA.night > 8) { cnBtn.disabled = false; cnBtn.classList.remove('locked'); cnBtn.querySelector('.icon-lock').style.display = 'none'; }
        for(let k in BINDINGS) { const el = document.getElementById('bind-'+k); if(el) el.innerText = BINDINGS[k]; }
        Lang.apply();
        AudioSys.play('bgm-menu', true);
    },
    newGame: () => { if(confirm("DELETE DATA?")) { localStorage.removeItem('mf_save_v4'); location.reload(); } },
    initNight: () => { Game.startLevel(SAVEDATA.night > 8 ? 8 : SAVEDATA.night); },
    initCustom: () => { Game.startLevel(9); },
    startLevel: (n) => {
        Game.state = { night: n, power: NIGHT_CONFIG[n].power, time: 0, over: false, view: 'office', mask: false, hidden: false, curtain: false, flash: false, toxic: 0, inMinigame: false };
        Game.ai = { ...NIGHT_CONFIG[n], pos: { maifer:0, isaac:0, jomar:0, richard:0 } };
        document.getElementById('game-night-num').innerText = n;
        UI.showScreen('screen-game');
        AudioSys.stopAll();
        AudioSys.play('bgm-game', true);
        if(n < 3) AudioSys.play(n===1 ? 'voice-1' : 'voice-2');
        document.getElementById('curtain').classList.remove('closed');
        document.getElementById('layer-mask').style.display = 'none';
        document.getElementById('layer-flashlight').style.display = 'none';
        document.getElementById('layer-under-desk').style.display = 'none';
        document.getElementById('toxic-bar').style.width = '0%';
        document.querySelectorAll('.anim-img').forEach(i => i.style.display = 'none');
        document.getElementById('richard-eyes').style.opacity = 0;
        Mechanics.moveGenButton();
        Game.timers.main = setInterval(Game.loop, 100);
        Game.timers.ai = setInterval(Game.aiLoop, 2000);
    },
    loop: () => {
        if(Game.state.over || Game.state.inMinigame) return;
        Game.state.time += 0.12; 
        let hour = 12 + Math.floor(Game.state.time / 12.5); if(hour > 12) hour -= 12;
        document.getElementById('hud-time').innerText = (hour === 0 ? 12 : hour) + " AM";
        if(Game.state.time >= 100) { Game.reach8AM(); return; }
        
        let drain = 0.04;
        if(Game.state.mask) drain += 0.04;
        if(Game.state.flash) drain += 0.08;
        if(Game.state.view === 'monitor') drain += 0.12;
        if(Game.state.curtain) drain += 0.1;
        Game.state.power -= drain;
        document.getElementById('pwr-val').innerText = Math.floor(Game.state.power);
        if(Game.state.power <= 0) { Game.die('power'); return; }

        if(Game.state.mask) { Game.state.toxic += 0.3; document.getElementById('hud-toxic').style.display = 'block'; } 
        else { Game.state.toxic = Math.max(0, Game.state.toxic - 0.2); if(Game.state.toxic <= 0) document.getElementById('hud-toxic').style.display = 'none'; }
        document.getElementById('toxic-bar').style.width = Game.state.toxic + "%";
        if(Game.state.toxic >= 100) { Game.die('air'); return; }
        if(Game.ai.pos.richard === 1) document.getElementById('richard-eyes').style.opacity = Game.state.curtain ? 0 : 1;
    },
    aiLoop: () => {
        if(Game.state.over) return;
        const rng = (lvl) => (Math.random() * 20) < lvl;
        
        if(rng(Game.ai.maifer)) {
            Game.ai.pos.maifer++;
            if(Game.ai.pos.maifer === 5) {
                AudioSys.play('sfx-maifer');
                document.getElementById('vis-maifer').style.display = 'block';
                setTimeout(() => {
                    if(!Game.state.hidden) Game.die('maifer');
                    else { AudioSys.play('sfx-leave'); document.getElementById('vis-maifer').style.display = 'none'; Game.ai.pos.maifer = 0; }
                }, 3000);
            }
        }
        if(rng(Game.ai.isaac)) {
            Game.ai.pos.isaac++;
            if(Game.ai.pos.isaac === 5) {
                AudioSys.play('sfx-isaac');
                document.getElementById('vis-isaac').style.display = 'block';
                setTimeout(() => {
                    if(!Game.state.mask) Game.die('isaac');
                    else { AudioSys.play('sfx-leave'); document.getElementById('vis-isaac').style.display = 'none'; Game.ai.pos.isaac = 0; }
                }, 3500);
            }
        }
        if(rng(Game.ai.jomar)) {
            if(Game.ai.pos.jomar === 0) { Game.ai.pos.jomar = 1; document.getElementById('vis-jomar').style.display = 'block'; AudioSys.play('sfx-jomar'); } 
            else if(Math.random() > 0.7) Game.die('jomar');
        }
        if(rng(Game.ai.richard)) {
            if(Game.ai.pos.richard === 0) { Game.ai.pos.richard = 1; if(!Game.state.curtain) document.getElementById('richard-eyes').style.opacity = 1; }
            else if (Game.ai.pos.richard === 1) {
                if(Game.state.curtain) { if(Math.random() > 0.4) { AudioSys.play('sfx-leave'); Game.ai.pos.richard = 0; document.getElementById('richard-eyes').style.opacity = 0; } }
                else { Game.ai.pos.richard++; if(Game.ai.pos.richard > 3) Game.die('richard'); }
            }
        }
    },
    die: (causeKey) => {
        Game.state.over = true;
        clearInterval(Game.timers.main); clearInterval(Game.timers.ai); AudioSys.stopAll();
        const js = document.getElementById('screen-jumpscare');
        const img = document.getElementById('jump-img');
        js.style.display = 'flex';
        let src="maifer.png", snd="jump-maifer";
        if(causeKey === 'maifer') { src="maifer.png"; snd="jump-maifer"; }
        if(causeKey === 'isaac') { src="isaac.png"; snd="jump-isaac"; }
        if(causeKey === 'jomar') { src="jomar.png"; snd="jump-jomar"; }
        if(causeKey === 'richard') { src="maifer.png"; snd="jump-richard"; } 
        img.src = src; AudioSys.play(snd);
        setTimeout(() => {
            js.style.display = 'none'; UI.showScreen('screen-gameover');
            document.getElementById('death-reason').innerText = TEXTS[Lang.current]['d_'+causeKey] || "GAME OVER";
        }, 2000);
    },
    reach8AM: () => {
        Game.state.over = true; clearInterval(Game.timers.main); clearInterval(Game.timers.ai); AudioSys.stopAll();
        UI.showScreen('screen-8am'); AudioSys.play('sfx-win');
        setTimeout(() => { if(Game.state.night < 9) MiniGames.start(Game.state.night); else location.reload(); }, 4000);
    }
};

const Mechanics = {
    canAct: (isTurningOff) => {
        if(isTurningOff) return true;
        let count = 0;
        if(Game.state.mask) count++; if(Game.state.view === 'monitor') count++;
        if(Game.state.flash) count++; if(Game.state.curtain) count++; if(Game.state.hidden) count++;
        return count < 2; 
    },
    toggleMonitor: () => { if(Game.state.over || Game.state.hidden) return; const m = document.getElementById('screen-monitor'); if(Game.state.view==='monitor') { m.style.display='none'; Game.state.view='office'; } else { if(!Mechanics.canAct(false)) return; m.style.display='flex'; Game.state.view='monitor'; AudioSys.play('sfx-monitor'); } },
    toggleMask: () => { if(Game.state.view !== 'office') return; if(Game.state.mask) { Game.state.mask = false; document.getElementById('layer-mask').style.display = 'none'; AudioSys.stopAll(); } else { if(!Mechanics.canAct(false)) return; Game.state.mask = true; document.getElementById('layer-mask').style.display = 'block'; AudioSys.play('sfx-mask', true); } },
    toggleFlashlight: () => { if(Game.state.view !== 'office') return; if(Game.state.flash) { Game.state.flash = false; document.getElementById('layer-flashlight').style.display = 'none'; } else { if(!Mechanics.canAct(false)) return; Game.state.flash = true; document.getElementById('layer-flashlight').style.display = 'block'; AudioSys.play('sfx-flash'); if(Game.ai.pos.jomar === 1) { Game.ai.pos.jomar = 0; document.getElementById('vis-jomar').style.display = 'none'; AudioSys.play('sfx-leave'); } } },
    toggleCurtain: () => { if(Game.state.view !== 'office') return; if(Game.state.curtain) { Game.state.curtain = false; } else { if(!Mechanics.canAct(false)) return; Game.state.curtain = true; AudioSys.play('sfx-curtain'); } document.getElementById('curtain').classList.toggle('closed', Game.state.curtain); },
    toggleHide: () => { if(Game.state.view !== 'office') return; if(Game.state.hidden) { Game.state.hidden = false; document.getElementById('layer-under-desk').style.display = 'none'; } else { if(!Mechanics.canAct(false)) return; Game.state.hidden = true; document.getElementById('layer-under-desk').style.display = 'flex'; AudioSys.play('sfx-hide'); } },
    moveGenButton: () => { const btn = document.getElementById('gen-btn'); btn.style.left = Math.random()*90 + 'px'; btn.style.top = Math.random()*140 + 'px'; btn.style.display = 'block'; },
    chargeGen: () => { if(Game.state.over) return; Game.state.power = Math.min(100, Game.state.power + 5); document.getElementById('pwr-val').innerText = Math.floor(Game.state.power); AudioSys.play('sfx-gen'); document.getElementById('gen-btn').style.display = 'none'; setTimeout(Mechanics.moveGenButton, 3000 + Math.random()*5000); }
};

const Monitor = { setCam: (id) => { document.getElementById('cam-id').innerText = "0"+id; document.querySelectorAll('.cam-select').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); AudioSys.play('sfx-cam'); } };

/* ==========================================================================
   MINIJUEGOS 1-8
   ========================================================================== */
const MiniGames = {
    active: false, night: 0, ctx: null, 
    player: {}, enemies: [], target: {}, state: {}, frame: 0,
    
    start: (n) => {
        Game.state.inMinigame = true; MiniGames.night = n; MiniGames.active = true; MiniGames.frame = 0;
        UI.showScreen('screen-minigame');
        const c = document.getElementById('mg-canvas'); MiniGames.ctx = c.getContext('2d');
        const t = TEXTS[Lang.current];
        document.getElementById('mg-info').innerText = t['mg_'+n] || "MINIGAME";
        document.getElementById('mg-controls-hint').innerText = "Arrows/Mouse/Space";
        MiniGames.initLogic(n);
        requestAnimationFrame(MiniGames.loop);
        document.onkeydown = MiniGames.handleInput; c.onmousedown = MiniGames.handleClick;
    },
    initLogic: (n) => {
        const w=600, h=400;
        MiniGames.enemies = [];
        if(n===1) { // Under desk - Side scroller dodge
            MiniGames.player = {x:50, y:300, w:30, h:30, duck:false};
            MiniGames.enemies = [{x:600, y:280, w:40, h:60, spd:4}];
        } else if(n===2) { // Mask Maze
            MiniGames.player = {x:20, y:20, w:20, h:20};
            MiniGames.target = {x:550, y:350, w:30, h:30, active:true}; // Mask
            MiniGames.enemies = [{x:100,y:0,h:300,dir:1},{x:300,y:100,h:300,dir:-1},{x:500,y:0,h:300,dir:1}];
        } else if(n===3) { // Gen Click
            MiniGames.state = {score:0};
            MiniGames.spawnClickTarget();
        } else if(n===4) { // Shadows dodge
            MiniGames.player = {x:50, y:200, w:20, h:20};
            MiniGames.enemies = []; // Spawns in loop
        } else if(n===5) { // Flashlight
            MiniGames.player = {x:300, y:350, w:0, h:0}; // static view
            MiniGames.enemies = [{x:300, y:0, r:20, spd:1}]; // Jomar approaches
        } else if(n===6) { // Curtain Sequence
            MiniGames.state = {seq:[1,2,3,4], cur:0, timer:500};
        } else if(n===7) { // Key find dodge
            MiniGames.player = {x:300, y:200, w:20, h:20};
            MiniGames.target = {x:Math.random()*500, y:Math.random()*300, w:20, h:20};
            MiniGames.enemies = [];
        } else if(n===8) { // Survival
             MiniGames.player = {x:300, y:200, w:20, h:20};
             MiniGames.state = {timer: 1000};
        }
    },
    spawnClickTarget: () => { MiniGames.enemies.push({x:Math.random()*560+20, y:Math.random()*360+20, r:15, life:80}); },
    loop: () => {
        if(!MiniGames.active) return;
        const ctx = MiniGames.ctx; ctx.fillStyle = '#111'; ctx.fillRect(0,0,600,400);
        MiniGames.frame++;
        const n = MiniGames.night;

        if(n===1) {
            ctx.fillStyle = MiniGames.player.duck ? '#050' : '#0f0';
            ctx.fillRect(MiniGames.player.x, MiniGames.player.duck?320:300, 30, MiniGames.player.duck?15:30);
            MiniGames.enemies.forEach(e => {
                e.x -= e.spd; ctx.fillStyle = '#f00'; ctx.fillRect(e.x, e.y, e.w, e.h);
                if(e.x < -50) { e.x = 650; e.spd = 4+Math.random()*3; }
                // Colision: Si toca y no esta agachado
                if(MiniGames.col(MiniGames.player, e) && !MiniGames.player.duck) MiniGames.lose();
            });
            if(MiniGames.frame > 1000) MiniGames.win();
        }
        else if(n===2) {
            ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20);
            ctx.fillStyle = '#00f'; ctx.fillRect(MiniGames.target.x, MiniGames.target.y, 30, 30);
            MiniGames.enemies.forEach(e => {
                ctx.fillStyle = '#500'; ctx.fillRect(e.x, e.y, 20, e.h);
                if(MiniGames.col(MiniGames.player, {x:e.x,y:e.y,w:20,h:e.h})) MiniGames.lose();
            });
            if(MiniGames.col(MiniGames.player, MiniGames.target)) MiniGames.win();
        }
        else if(n===3) {
            ctx.fillStyle = '#fff'; ctx.fillText("Power: "+MiniGames.state.score+"/10", 20, 30);
            MiniGames.enemies.forEach((e,i) => {
                e.life--; ctx.fillStyle='#0f0'; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,6.28); ctx.fill();
                if(e.life<=0) { MiniGames.enemies.splice(i,1); MiniGames.spawnClickTarget(); }
            });
            if(MiniGames.state.score >= 10) MiniGames.win();
        }
        else if(n===4) { // Shadows
            ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20);
            if(MiniGames.frame % 30 === 0) MiniGames.enemies.push({x:600, y:Math.random()*380, w:40, h:40, spd:5});
            MiniGames.enemies.forEach((e,i) => {
                e.x-=e.spd; ctx.fillStyle='rgba(100,0,0,0.5)'; ctx.fillRect(e.x,e.y,e.w,e.h);
                if(MiniGames.col(MiniGames.player, e)) MiniGames.lose();
            });
            if(MiniGames.frame > 1200) MiniGames.win();
        }
        else if(n===5) { // Flashlight
            ctx.fillStyle = '#0f0'; ctx.fillText("PRESS F / CLICK", 250, 350);
            const e = MiniGames.enemies[0];
            e.y += e.spd; 
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(300, e.y, e.r, 0, 6.28); ctx.fill();
            if(e.y > 350) MiniGames.lose();
            if(MiniGames.frame > 1000) MiniGames.win();
        }
        else if(n===6) { // Curtain
            ctx.fillStyle = '#fff'; ctx.fillText("WAIT...", 280, 200);
            MiniGames.state.timer--;
            ctx.fillStyle = 'red'; ctx.fillRect(0,0, 600, (500-MiniGames.state.timer)/2);
            if(MiniGames.state.timer <= 0) MiniGames.lose();
            // Win condition is abstract via input
            if(MiniGames.state.cur >= 4) MiniGames.win();
        }
        else if(n===7 || n===8) { // Survival / Key
             ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20);
             if(n===7) { ctx.fillStyle='gold'; ctx.fillRect(MiniGames.target.x, MiniGames.target.y, 20, 20); }
             if(MiniGames.frame % 20 === 0) MiniGames.enemies.push({x:Math.random()*600, y:0, w:10, h:10, vy:3});
             MiniGames.enemies.forEach(e => {
                 e.y+=e.vy; ctx.fillStyle='#f00'; ctx.fillRect(e.x,e.y,e.w,e.h);
                 if(MiniGames.col(MiniGames.player,e)) MiniGames.lose();
             });
             if(n===7 && MiniGames.col(MiniGames.player, MiniGames.target)) MiniGames.win();
             if(n===8 && MiniGames.frame > 1500) MiniGames.win();
        }

        requestAnimationFrame(MiniGames.loop);
    },
    col: (r1,r2) => (r1.x < r2.x+r2.w && r1.x+r1.w > r2.x && r1.y < r2.y+r2.h && r1.y+r1.h > r2.y),
    handleInput: (e) => {
        if(!MiniGames.active) return;
        const k=e.code, p=MiniGames.player;
        if(MiniGames.night===1) {
            if(k==='ArrowLeft') p.x-=20; if(k==='ArrowRight') p.x+=20;
            if(k==='ArrowDown') p.duck=true; if(k==='ArrowUp') p.duck=false;
        } else if(MiniGames.night===5) {
            if(k==='KeyF' || k==='Space') MiniGames.enemies[0].y -= 20; // Flash pushes back
        } else if(MiniGames.night===6) {
             if(k==='Space') MiniGames.state.cur++; // Spam space to hold curtain
        } else {
            if(k==='ArrowLeft') p.x-=15; if(k==='ArrowRight') p.x+=15;
            if(k==='ArrowUp') p.y-=15; if(k==='ArrowDown') p.y+=15;
        }
    },
    handleClick: (e) => {
        if(MiniGames.night===3) {
             const r = MiniGames.canvas.getBoundingClientRect();
             const mx = e.clientX-r.left, my = e.clientY-r.top;
             MiniGames.enemies.forEach((t,i) => {
                 if(Math.sqrt((mx-t.x)**2+(my-t.y)**2) < t.r) { MiniGames.state.score++; MiniGames.enemies.splice(i,1); MiniGames.spawnClickTarget(); }
             });
        }
    },
    win: () => {
        MiniGames.active=false;
        const n = MiniGames.night;
        const txt = TEXTS[Lang.current]['lf_'+n] || "LORE FOUND.";
        alert(txt);
        SAVEDATA.night = parseInt(n)+1; SAVEDATA.stars[n]=true;
        localStorage.setItem('mf_save_v4', JSON.stringify(SAVEDATA));
        location.reload();
    },
    lose: () => { MiniGames.active=false; alert("FAIL."); location.reload(); }
};

const UI = {
    modalOpen: false,
    showScreen: (id) => { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); },
    openLore: () => { document.getElementById('modal-lore').style.display = 'flex'; UI.modalOpen = true; },
    openSettings: () => { document.getElementById('modal-settings').style.display = 'flex'; UI.modalOpen = true; },
    closeModals: () => { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); UI.modalOpen = false; }
};

Game.initMenu();
</script>
</body>
</html>
