<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maifer's Factory: The 8 Nights (v12.5 Lore Update)</title>
    <style>
        /* ==========================================================================
           ESTILOS Y FUENTES
           ========================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nosifer&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root { 
            --primary: #ff0000; 
            --bg-dark: #050505; 
            --hud-bg: rgba(0, 20, 0, 0.85);
            --hud-border: #446644;
        }

        * { box-sizing: border-box; user-select: none; touch-action: none; cursor: crosshair; -webkit-tap-highlight-color: transparent; }
        
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-dark); color: #ccc; font-family: 'Share Tech Mono', monospace; overflow: hidden; }

        /* PANTALLAS */
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; z-index: 10; width: 100%; height: 100%; }
        .screen.active { display: flex; }

        /* MENU PRINCIPAL */
        #screen-menu { 
            background: #000 url('https://www.transparenttextures.com/patterns/dark-matter.png');
            position: relative; overflow: hidden;
        }
        #screen-menu::before {
            content: " "; display: block; position: absolute; inset: 0; pointer-events: none; z-index: 2;
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 2px, 3px 100%;
        }
        .title-text { 
            font-family: 'Nosifer'; font-size: 4.5rem; color: var(--primary); text-shadow: 4px 4px 0 #500; 
            text-align: center; animation: glitch 4s infinite; margin-bottom: 30px; z-index: 5; 
        }
        .menu-btn {
            background: rgba(10, 0, 0, 0.9); border: 2px solid #600; color: #aaa;
            padding: 10px 20px; font-family: 'VT323'; font-size: 1.5rem; margin: 5px;
            cursor: pointer; text-transform: uppercase; transition: 0.3s; width: 380px; 
            position: relative; z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .menu-btn:hover:not(.locked) { border-color: var(--primary); color: #fff; background: #400; transform: scale(1.05); }
        .menu-btn.locked { opacity: 0.4; cursor: not-allowed; border-color: #333; filter: grayscale(1); }
        .icon-lock { position: absolute; right: 15px; }
        
        #lang-btn { position: absolute; top: 30px; left: 30px; width: auto; min-width: 80px; font-family: 'VT323'; font-size: 1.4rem; z-index: 200; border-color: #444; }
        #btn-leaderboard { position: absolute; top: 30px; right: 30px; width: auto; font-family: 'VT323'; font-size: 1.4rem; z-index: 200; background: #002244; border-color: #0088ff; color: #0088ff; }
        #credits-text { position: absolute; bottom: 10px; left: 20px; z-index: 20; font-family: 'Share Tech Mono'; font-size: 0.9rem; color: #00aaff; text-shadow: 0 0 5px #00aaff; }

        /* ESTRELLAS */
        #star-row { display: flex; gap: 8px; margin-bottom: 20px; height: 35px; z-index: 5; }
        .star { font-size: 2rem; color: #222; }
        .star.earned { color: gold; text-shadow: 0 0 10px gold; }
        .star.blue { color: #0088ff; text-shadow: 0 0 15px #0088ff; }

        /* MODALES */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .modal-box { 
            background: linear-gradient(135deg, #0d0d0d, #050505); border: 2px solid var(--primary); 
            width: 800px; max-width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; color: #fff; 
            box-shadow: 0 0 50px rgba(255,0,0,0.2); border-radius: 5px;
        }
        .lore-text { font-family: 'Share Tech Mono'; white-space: pre-wrap; text-align: left; line-height: 1.6; color: #0f0; font-size: 1rem; }
        .lore-header { color: var(--primary); font-family: 'Nosifer'; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 25px; text-align: center; }
        .update-list { text-align: left; font-family: 'VT323'; color: #ccc; padding-left: 20px; }
        .update-list li { margin-bottom: 8px; font-size: 1.3rem; list-style-type: square; }
        .teaser-text { color: red; font-family: 'Nosifer'; text-align: center; margin-top: 40px; animation: glitch 2s infinite; font-size: 1.5rem; }

        /* AJUSTES */
        .setting-section { border: 1px solid #333; background: rgba(255,255,255,0.02); padding: 15px; margin-bottom: 15px; }
        .setting-header { color: #aaa; font-family: 'Nosifer'; font-size: 1.2rem; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .setting-row { margin: 15px 0; display: flex; align-items: center; justify-content: space-between; width: 100%; font-family: 'VT323'; font-size: 1.4rem; }
        input[type=range] { width: 150px; cursor: pointer; accent-color: var(--primary); }
        input[type=checkbox] { transform: scale(1.5); cursor: pointer; accent-color: var(--primary); }

        /* CUSTOM NIGHT */
        #screen-custom { background: #111; overflow-y: auto; padding: 20px; }
        .cn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .cn-char { background: #000; border: 2px solid #444; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .cn-img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; border: 1px solid #333; }
        .cn-controls { display: flex; align-items: center; gap: 15px; }
        .cn-btn { width: 40px; height: 40px; background: #333; color: #fff; border: 1px solid #666; cursor: pointer; font-size: 1.5rem; }
        .cn-val { font-family: 'VT323'; font-size: 2.5rem; color: #fff; width: 50px; text-align: center; }

        /* JUEGO (TEXTURAS) */
        #view-office { 
            position: absolute; inset: 0; background-color: #111;
            background-image: radial-gradient(circle at center, transparent 30%, #000 130%), url('https://www.transparenttextures.com/patterns/dark-concrete.png'), url('https://www.transparenttextures.com/patterns/wall-4-light.png');
            background-blend-mode: multiply; overflow: hidden; 
        }
        #layer-flicker { position: fixed; inset: 0; background: #000; opacity: 0; pointer-events: none; z-index: 80; }
        
        #hallway { 
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 320px; height: 620px; 
            background: #000; border: 30px solid #1a1a1a; 
            border-image: linear-gradient(to right, #111, #333, #555, #222) 1;
            box-shadow: inset 0 0 50px #000; overflow: hidden; 
        }
        #window-frame { 
            position: absolute; top: 20%; right: 8%; width: 240px; height: 320px; 
            background: #050505; border: 10px solid #222; border-right: 10px solid #444; border-bottom: 10px solid #111;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.8); overflow: hidden; z-index: 5; 
        }
        #curtain { 
            width: 100%; height: 100%; background: repeating-linear-gradient(180deg, #151515, #151515 20px, #202020 20px, #202020 22px); 
            transition: transform 0.2s ease-in-out; transform: translateY(-85%); position: relative; z-index: 10; border-bottom: 15px solid #333; cursor: pointer;
        }
        #curtain.closed { transform: translateY(0%); }
        
        /* RICHARD EYES (NORMAL) */
        #richard-eyes { 
            position: absolute; top: 35%; left: 50%; transform: translateX(-50%); width: 160px; height: 160px; 
            background: #000; box-shadow: 0 0 30px #000; display: flex; justify-content: space-between; align-items: center; 
            padding: 40px; z-index: 6; opacity: 0; transition: opacity 0.1s; 
        }
        .eye { width: 20px; height: 20px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 15px #00ff00; }

        /* VENTILACION */
        #vent-system {
            position: absolute; top: 30%; left: 0; width: 160px; height: 210px; background: #0a0a0a; border: 8px solid #222; border-left: none;
            box-shadow: 5px 5px 15px #000; z-index: 35; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        }
        #vent-grill { width: 100%; height: 100%; background: repeating-linear-gradient(45deg, rgba(20,20,20,0.9) 10px, transparent 10px, transparent 18px); position: relative; z-index: 4; pointer-events: none; border: 2px solid #111; }
        #vent-door {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2a2a2a; transform: translateY(-100%);
            transition: transform 0.2s; border-bottom: 5px solid #444; z-index: 5;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.2) 20px);
        }
        #vent-door.closed { transform: translateY(0); }
        #vent-img { position: absolute; top: 20px; left: 20px; width: 100px; height: 100px; z-index: 1; display: none; filter: brightness(0.5); object-fit: contain; }
        #vent-btn { width: 100%; height: 40px; background: #600; color: #fff; border: none; font-family: 'VT323'; cursor: pointer; z-index: 6; border-top: 4px solid #800; font-size: 1.1rem; }
        #vent-btn.active { background: #006600; border-top: 4px solid #008800; }

        /* GENERADOR */
        #gen-panel { position: absolute; bottom: 230px; left: 190px; width: 140px; height: 190px; background: #1a1a1a; border: 6px solid #333; z-index: 40; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #gen-fan { width: 80px; height: 80px; border-radius: 50%; border: 5px dashed #555; animation: spin 4s linear infinite; margin-bottom: 20px; background: #000; }
        #gen-btn { width: 40px; height: 40px; background: radial-gradient(circle, #ff5555, #990000); border: 2px solid #fff; border-radius: 50%; cursor: pointer; position: absolute; box-shadow: 0 0 10px red; }

        /* MESA */
        #desk { 
            position: absolute; bottom: 0; width: 100%; height: 180px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.9)), url('https://www.transparenttextures.com/patterns/wood-pattern.png'), #2d2d2d;
            z-index: 30; display: flex; justify-content: center; align-items: flex-end; border-top: 8px solid #111; 
            box-shadow: inset 0 20px 30px rgba(0,0,0,0.8);
        }
        .monitor-btn { width: 400px; background: #111; color: #0f0; border: 2px solid #0f0; border-bottom: 0; font-family: 'VT323'; font-size: 2rem; cursor: pointer; }
        .monitor-btn:hover { background: #002200; height: 60px; }

        /* HUD */
        .hud-container { position: fixed; background: var(--hud-bg); border: 2px solid var(--hud-border); padding: 10px 20px; color: #fff; font-family: 'VT323'; z-index: 150; border-radius: 4px; backdrop-filter: blur(2px); }
        #hud-time-box { top: 20px; right: 20px; text-align: right; }
        #hud-time { font-size: 3.5rem; line-height: 0.9; color: #eeffee; text-shadow: 0 0 10px #0f0; }
        #hud-night { font-size: 1.5rem; color: #aaccaa; }
        #hud-power-box { bottom: 20px; left: 20px; width: 220px; }
        #hud-power-text { font-size: 1.8rem; margin-bottom: 5px; color: #eeffee; }
        #hud-usage { display: flex; gap: 5px; align-items: center; font-size: 1.2rem; color: #aaccaa; }
        .usage-block { width: 25px; height: 10px; background: #222; border: 1px solid #444; }
        .usage-block.active { background: #0f0; box-shadow: 0 0 5px #0f0; border-color: #0f0; }
        .usage-block.high { background: #ff0000; box-shadow: 0 0 5px #ff0000; border-color: #ff0000; }
        #hud-toxic { position: fixed; top: 20px; left: 20px; width: 200px; height: 15px; border: 2px solid #004400; background: #001100; z-index: 150; display: none; }
        #toxic-bar { height: 100%; background: #0f0; width: 0%; box-shadow: 0 0 10px #0f0; }
        #btn-mute { position: absolute; top: 120px; left: 20px; background: #222; color: #fff; border: 1px solid #555; font-family: 'VT323'; cursor: pointer; z-index: 160; padding: 5px 10px; opacity: 0.8; font-size: 1.2rem; }

        /* MOBILE CONTROLS */
        #mobile-controls {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.9); z-index: 200; display: none; 
            justify-content: space-around; align-items: center; border-top: 2px solid #333;
        }
        .mob-btn {
            width: 18%; height: 60px; background: #222; border: 2px solid #555;
            color: #fff; font-family: 'VT323'; font-size: 1.2rem; border-radius: 5px;
        }
        .mob-btn:active, .mob-btn.active { background: #555; border-color: var(--primary); }

        /* LAYERS */
        #layer-mask { position: fixed; inset: 0; z-index: 100; display: none; pointer-events: none; background: radial-gradient(circle at center, transparent 30%, rgba(0,20,0,0.8) 60%, #000 95%); box-shadow: inset 0 0 100px #000; }
        #layer-flashlight { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.3) 0%, transparent 60%); z-index: 50; display: none; mix-blend-mode: overlay; pointer-events: none; }
        #layer-under-desk { 
            position: fixed; inset: 0; z-index: 90; display: none; align-items: center; justify-content: center; 
            background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.9) 60%, #000 95%);
            animation: breathing 4s infinite ease-in-out;
        }
        #layer-under-desk h2 { font-family: 'Share Tech Mono'; color: #444; background: #000; padding: 5px 10px; border: 1px solid #333; font-size: 1.2rem; margin-top: 300px; }
        .anim-img { position: absolute; pointer-events: none; display: none; z-index: 20; filter: brightness(0.6); }
        #vis-maifer { right: 5%; bottom: 0; height: 85vh; }
        #vis-isaac { left: 5%; bottom: 0; height: 90vh; }
        #vis-jomar { left: 50%; bottom: 0; transform: translateX(-50%); height: 80vh; z-index: 4; }

        /* MONITOR */
        #screen-monitor { position: fixed; inset: 0; background: #111; z-index: 200; display: none; flex-direction: column; padding: 10px; }
        #cam-view { flex: 2; background: #000; border: 4px solid #333; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 10px; }
        #cam-static { position: absolute; inset: 0; opacity: 0.15; background: url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif'); pointer-events: none; z-index: 5; }
        #cam-content { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2; flex-direction: column; }
        .cam-spot { font-family: 'Share Tech Mono'; color: #fff; font-size: 1.5rem; border: 2px solid #fff; background: rgba(0,0,0,0.5); padding: 10px; margin: 10px; width: auto; text-align: center; }
        .cam-spot.active-anim { color: #f00; border-color: #f00; background: rgba(50,0,0,0.5); animation: glitch 1s infinite; }
        #map-layout { height: 250px; background: #051505; border: 2px solid #0f0; position: relative; margin-top: 10px; box-shadow: inset 0 0 20px #002200; }
        .map-room { position: absolute; border: 2px solid #004400; background: rgba(0, 50, 0, 0.3); }
        #room-06 { top: 10px; left: 35%; width: 30%; height: 60px; }
        #room-04 { top: 80px; left: 10%; width: 35%; height: 80px; }
        #room-05 { top: 80px; right: 10%; width: 35%; height: 80px; }
        #room-02 { top: 170px; left: 20%; width: 25%; height: 70px; }
        #room-03 { top: 170px; right: 20%; width: 25%; height: 70px; }
        #room-you { bottom: 0px; left: 45%; width: 10%; height: 20px; border-bottom: none; background: #200; color:#f00; font-size: 0.8rem; text-align: center; }
        .cam-btn { position: absolute; width: 40px; height: 30px; background: #002200; border: 1px solid #0f0; color: #0f0; font-family: 'VT323'; font-size: 1rem; cursor: pointer; z-index: 10; }
        .cam-btn:hover { background: #004400; }
        .cam-btn.active { background: #0f0; color: #000; animation: blink 1s infinite; }
        #btn-c6 { top: 25px; left: 48%; }
        #btn-c4 { top: 105px; left: 20%; }
        #btn-c5 { top: 105px; right: 20%; }
        #btn-c2 { top: 190px; left: 30%; }
        #btn-c3 { top: 190px; right: 30%; }
        #btn-c1 { bottom: 25px; left: 48%; }
        #btn-close-mon { position: absolute; bottom: 10px; right: 10px; background: #f00; color: #fff; border: 2px solid #fff; padding: 5px 10px; font-family: 'VT323'; cursor: pointer; }

        /* MINIJUEGOS */
        #screen-minigame { background: #000; }
        #mg-canvas { background: #111; border: 2px solid #444; box-shadow: 0 0 20px #222; max-width: 100%; cursor: default; }
        #mg-info { color: #fff; font-family: 'VT323'; font-size: 1.5rem; margin-bottom: 10px; text-align: center; }
        #mg-controls-hint { color: #888; margin-top: 10px; font-size: 0.9rem; }

        /* WIN / GAME OVER */
        #screen-win { background: #000; text-align: center; }
        #win-msg { color: #00aaff; font-family: 'Share Tech Mono'; font-size: 1.2rem; max-width: 600px; margin: 20px; line-height: 1.5; }
        #screen-gameover { z-index: 9500; background: #050000; flex-direction: row; gap: 50px; background-image: url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif'); background-blend-mode: overlay; background-size: cover; }
        #death-card { width: 400px; border: 4px solid #500; background: #100; padding: 20px; text-align: center; box-shadow: 0 0 50px #500; transform: rotate(-2deg); }
        #death-card h1 { font-size: 3rem; margin: 0 0 20px 0; text-shadow: 2px 2px #000; animation: glitch 1s infinite; }
        #death-img { border: 2px solid #300; filter: contrast(1.2) sepia(0.5); }
        #screen-jumpscare { z-index: 9600; background: #000; display: none; align-items: center; justify-content: center; }
        #jump-img { width: 100%; height: 100%; object-fit: cover; animation: shake 0.2s infinite; }

        /* RICHARD JUMPSCARE CSS */
        #js-richard {
            display: none; width: 100%; height: 100%; background: #000;
            justify-content: center; align-items: center;
            animation: zoomShake 0.2s infinite;
        }
        #richard-box {
            width: 80vw; height: 80vw; max-width: 500px; max-height: 500px;
            background: #000; border: 5px solid #111;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 0 100px #00ff00;
        }
        .r-eye-scare {
            width: 80px; height: 80px; background: #0f0; border-radius: 50%;
            box-shadow: 0 0 50px #0f0;
        }

        @keyframes breathing { 0% { transform: scale(1); opacity: 0.95; } 50% { transform: scale(1.02); opacity: 1; } 100% { transform: scale(1); opacity: 0.95; } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        @keyframes shake { 0% { transform: translate(5px, 5px); } 25% { transform: translate(-5px, -5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, 5px); } }
        @keyframes flickerAnim { 0% { opacity: 0; } 10% { opacity: 0.95; background:#000; } 20% { opacity: 0.1; } 30% { opacity: 0.95; background:#000; } 40% { opacity: 0; } 50% { opacity: 0.8; } 100% { opacity: 0; } }
        @keyframes zoomShake { 0% { transform: scale(1) translate(10px,10px); } 50% { transform: scale(1.1) translate(-10px,-10px); } }
        .flickering { animation: flickerAnim 0.8s linear; }

        @media (max-width: 768px) {
            .title-text { font-size: 2.5rem; }
            .menu-btn { width: 90%; font-size: 1.2rem; }
            #hallway { width: 260px; height: 500px; top: 10%; }
            #window-frame { width: 150px; height: 200px; right: 2%; top: 15%; }
            #screen-gameover { flex-direction: column; }
            #death-card { width: 90%; }
            #gen-panel { left: 20px; bottom: 100px; transform: scale(0.8); }
            #map-layout { height: 180px; }
            #hud-time { font-size: 2rem; }
            #hud-night { font-size: 1rem; }
        }
    </style>
</head>
<body>

<!-- AUDIO -->
<div id="audio-container">
    <audio id="bgm-menu" src="start_song.mp3" loop></audio>
    <audio id="bgm-game" src="abandoned_factory.mp3" loop></audio>
    <audio id="bgm-minigame" src="mini_juego.mp3" loop></audio>
    <audio id="bgm-night9" src="night_9.mp3" loop></audio>
    <audio id="sfx-win" src="digital_alarm_clock.mp3"></audio>
    <audio id="sfx-monitor" src="opening_the_monitor.mp3"></audio>
    <audio id="sfx-cam" src="changing_camera.mp3"></audio>
    <audio id="sfx-curtain" src="closing_the_curtain.mp3"></audio>
    <audio id="sfx-leave" src="entity_go_away.mp3"></audio>
    <audio id="sfx-mask" src="mask_breathing.mp3" loop></audio>
    <audio id="sfx-hide" src="moving_to_hide_under.mp3"></audio>
    <audio id="sfx-flash" src="turn_on_the_flashlig.mp3"></audio>
    <audio id="voice-1" src="phone_girl.mp3"></audio>
    <audio id="voice-2" src="phone_girl2.mp3"></audio>
    <audio id="sfx-maifer" src="maifer_aparece.mp3" loop></audio>
    <audio id="sfx-isaac" src="isaac_aparece.mp3" loop></audio>
    <audio id="sfx-jomar" src="jomar_aparece.mp3" loop></audio>
    <audio id="jump-richard" src="richard_jumpscare.mp3"></audio>
    <audio id="jump-jomar" src="jomar_jumpscare.mp3"></audio>
    <audio id="jump-isaac" src="isaac_jumpscare.mp3"></audio>
    <audio id="jump-maifer" src="maifer_mata.mp3"></audio>
    <audio id="sfx-gen" src="turn_on_the_light.mp3"></audio>
    <audio id="sfx-gameover" src="game_over.mp3"></audio>
</div>

<!-- MENU -->
<div id="screen-menu" class="screen active">
    <button id="lang-btn" class="menu-btn" onclick="Lang.toggle()">ESPANOL</button>
    <button id="btn-leaderboard" class="menu-btn" style="width:auto;" onclick="UI.openLeaderboard()">üèÜ RANK</button>
    <h1 class="title-text">MAIFER'S<br>FACTORY</h1>
    <div id="star-row"></div>
    <div style="display: flex; flex-direction: column;">
        <button id="btn-play" class="menu-btn" onclick="Game.initNight()">JUGAR (NOCHE <span id="menu-night">1</span>)</button>
        <button id="btn-custom" class="menu-btn locked" onclick="Game.initCustomSetup()" disabled>CUSTOM NIGHT <span class="icon-lock">üîí</span></button>
        <button id="btn-new" class="menu-btn" onclick="Game.newGame()">NUEVA PARTIDA</button>
        <button id="btn-lore" class="menu-btn" onclick="UI.openLore()">DATOS / LORE</button>
        <button id="btn-updates" class="menu-btn" onclick="UI.openUpdates()">UPDATES</button>
        <button id="btn-settings" class="menu-btn" onclick="UI.openSettings()">AJUSTES</button>
    </div>
    <p style="position: absolute; bottom: 10px; font-size: 0.8rem; color: #444;">v12.5 - Lore Update</p>
    <p id="credits-text">Creado por Jonlet Santos</p>
</div>

<!-- MODALES -->
<div id="modal-lore" class="modal-overlay">
    <div class="modal-box">
        <h2 id="lore-title" class="lore-header">MAIFER'S FACTORY ‚Äî LORE OFICIAL</h2>
        <div id="lore-content" class="lore-text"></div>
        <button id="btn-close-lore" class="menu-btn" onclick="UI.closeModals()" style="width: 100%; margin-top:20px;">CERRAR</button>
    </div>
</div>

<div id="modal-updates" class="modal-overlay">
    <div class="modal-box">
        <h2 class="lore-header">UPDATES LOG</h2>
        <ul id="update-list" class="update-list"></ul>
        <h2 id="teaser-text" class="teaser-text"></h2>
        <button id="btn-close-upd" class="menu-btn" onclick="UI.closeModals()" style="width: 100%; margin-top:20px;">CERRAR</button>
    </div>
</div>

<div id="modal-settings" class="modal-overlay">
    <div class="modal-box" style="height: auto;">
        <h2 id="st-title">AJUSTES</h2>
        <div class="setting-section">
            <div id="st-h-aud" class="setting-header">AUDIO</div>
            <div class="setting-row"><span id="st-vol">VOLUMEN</span><input type="range" min="0" max="100" value="100" oninput="AudioSys.setVolume(this.value)"></div>
        </div>
        <div class="setting-section">
            <div id="st-h-gfx" class="setting-header">GR√ÅFICOS Y SISTEMA</div>
            <div class="setting-row"><span id="st-full">PANTALLA COMPLETA</span><button class="menu-btn" style="width: auto; font-size: 1rem;" onclick="Config.toggleFullscreen()">TOGGLE</button></div>
            <div class="setting-row"><span id="st-gli">EFECTO GLITCH</span><input type="checkbox" id="chk-glitch" checked onchange="Config.toggleGlitch()"></div>
            <div class="setting-row"><span id="st-sens">SENSIBILIDAD</span><input type="range" min="1" max="10" value="5"></div>
            <div class="setting-row"><span id="st-del" style="color: red;">BORRAR DATOS</span><button class="menu-btn" style="width: auto; font-size: 1rem; border-color: red; color: red;" onclick="Game.newGame()">RESET</button></div>
        </div>
        <div class="setting-section">
            <div id="st-h-ctrl" class="setting-header">CONTROLES</div>
            <p><span id="lbl-mask">M√ÅSCARA:</span> <b id="bind-mask">SPACE</b> <button onclick="Input.rebind('mask')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
            <p><span id="lbl-flash">LINTERNA:</span> <b id="bind-flash">F</b> <button onclick="Input.rebind('flash')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
            <p><span id="lbl-hide">ESCONDERSE:</span> <b id="bind-hide">CTRL</b> <button onclick="Input.rebind('hide')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
            <p><span id="lbl-curtain">CORTINA:</span> <b id="bind-curtain">S</b> <button onclick="Input.rebind('curtain')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
            <p><span id="lbl-mon">MONITOR:</span> <b id="bind-monitor">TAB</b> <button onclick="Input.rebind('monitor')" class="menu-btn" style="width:auto; font-size:1rem;">EDIT</button></p>
        </div>
        <button id="btn-save-st" class="menu-btn" onclick="UI.closeModals()">GUARDAR Y CERRAR</button>
    </div>
</div>

<div id="modal-leaderboard" class="modal-overlay">
    <div class="modal-box">
        <h2 id="lb-title" class="lore-header">TOP SURVIVORS</h2>
        <ul id="lb-list" class="update-list"></ul>
        <div id="lb-input" style="display:none; margin-top:20px;">
            <p>¬°NOCHE 8 COMPLETADA!</p>
            <input type="text" id="inp-name" placeholder="YOUR NAME" style="font-family:'VT323'; font-size:1.5rem; width:200px;">
            <button class="menu-btn" style="width:auto;" onclick="Leaderboard.add()">SAVE</button>
        </div>
        <button class="menu-btn" onclick="UI.closeModals()">CERRAR</button>
    </div>
</div>

<!-- CUSTOM NIGHT SCREEN -->
<div id="screen-custom" class="screen">
    <h1 class="title-text" style="font-size: 2.5rem;">CUSTOM NIGHT</h1>
    <div class="cn-grid">
        <div class="cn-char"><img src="maifer.png" class="cn-img"><span style="color:#fff;">MAIFER</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('maifer',-1)">-</button><div id="val-maifer" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('maifer',1)">+</button></div></div>
        <div class="cn-char"><img src="isaac.png" class="cn-img"><span style="color:#fff;">ISAAC</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('isaac',-1)">-</button><div id="val-isaac" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('isaac',1)">+</button></div></div>
        <div class="cn-char"><img src="jomar.png" class="cn-img"><span style="color:#fff;">JOMAR</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('jomar',-1)">-</button><div id="val-jomar" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('jomar',1)">+</button></div></div>
        <div class="cn-char"><img src="maifer.png" class="cn-img" style="filter:grayscale(1);"><span style="color:#fff;">RICHARD</span><div class="cn-controls"><button class="cn-btn" onclick="CustomNight.adj('richard',-1)">-</button><div id="val-richard" class="cn-val">0</div><button class="cn-btn" onclick="CustomNight.adj('richard',1)">+</button></div></div>
    </div>
    <button id="btn-cn-start" class="menu-btn" onclick="CustomNight.start()">INICIAR</button>
    <button class="menu-btn" style="border-color:red;" onclick="location.reload()">ATRAS</button>
</div>

<!-- JUEGO -->
<div id="screen-game" class="screen">
    <div id="hud-time-box" class="hud-container"><div id="hud-time">12 AM</div><div id="hud-night"><span id="lbl-night">NOCHE</span> <span id="game-night-num">1</span></div></div>
    <div id="hud-power-box" class="hud-container">
        <div id="hud-power-text"><span id="lbl-pwr">PWR</span>: <span id="pwr-val">100</span>%</div>
        <div id="hud-usage">
            <span id="lbl-usage">USAGE</span>: <div id="use-1" class="usage-block"></div><div id="use-2" class="usage-block"></div><div id="use-3" class="usage-block"></div><div id="use-4" class="usage-block"></div>
        </div>
    </div>
    <div id="hud-toxic"><div id="toxic-bar"></div></div>
    <button id="btn-mute" onclick="Mechanics.muteCall()">MUTE CALL üìû</button>

    <div id="view-office">
        <div id="layer-flicker"></div>
        <div id="vent-system">
            <img id="vent-img" src="">
            <div id="vent-grill"></div>
            <div id="vent-door"></div>
            <button id="vent-btn" onclick="Mechanics.toggleVent()">CLOSE VENT</button>
        </div>
        <div id="hallway"><img id="vis-jomar" class="anim-img" src="jomar.png"></div>
        <div id="window-frame">
            <div id="richard-eyes"><div class="eye"></div><div class="eye"></div></div>
            <div id="curtain" onclick="Mechanics.toggleCurtain()"></div>
        </div>
        <img id="vis-isaac" class="anim-img" src="isaac.png">
        <img id="vis-maifer" class="anim-img" src="maifer.png">
        <div id="gen-panel"><div id="gen-fan"></div><button id="gen-btn" onclick="Mechanics.chargeGen()"></button></div>
        <div id="desk"><button id="btn-cam-sys" class="monitor-btn" onclick="Mechanics.toggleMonitor()">[ SYSTEM ]</button></div>
    </div>

    <div id="layer-mask"></div>
    <div id="layer-flashlight"></div>
    <div id="layer-under-desk"><h2 id="lbl-under">DEBAJO DE LA MESA</h2></div>

    <div id="screen-monitor">
        <div style="color:#fff; display:flex; justify-content:space-between; width:100%;">
            <span><span id="lbl-sys">SYSTEM</span>: CAM <span id="cam-id">06</span></span>
            <span style="color:red;" id="rec-dot">‚óè REC</span>
        </div>
        <div id="cam-view"><div id="cam-static"></div><div id="cam-content"><h1 style="color:#333;">NO SIGNAL</h1></div></div>
        <div id="map-layout">
            <div id="room-06" class="map-room"></div><div id="room-04" class="map-room"></div><div id="room-05" class="map-room"></div>
            <div id="room-02" class="map-room"></div><div id="room-03" class="map-room"></div><div id="room-you" class="map-room">YOU</div>
            <button id="btn-c6" class="cam-btn active" onclick="Monitor.setCam(6)">06</button>
            <button id="btn-c4" class="cam-btn" onclick="Monitor.setCam(4)">04</button>
            <button id="btn-c5" class="cam-btn" onclick="Monitor.setCam(5)">05</button>
            <button id="btn-c2" class="cam-btn" onclick="Monitor.setCam(2)">02</button>
            <button id="btn-c3" class="cam-btn" onclick="Monitor.setCam(3)">03</button>
            <button id="btn-c1" class="cam-btn" onclick="Monitor.setCam(1)">01</button>
            <button id="btn-close-mon" onclick="Mechanics.toggleMonitor()">CLOSE X</button>
        </div>
    </div>

    <!-- MOBILE CONTROLS -->
    <div id="mobile-controls">
        <button class="mob-btn" onclick="Mechanics.toggleMask()">MASK</button>
        <button class="mob-btn" onclick="Mechanics.toggleFlashlight()">FLASH</button>
        <button class="mob-btn" onclick="Mechanics.toggleHide()">HIDE</button>
        <button class="mob-btn" onclick="Mechanics.toggleCurtain()">CURT</button>
        <button class="mob-btn" onclick="Mechanics.toggleMonitor()">CAM</button>
    </div>
</div>

<!-- WIN / GAMEOVER -->
<div id="screen-win" class="screen" style="background:#000;">
    <h1 style="font-family:'VT323'; font-size:5rem; color:#00aaff;">YOU WIN</h1>
    <div id="win-stars" style="display:flex; gap:10px;"></div>
    <p id="win-msg" style="color:#fff; font-family:'Share Tech Mono'; margin:20px; text-align:center;"></p>
    <button class="menu-btn" onclick="location.reload()">MENU</button>
</div>

<div id="screen-8am" class="screen" style="background:#000;">
    <h1 style="font-family:'VT323'; font-size:6rem; color:#0f0;">8:00 AM</h1>
    <p id="lbl-win" style="color:#fff;">TURNO FINALIZADO.</p>
</div>

<div id="screen-minigame" class="screen">
    <div id="mg-info">MINIJUEGO</div>
    <canvas id="mg-canvas" width="600" height="400"></canvas>
    <div id="mg-controls-hint">Instrucciones aqu√≠</div>
</div>

<div id="screen-gameover" class="screen">
    <div id="death-card">
        <h1 style="color:red; font-family:'Nosifer';">GAME OVER</h1>
        <img id="death-img" src="screen_death.png" style="width:100%; border:1px solid #333;">
        <p id="death-reason" style="color:#fff;">...</p>
    </div>
    <button id="btn-menu-go" class="menu-btn" onclick="location.reload()">REINTENTAR / MENU</button>
</div>

<div id="screen-jumpscare" class="screen">
    <img id="jump-img" src="">
    <!-- CSS RICHARD SCARE -->
    <div id="js-richard" style="display:none; width: 100%; height: 100%; background: #000; justify-content: center; align-items: center; animation: zoomShake 0.2s infinite;">
        <div id="richard-box" style="width: 80vw; height: 80vw; max-width: 500px; max-height: 500px; background: #000; border: 5px solid #111; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 0 100px #00ff00;">
            <div class="r-eye-scare" style="width: 80px; height: 80px; background: #0f0; border-radius: 50%; box-shadow: 0 0 50px #0f0;"></div>
            <div class="r-eye-scare" style="width: 80px; height: 80px; background: #0f0; border-radius: 50%; box-shadow: 0 0 50px #0f0;"></div>
        </div>
    </div>
</div>

<script>
/* ==========================================================================
   DATOS Y TEXTOS (FIXED)
   ========================================================================== */
const LORE_ES = `üìñ MAIFER‚ÄôS FACTORY ‚Äî ARCHIVOS CLASIFICADOS

REGISTRO 01: EL ORIGEN
Maifer‚Äôs Factory comenz√≥ como una instalaci√≥n de rob√≥tica experimental en los a√±os 90. Michael Boyko, el fundador, estaba obsesionado con la "Inteligencia Emocional Artificial". Quer√≠a robots que no solo siguieran √≥rdenes, sino que "sintieran" su entorno.

REGISTRO 02: EL INCIDENTE DE 1998
Durante una prueba nocturna, el prototipo "Maifer-01" mostr√≥ agresi√≥n no programada hacia un t√©cnico que llevaba una linterna. Boyko, en lugar de apagarlo, orden√≥ "observar y registrar". El t√©cnico desapareci√≥ esa misma noche.

REGISTRO 03: LOS OTROS
- ISAAC: Dise√±ado para reconocimiento facial. Un fallo en su c√≥digo hace que confunda a los humanos con endoesqueletos sin traje. La m√°scara lo confunde.
- JOMAR: Un modelo de seguridad para zonas oscuras. Sus sensores son extremadamente sensibles a la luz directa.
- RICHARD: Una unidad de contenci√≥n defectuosa. Se activa con el movimiento y solo una barrera f√≠sica (la cortina) lo detiene.

NOTA DEL GUARDIA ANTERIOR:
"No se trata de ganar. Se trata de que Boyko obtenga sus datos. Eres la rata de laboratorio. Si sobrevives a la noche 8... huye."`;

const LORE_EN = `üìñ MAIFER‚ÄôS FACTORY ‚Äî CLASSIFIED FILES

LOG 01: ORIGIN
Maifer‚Äôs Factory began as an experimental robotics facility in the 90s. Michael Boyko, the founder, was obsessed with "Artificial Emotional Intelligence". He wanted robots that didn't just follow orders, but "felt" their environment.

LOG 02: THE 1998 INCIDENT
During a night test, prototype "Maifer-01" showed unprogrammed aggression towards a technician holding a flashlight. Boyko, instead of shutting it down, ordered to "observe and record". The technician vanished that night.

LOG 03: THE OTHERS
- ISAAC: Designed for facial recognition. A bug makes him mistake humans for endoskeletons. The mask confuses him.
- JOMAR: A security model for dark zones. His sensors are extremely sensitive to direct light.
- RICHARD: A defective containment unit. Activated by motion; only a physical barrier (curtain) stops him.

NOTE FROM PREVIOUS GUARD:
"It's not about winning. It's about Boyko getting his data. You are the lab rat. If you survive Night 8... run."`;

const LORE_CN = `üìñ MAIFER‚ÄôS FACTORY ‚Äî Êú∫ÂØÜÊ°£Ê°à

Êó•Âøó 01ÔºöËµ∑Ê∫ê
MaiferÂ∑•ÂéÇÂßã‰∫é90Âπ¥‰ª£ÁöÑ‰∏Ä‰∏™ÂÆûÈ™åÊÄßÊú∫Âô®‰∫∫ËÆæÊñΩ„ÄÇÂàõÂßã‰∫∫Michael BoykoÁó¥Ëø∑‰∫é‚Äú‰∫∫Â∑•ÊÉÖÊÑüÊô∫ËÉΩ‚Äù„ÄÇ‰ªñÊÉ≥Ë¶ÅÁöÑ‰∏ç‰ªÖ‰ªÖÊòØÊúç‰ªéÂëΩ‰ª§ÁöÑÊú∫Âô®‰∫∫ÔºåËÄåÊòØËÉΩÂ§ü‚ÄúÊÑüÁü•‚ÄùÁéØÂ¢ÉÁöÑÊú∫Âô®‰∫∫„ÄÇ

Êó•Âøó 02Ôºö1998Âπ¥‰∫ã‰ª∂
Âú®‰∏ÄÊ¨°Â§úÈó¥ÊµãËØï‰∏≠ÔºåÂéüÂûãÊú∫‚ÄúMaifer-01‚ÄùÂØπ‰∏ÄÂêçÊåÅÊúâÊâãÁîµÁ≠íÁöÑÊäÄÊúØ‰∫∫ÂëòË°®Áé∞Âá∫‰∫ÜÊú™ÁºñÁ®ãÁöÑÊîªÂáªÊÄß„ÄÇBoykoÊ≤°ÊúâÂÖ≥Èó≠ÂÆÉÔºåËÄåÊòØÂëΩ‰ª§‚ÄúËßÇÂØüÂπ∂ËÆ∞ÂΩï‚Äù„ÄÇÈÇ£Â§©Êôö‰∏äÊäÄÊúØ‰∫∫ÂëòÂ§±Ë∏™‰∫Ü„ÄÇ

Êó•Âøó 03ÔºöÂÖ∂‰ªñÊú∫Âô®‰∫∫
- ISAACÔºö‰∏ì‰∏∫Èù¢ÈÉ®ËØÜÂà´ËÆæËÆ°„ÄÇ‰∏Ä‰∏™ÈîôËØØËÆ©‰ªñÊää‰∫∫Á±ªËØØËÆ§‰∏∫ÊòØÂÜÖÈ™®È™º„ÄÇÈù¢ÂÖ∑ËÆ©‰ªñÂõ∞ÊÉë„ÄÇ
- JOMARÔºöÈªëÊöóÂå∫ÂüüÁöÑÂÆâÂÖ®Ê®°Âûã„ÄÇ‰ªñÁöÑ‰º†ÊÑüÂô®ÂØπÁõ¥Â∞ÑÂÖâÊûÅÂÖ∂ÊïèÊÑü„ÄÇ
- RICHARDÔºöÊúâÁº∫Èô∑ÁöÑÈÅèÂà∂ÂçïÂÖÉ„ÄÇÁî±ËøêÂä®ÊøÄÊ¥ªÔºõÂè™ÊúâÁâ©ÁêÜÂ±èÈöúÔºàÁ™óÂ∏òÔºâËÉΩÈòªÊ≠¢‰ªñ„ÄÇ

Ââç‰ªªË≠¶Âç´ÁöÑÁ¨îËÆ∞Ôºö
‚ÄúËøôÊó†ÂÖ≥ËÉúÂà©„ÄÇËøôÊòØÂÖ≥‰∫éBoykoËé∑Âèñ‰ªñÁöÑÊï∞ÊçÆ„ÄÇ‰Ω†ÊòØÂÆûÈ™åÂÆ§ÁöÑÂ∞èÁôΩÈº†„ÄÇÂ¶ÇÊûú‰Ω†Ê¥ªËøáÁ¨¨8Â§ú‚Ä¶‚Ä¶Âø´Ë∑ë„ÄÇ‚Äù`;

const UPDATES_ES = ["‚úÖ Custom Night (Noche 9)", "‚úÖ Modo M√≥vil Optimizado", "‚úÖ Ranking Local", "‚úÖ Texturas HD", "‚úÖ IA Exclusiva", "‚úÖ Jumpscare Richard CSS", "‚úÖ Ajustes Completos"];
const UPDATES_EN = ["‚úÖ Custom Night (Night 9)", "‚úÖ Mobile Optimized", "‚úÖ Local Rank", "‚úÖ HD Textures", "‚úÖ Exclusive AI", "‚úÖ Richard CSS Jumpscare", "‚úÖ Full Settings"];
const UPDATES_CN = ["‚úÖ Ëá™ÂÆö‰πâÂ§ú (Á¨¨9Â§ú)", "‚úÖ ÁßªÂä®‰ºòÂåñ", "‚úÖ Êú¨Âú∞ÊéíÂêç", "‚úÖ È´òÊ∏ÖÁ∫πÁêÜ", "‚úÖ Áã¨ÂÆ∂AI", "‚úÖ Richard CSS Jumpscare", "‚úÖ ÂÆåÊï¥ËÆæÁΩÆ"];

const TEXTS = {
    ES: {
        play: "JUGAR (NOCHE", new: "NUEVA PARTIDA", lore: "DATOS / LORE", st: "AJUSTES", 
        custom: "NOCHE PERSONALIZADA", night: "NOCHE", under: "DEBAJO DE LA MESA", win: "TURNO FINALIZADO",
        g_over: "FIN DEL JUEGO", st_title: "AJUSTES", st_vol: "VOLUMEN", st_ctrl: "CONTROLES",
        btn_close: "CERRAR", btn_save: "GUARDAR Y CERRAR", lore_txt: LORE_ES,
        lbl_mask: "M√ÅSCARA", lbl_flash: "LINTERNA", lbl_hide: "ESCONDERSE", lbl_curtain: "CORTINA", lbl_mon: "MONITOR",
        lbl_sys: "SISTEMA", lbl_pwr: "PODER", lbl_usage: "USO", lbl_night: "NOCHE",
        d_maifer: "Maifer te atrap√≥.", d_isaac: "Isaac no fue enga√±ado.", d_jomar: "La oscuridad te consumi√≥.",
        d_richard: "Richard rompi√≥ la ventana.", d_power: "Apag√≥n total.", d_air: "Falta de aire.", d_vent: "Algo sali√≥ de la ventilaci√≥n.",
        lf_1: "N1: Registro encontrado.", lf_2: "N2: Rostro detectado.",
        mg_1: "N1: ESQUIVAR OBST√ÅCULOS", mg_2: "N2: BUSCA LA M√ÅSCARA", mg_3: "N3: CARGA LA BATER√çA",
        teaser: "FIVE NIGHTS AT MAIFER'S 2 IS COMING", upd_list: UPDATES_ES, mute: "SILENCIAR üìû", upd_btn: "ACTUALIZACIONES",
        win_msg: "Espero que hayas disfrutado el juego que cre√© con mucho esfuerzo. Disfr√∫talo mientras puedas... Cinco noches con Maifer 2 pr√≥ximamente.",
        cn_start: "INICIAR NOCHE", lb_title: "GANADORES", lb_ph: "TU NOMBRE", credits: "Creado por Jonlet Santos", rank_btn: "üèÜ RANK",
        st_h_aud: "AUDIO", st_h_gfx: "GR√ÅFICOS", st_h_ctrl: "CONTROLES",
        st_full: "PANTALLA COMPLETA", st_gli: "EFECTO GLITCH", st_sens: "SENSIBILIDAD", st_del: "BORRAR DATOS"
    },
    EN: {
        play: "PLAY (NIGHT", new: "NEW GAME", lore: "DATA / LORE", st: "SETTINGS",
        custom: "CUSTOM NIGHT", night: "NIGHT", under: "UNDER THE DESK", win: "SHIFT COMPLETED",
        g_over: "GAME OVER", st_title: "SETTINGS", st_vol: "VOLUME", st_ctrl: "CONTROLS",
        btn_close: "CLOSE", btn_save: "SAVE & CLOSE", lore_txt: LORE_EN,
        lbl_mask: "MASK", lbl_flash: "FLASHLIGHT", lbl_hide: "HIDE", lbl_curtain: "CURTAIN", lbl_mon: "MONITOR",
        lbl_sys: "SYSTEM", lbl_pwr: "POWER", lbl_usage: "USAGE", lbl_night: "NIGHT",
        d_maifer: "Maifer caught you.", d_isaac: "Isaac wasn't fooled.", d_jomar: "Darkness took you.",
        d_richard: "Richard broke in.", d_power: "Blackout.", d_air: "No air.", d_vent: "Ventilation breach.",
        lf_1: "N1: Record found.", lf_2: "N2: Face detected.",
        mg_1: "N1: DODGE", mg_2: "N2: FIND MASK", mg_3: "N3: CHARGE BATTERY",
        teaser: "FIVE NIGHTS AT MAIFER'S 2 IS COMING", upd_list: UPDATES_EN, mute: "MUTE CALL üìû", upd_btn: "UPDATES",
        win_msg: "I hope you enjoyed the game I created with much effort. Enjoy it while you can... Five Nights at Maifer's 2 coming soon.",
        cn_start: "START NIGHT", lb_title: "SURVIVORS", lb_ph: "YOUR NAME", credits: "Created by Jonlet Santos", rank_btn: "üèÜ RANK",
        st_h_aud: "AUDIO", st_h_gfx: "GRAPHICS", st_h_ctrl: "CONTROLS",
        st_full: "FULLSCREEN", st_gli: "GLITCH FX", st_sens: "SENSITIVITY", st_del: "RESET DATA"
    },
    CN: {
        play: "ÂºÄÂßãÊ∏∏Êàè (Â§ú", new: "Êñ∞Ê∏∏Êàè", lore: "Êï∞ÊçÆ / ‰º†ËØ¥", st: "ËÆæÁΩÆ",
        custom: "Ëá™ÂÆö‰πâÂ§ú", night: "Â§ú", under: "Ê°åÂ≠êÂ∫ï‰∏ã", win: "‰∏ãÁè≠‰∫Ü",
        g_over: "Ê∏∏ÊàèÁªìÊùü", st_title: "ËÆæÁΩÆ", st_vol: "Èü≥Èáè", st_ctrl: "ÊéßÂà∂",
        btn_close: "ÂÖ≥Èó≠", btn_save: "‰øùÂ≠òÂπ∂ÂÖ≥Èó≠", lore_txt: LORE_CN,
        lbl_mask: "Èù¢ÂÖ∑", lbl_flash: "ÊâãÁîµÁ≠í", lbl_hide: "ÈöêËóè", lbl_curtain: "Á™óÂ∏ò", lbl_mon: "ÁõëËßÜÂô®",
        lbl_sys: "Á≥ªÁªü", lbl_pwr: "ÂäüÁéá", lbl_usage: "Áî®Ê≥ï", lbl_night: "Â§ú",
        d_maifer: "MaiferÊäì‰Ωè‰∫Ü‰Ω†„ÄÇ", d_isaac: "IsaacÁúãÂà∞‰∫Ü‰Ω†ÁöÑËÑ∏„ÄÇ", d_jomar: "ÈªëÊöóÂêûÂô¨‰∫Ü‰Ω†„ÄÇ",
        d_richard: "RichardÈóØÂÖ•„ÄÇ", d_power: "ÂÅúÁîµ„ÄÇ", d_air: "Á™íÊÅØ„ÄÇ", d_vent: "ÈÄöÈ£éÂè£„ÄÇ",
        lf_1: "N1: ËÆ∞ÂΩï„ÄÇ", lf_2: "N2: ËÑ∏„ÄÇ",
        mg_1: "N1: Ë∫≤ÈÅø", mg_2: "N2: ÊâæÈù¢ÂÖ∑", mg_3: "N3: ÂÖÖÁîµ",
        teaser: "FIVE NIGHTS AT MAIFER'S 2 IS COMING", upd_list: UPDATES_CN, mute: "ÈùôÈü≥ÈÄöËØù üìû", upd_btn: "Êõ¥Êñ∞",
        win_msg: "ÊàëÂ∏åÊúõ‰Ω†ÂñúÊ¨¢ÊàëÂä™ÂäõÂà∂‰ΩúÁöÑÊ∏∏Êàè„ÄÇÂ∞ΩÊÉÖ‰∫´ÂèóÂêß... MaiferÁöÑ‰∫îÂ§ú2Âç≥Â∞ÜÊé®Âá∫„ÄÇ",
        cn_start: "ÂºÄÂßã", lb_title: "Âπ∏Â≠òËÄÖ", lb_ph: "‰Ω†ÁöÑÂêçÂ≠ó", credits: "‰ΩúËÄÖ: Jonlet Santos", rank_btn: "üèÜ ÊéíË°å",
        st_h_aud: "Èü≥È¢ë", st_h_gfx: "ÂõæÂΩ¢", st_h_ctrl: "ÊéßÂà∂",
        st_full: "ÂÖ®Â±è", st_gli: "ÊïÖÈöúÊïàÊûú", st_sens: "ÁÅµÊïèÂ∫¶", st_del: "ÈáçÁΩÆÊï∞ÊçÆ"
    }
};

const Lang = {
    current: 'ES',
    toggle: () => {
        const order = ['ES', 'EN', 'CN'];
        let idx = order.indexOf(Lang.current);
        Lang.current = order[(idx + 1) % 3];
        Lang.apply();
    },
    // Funci√≥n segura para asignar texto
    setText: (id, text) => {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    },
    apply: () => {
        const t = TEXTS[Lang.current];
        const n = document.getElementById('menu-night') ? document.getElementById('menu-night').innerText : SAVEDATA.night;
        
        Lang.setText('lang-btn', Lang.current === 'CN' ? '‰∏≠Êñá' : (Lang.current === 'ES' ? 'ESPA√ëOL' : 'ENGLISH'));
        if(document.getElementById('btn-play')) document.getElementById('btn-play').innerHTML = `${t.play} <span id="menu-night">${n}</span>)`;
        
        // Botones Menu
        Lang.setText('btn-new', t.new);
        Lang.setText('btn-lore', t.lore);
        Lang.setText('btn-updates', t.upd_btn);
        Lang.setText('btn-settings', t.st);
        
        // Custom button
        const custBtn = document.getElementById('btn-custom');
        if(custBtn && custBtn.childNodes[0]) custBtn.childNodes[0].nodeValue = t.custom + " "; 

        // Modales
        Lang.setText('lore-content', t.lore_txt);
        Lang.setText('btn-close-lore', t.btn_close);
        Lang.setText('btn-close-upd', t.btn_close);
        Lang.setText('st-title', t.st_title);
        Lang.setText('st-vol', t.st_vol);
        Lang.setText('st-ctrl', t.st_ctrl);
        Lang.setText('btn-save-st', t.btn_save);

        // Labels Ajustes (NUEVO)
        Lang.setText('st-h-aud', t.st_h_aud);
        Lang.setText('st-h-gfx', t.st_h_gfx);
        Lang.setText('st-h-ctrl', t.st_h_ctrl);
        Lang.setText('st-full', t.st_full);
        Lang.setText('st-gli', t.st_gli);
        Lang.setText('st-sens', t.st_sens);
        Lang.setText('st-del', t.st_del);

        // HUD Labels (NUEVO)
        Lang.setText('lbl-mask', t.lbl_mask);
        Lang.setText('lbl-flash', t.lbl_flash);
        Lang.setText('lbl-hide', t.lbl_hide);
        Lang.setText('lbl-curtain', t.lbl_curtain);
        Lang.setText('lbl-mon', t.lbl_mon);
        Lang.setText('lbl-night', t.lbl_night);
        Lang.setText('lbl-pwr', t.lbl_pwr);
        Lang.setText('lbl-usage', t.lbl_usage);
        Lang.setText('lbl-sys', t.lbl_sys);
        Lang.setText('lbl-under', t.under);
        Lang.setText('lbl-win', t.win);

        // Extras
        Lang.setText('teaser-text', t.teaser);
        Lang.setText('btn-mute', t.mute);
        Lang.setText('btn-leaderboard', t.rank_btn);
        Lang.setText('credits-text', t.credits);
        
        // Leaderboard & Custom
        const lbTitle = document.querySelector('#modal-leaderboard h2');
        if(lbTitle) lbTitle.innerText = t.lb_title;
        const inpName = document.getElementById('inp-name');
        if(inpName) inpName.placeholder = t.lb_ph;
        Lang.setText('btn-cn-start', t.cn_start);

        // Update Log Fix
        const ul = document.getElementById('update-list'); 
        if(ul) {
            ul.innerHTML='';
            t.upd_list.forEach(item => { 
                let li = document.createElement('li'); 
                li.innerText = item; 
                ul.appendChild(li); 
            });
        }
    }
};

// DETECCION MOVIL
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 800;

let SAVEDATA = {night:1, stars:{}, binds:null, leaderboard:[]};
try { 
    const loaded = localStorage.getItem('mf_save_v4'); 
    if(loaded) SAVEDATA = JSON.parse(loaded); 
    if(!SAVEDATA.leaderboard) SAVEDATA.leaderboard = []; 
} catch(e) { 
    localStorage.removeItem('mf_save_v4'); 
}

const BINDINGS = SAVEDATA.binds || { mask: 'Space', flash: 'KeyF', hide: 'ControlLeft', curtain: 'KeyS', monitor: 'Tab' };

const NIGHT_CONFIG = {
    1: { maifer: 2, isaac: 0, jomar: 0, richard: 2, power: 100 },
    2: { maifer: 4, isaac: 3, jomar: 2, richard: 4, power: 100 },
    3: { maifer: 6, isaac: 5, jomar: 5, richard: 5, power: 100 }, 
    4: { maifer: 8, isaac: 8, jomar: 7, richard: 7, power: 100 },
    5: { maifer: 10, isaac: 10, jomar: 10, richard: 10, power: 100 },
    6: { maifer: 12, isaac: 12, jomar: 12, richard: 12, power: 100 },
    7: { maifer: 15, isaac: 15, jomar: 15, richard: 15, power: 100 },
    8: { maifer: 20, isaac: 20, jomar: 20, richard: 20, power: 100 }, 
    9: { maifer: 20, isaac: 20, jomar: 20, richard: 20, power: 100 }
};

/* ==========================================================================
   CONFIGURACION
   ========================================================================== */
const Config = {
    glitchEnabled: true,
    toggleFullscreen: () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => {});
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    },
    toggleGlitch: () => {
        Config.glitchEnabled = !Config.glitchEnabled;
        document.querySelectorAll('.active-anim').forEach(el => {
            el.style.animation = Config.glitchEnabled ? 'glitch 1s infinite' : 'none';
        });
        document.querySelectorAll('.title-text').forEach(el => {
            el.style.animation = Config.glitchEnabled ? 'glitch 4s infinite' : 'none';
        });
    }
};

/* ==========================================================================
   AUDIO
   ========================================================================== */
const AudioSys = {
    volume: 1.0,
    setVolume: (val) => { 
        AudioSys.volume = val / 100; 
        document.querySelectorAll('audio').forEach(a => a.volume = AudioSys.volume); 
    },
    play: (id, loop=false, forceVol=null) => {
        const s = document.getElementById(id);
        if(s){ 
            s.loop = loop; 
            s.volume = forceVol !== null ? forceVol : AudioSys.volume; 
            s.currentTime = 0; 
            s.play().catch(()=>{}); 
        }
    },
    stop: (id) => { 
        const s = document.getElementById(id); 
        if(s) { 
            s.pause(); 
            s.currentTime = 0; 
        } 
    },
    stopAll: () => document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime=0; }),
    stopLoops: () => { 
        AudioSys.stop('sfx-maifer'); 
        AudioSys.stop('sfx-isaac'); 
        AudioSys.stop('sfx-jomar'); 
    }
};

const Input = {
    rebind: (action) => {
        const btn = document.getElementById('bind-' + action);
        btn.innerText = "...";
        const handler = (e) => {
            e.preventDefault();
            BINDINGS[action] = e.code;
            btn.innerText = e.code;
            SAVEDATA.binds = BINDINGS;
            localStorage.setItem('mf_save_v4', JSON.stringify(SAVEDATA));
            document.removeEventListener('keydown', handler);
        };
        document.addEventListener('keydown', handler);
    }
};

document.addEventListener('keydown', (e) => {
    if (Game.state.over || UI.modalOpen || Game.state.inMinigame) return;
    const k = e.code;
    if (k === BINDINGS.mask) Mechanics.toggleMask();
    if (k === BINDINGS.flash) Mechanics.toggleFlashlight();
    if (k === BINDINGS.hide) Mechanics.toggleHide();
    if (k === BINDINGS.curtain) Mechanics.toggleCurtain();
    if (k === BINDINGS.monitor) Mechanics.toggleMonitor();
});

const CustomNight = {
    levels: { maifer:0, isaac:0, jomar:0, richard:0 },
    adj: (char, amount) => {
        CustomNight.levels[char] = Math.max(0, Math.min(20, CustomNight.levels[char] + amount));
        document.getElementById('val-'+char).innerText = CustomNight.levels[char];
    },
    start: () => {
        const l = CustomNight.levels;
        if(l.maifer===20 && l.isaac===20 && l.jomar===20 && l.richard===20) {
            Game.startLevel(9, l); 
        } else {
            Game.startLevel('CUSTOM', l);
        }
    }
};

const Leaderboard = {
    add: () => {
        const name = document.getElementById('inp-name').value || "ANON";
        SAVEDATA.leaderboard.push({name: name, date: new Date().toLocaleDateString()});
        localStorage.setItem('mf_save_v4', JSON.stringify(SAVEDATA));
        Leaderboard.show();
        document.getElementById('lb-input').style.display = 'none';
    },
    show: () => {
        const list = document.getElementById('lb-list'); list.innerHTML = '';
        SAVEDATA.leaderboard.slice(-10).reverse().forEach(e => {
            let li = document.createElement('li'); li.innerText = `${e.name} - ${e.date}`; list.appendChild(li);
        });
    }
};

const Game = {
    state: { night: 1, power: 100, time: 0, over: false, view: 'office', mask: false, hidden: false, curtain: false, flash: false, toxic: 0, vent: false, inMinigame: false },
    timers: {}, 
    ai: {},

    initMenu: () => {
        document.getElementById('menu-night').innerText = SAVEDATA.night;
        const row = document.getElementById('star-row');
        row.innerHTML = '';
        if(SAVEDATA.night > 6) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 7) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 8) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        if(SAVEDATA.night > 9) row.innerHTML += '<span class="star earned">‚òÖ</span>';
        
        const cnBtn = document.getElementById('btn-custom');
        if(SAVEDATA.night > 8) { 
            cnBtn.disabled = false; 
            cnBtn.classList.remove('locked'); 
            cnBtn.querySelector('.icon-lock').style.display = 'none'; 
        }
        for(let k in BINDINGS) { 
            const el = document.getElementById('bind-'+k); 
            if(el) el.innerText = BINDINGS[k]; 
        }
        Lang.apply();
        AudioSys.play('bgm-menu', true);
    },

    newGame: () => { 
        if(confirm("DELETE DATA?")) { 
            localStorage.removeItem('mf_save_v4'); 
            location.reload(); 
        } 
    },

    initNight: () => { Game.startLevel(parseInt(SAVEDATA.night) > 8 ? 8 : parseInt(SAVEDATA.night)); },
    initCustomSetup: () => { UI.showScreen('screen-custom'); },

    startLevel: (n, customAI=null) => {
        Game.state = { night: n, power: 100, time: 0, over: false, view: 'office', mask: false, hidden: false, curtain: false, flash: false, toxic: 0, vent: false, inMinigame: false };
        if(n === 'CUSTOM') {
            Game.ai = { ...customAI, pos: {maifer:0, isaac:0, jomar:0, richard:0, vent:0}, busy: false };
            document.getElementById('game-night-num').innerText = "C";
        } else {
            Game.ai = { ...NIGHT_CONFIG[n], pos: {maifer:0, isaac:0, jomar:0, richard:0, vent:0}, busy: false };
            document.getElementById('game-night-num').innerText = n;
        }
        UI.showScreen('screen-game');
        AudioSys.stopAll();
        
        if(isMobile) document.getElementById('mobile-controls').style.display = 'flex';

        setTimeout(() => {
            if(n === 9) AudioSys.play('bgm-night9', true); 
            else AudioSys.play('bgm-game', true, 0.6);
            if(n === 1) AudioSys.play('voice-1');
            if(n === 2) AudioSys.play('voice-2');
            document.getElementById('btn-mute').style.display = 'block';
        }, 500);

        document.getElementById('curtain').classList.remove('closed');
        document.getElementById('vent-door').classList.remove('closed');
        document.getElementById('vent-btn').classList.remove('active');
        document.getElementById('vent-img').style.display = 'none';
        document.getElementById('layer-mask').style.display = 'none';
        document.getElementById('layer-flashlight').style.display = 'none';
        document.getElementById('layer-under-desk').style.display = 'none';
        document.getElementById('toxic-bar').style.width = '0%';
        document.querySelectorAll('.anim-img').forEach(i => i.style.display = 'none');
        document.getElementById('richard-eyes').style.opacity = 0;
        
        Mechanics.moveGenButton();
        Game.timers.main = setInterval(Game.loop, 100);
        Game.timers.ai = setInterval(Game.aiLoop, (n===8 || n===9) ? 1000 : 2000);
        Lang.apply(); // Re-aplicar traducciones para HUD
    },

    loop: () => {
        if(Game.state.over || Game.state.inMinigame) return;
        
        Game.state.time += 0.12; 
        let hour = 12 + Math.floor(Game.state.time / 12.5); 
        if(hour > 12) hour -= 12;
        document.getElementById('hud-time').innerText = (hour === 0 ? 12 : hour) + " AM";
        if(Game.state.time >= 100) { Game.reach8AM(); return; }
        
        let drain = 0.04;
        let usage = 1;
        if(Game.state.night === 8) drain = 0.08; 
        if(Game.state.mask) { drain += 0.04; usage++; }
        if(Game.state.flash) { drain += 0.08; usage++; }
        if(Game.state.view === 'monitor') { drain += 0.12; usage++; }
        if(Game.state.curtain) { drain += 0.1; usage++; }
        if(Game.state.vent) { drain += 0.08; usage++; }
        
        document.getElementById('use-1').className = 'usage-block ' + (usage >= 1 ? 'active' : '');
        document.getElementById('use-2').className = 'usage-block ' + (usage >= 2 ? 'active' : '');
        document.getElementById('use-3').className = 'usage-block ' + (usage >= 3 ? 'active' : '');
        document.getElementById('use-4').className = 'usage-block ' + (usage >= 4 ? 'high' : '');

        Game.state.power -= drain;
        document.getElementById('pwr-val').innerText = Math.floor(Game.state.power);
        if(Game.state.power <= 0) { Game.die('power'); return; }

        if(Game.state.mask) { 
            let toxicRate = 0.2 + (typeof Game.state.night === 'number' ? Game.state.night * 0.05 : 0.5);
            Game.state.toxic += toxicRate; 
            document.getElementById('hud-toxic').style.display = 'block'; 
        } else { 
            Game.state.toxic = Math.max(0, Game.state.toxic - 0.2); 
            if(Game.state.toxic <= 0) document.getElementById('hud-toxic').style.display = 'none'; 
        }
        document.getElementById('toxic-bar').style.width = Game.state.toxic + "%";
        if(Game.state.toxic >= 100) { Game.die('air'); return; }
        
        if(Game.ai.pos.richard >= 1 && !Game.state.curtain) {
            document.getElementById('richard-eyes').style.opacity = 1;
        } else {
             document.getElementById('richard-eyes').style.opacity = 0;
        }
        Monitor.update();
    },

    aiLoop: () => {
        if(Game.state.over) return;
        const rng = (lvl) => (Math.random() * 20) < lvl;
        if(Game.ai.busy && Game.state.night < 8) return;

        let killTime = 3000;
        if(Game.state.night >= 5) killTime = 2000;
        if(Game.state.night === 8) killTime = 1500; 

        // MAIFER
        if(rng(Game.ai.maifer) && Game.ai.pos.maifer < 5 && Game.ai.pos.vent !== 'maifer') {
            Game.ai.pos.maifer++;
            if(Game.ai.pos.maifer === 5) {
                Game.ai.busy = true; 
                UI.flicker();
                setTimeout(() => {
                    AudioSys.play('sfx-maifer', true);
                    document.getElementById('vis-maifer').style.display = 'block';
                    setTimeout(() => {
                        if(!Game.state.hidden) Game.die('maifer');
                        else { 
                            AudioSys.stopLoops(); AudioSys.play('sfx-leave', false, 1.0); 
                            document.getElementById('vis-maifer').style.display = 'none'; 
                            Game.ai.pos.maifer = 0; Game.ai.busy = false;
                        }
                    }, killTime);
                }, 1000);
            }
        }
        
        // VENTILACION
        if(Game.ai.pos.vent === 0) {
             let chance = (typeof Game.state.night === 'number' ? Game.state.night : 10) * 0.05;
             if(Math.random() < chance) { 
                 if(Math.random() > 0.5 && Game.ai.pos.maifer < 3) {
                     Game.ai.pos.vent = 'maifer';
                     document.getElementById('vent-img').src = 'maifer.png';
                     document.getElementById('vent-img').style.display = 'block';
                 } else if (Game.ai.pos.isaac < 3) {
                     Game.ai.pos.vent = 'isaac';
                     document.getElementById('vent-img').src = 'isaac.png';
                     document.getElementById('vent-img').style.display = 'block';
                 }
             }
        } else {
             if(Game.state.vent) {
                 AudioSys.play('sfx-leave', false, 1.0);
                 Game.ai.pos.vent = 0;
                 document.getElementById('vent-img').style.display = 'none';
             } else {
                 if(Math.random() > 0.6) Game.die('vent'); 
             }
        }

        // ISAAC
        if(rng(Game.ai.isaac) && Game.ai.pos.isaac < 5 && Game.ai.pos.vent !== 'isaac') {
            Game.ai.pos.isaac++;
            if(Game.ai.pos.isaac === 5) {
                Game.ai.busy = true; 
                UI.flicker();
                setTimeout(() => {
                    AudioSys.play('sfx-isaac', true);
                    document.getElementById('vis-isaac').style.display = 'block';
                    setTimeout(() => {
                        if(!Game.state.mask) Game.die('isaac');
                        else { 
                            AudioSys.stopLoops(); AudioSys.play('sfx-leave', false, 1.0); 
                            document.getElementById('vis-isaac').style.display = 'none'; 
                            Game.ai.pos.isaac = 0; Game.ai.busy = false;
                        }
                    }, killTime + 500); 
                }, 1000);
            }
        }

        // JOMAR
        if(rng(Game.ai.jomar)) {
            if(Game.ai.pos.jomar === 0) { 
                Game.ai.busy = true; 
                UI.flicker();
                Game.ai.pos.jomar = 1; 
                setTimeout(() => {
                    document.getElementById('vis-jomar').style.display = 'block'; 
                    AudioSys.play('sfx-jomar', true); 
                }, 500);
            } else {
                if(Math.random() > 0.8) Game.die('jomar'); 
            }
        }

        // RICHARD
        if(Game.ai.pos.richard === 0) {
            if(rng(Game.ai.richard)) {
                Game.ai.pos.richard = 1; 
                if(Game.state.night === 8 && Math.random() > 0.5) Game.ai.pos.richard = 2; 
            }
        } else {
            if(Game.state.curtain) {
                AudioSys.play('sfx-leave', false, 1.0);
                Game.ai.pos.richard = 0;
            } else {
                if(rng(Game.ai.richard + 5)) { 
                    Game.ai.pos.richard++;
                    if(Game.ai.pos.richard > 4) Game.die('richard'); 
                }
            }
        }
    },

    die: (causeKey) => {
        if(Game.state.over) return;
        Game.state.over = true;
        clearInterval(Game.timers.main); 
        clearInterval(Game.timers.ai); 
        AudioSys.stopAll();
        
        const js = document.getElementById('screen-jumpscare');
        const img = document.getElementById('jump-img');
        const cssRichard = document.getElementById('js-richard');
        
        js.style.display = 'flex';
        img.style.display = 'block';
        cssRichard.style.display = 'none';

        let src="maifer.png", snd="jump-maifer";
        
        if(causeKey === 'richard') {
            img.style.display = 'none';
            cssRichard.style.display = 'flex';
            snd = "jump-richard";
        } else {
            if(causeKey === 'maifer' || causeKey === 'vent') { src="maifer.png"; snd="jump-maifer"; }
            if(causeKey === 'isaac') { src="isaac.png"; snd="jump-isaac"; }
            if(causeKey === 'jomar') { src="jomar.png"; snd="jump-jomar"; }
            img.src = src; 
        }
        
        AudioSys.play(snd);
        
        setTimeout(() => {
            js.style.display = 'none'; 
            UI.showScreen('screen-gameover');
            document.getElementById('death-reason').innerText = TEXTS[Lang.current]['d_'+causeKey] || "GAME OVER";
            AudioSys.play('sfx-gameover', false, 1.0);
        }, 2000);
    },

    reach8AM: () => {
        Game.state.over = true; 
        clearInterval(Game.timers.main); 
        clearInterval(Game.timers.ai); 
        AudioSys.stopAll();
        UI.showScreen('screen-8am'); 
        AudioSys.play('sfx-win');
        setTimeout(() => { 
            if(typeof Game.state.night === 'number' && Game.state.night < 9) { 
                MiniGames.start(Game.state.night); 
            } else if (Game.state.night === 9) {
                SAVEDATA.night = 10; SAVEDATA.stars[9]=true; 
                localStorage.setItem('mf_save_v4', JSON.stringify(SAVEDATA));
                UI.showScreen('screen-win'); 
                document.getElementById('win-stars').innerHTML = '<span class="star earned blue">‚òÖ</span><span class="star earned blue">‚òÖ</span><span class="star earned blue">‚òÖ</span><span class="star earned blue">‚òÖ</span>';
            } else { location.reload(); }
        }, 4000);
    }
};

const Mechanics = {
    canAct: (isTurningOff) => {
        if(isTurningOff) return true;
        let count = 0;
        if(Game.state.mask) count++; 
        if(Game.state.view === 'monitor') count++;
        if(Game.state.flash) count++; 
        if(Game.state.curtain) count++; 
        if(Game.state.hidden) count++;
        if(Game.state.vent) count++;
        return count < 2; 
    },
    toggleMonitor: () => { 
        if(Game.state.over || Game.state.hidden) return; 
        const m = document.getElementById('screen-monitor'); 
        if(Game.state.view==='monitor') { 
            m.style.display='none'; 
            Game.state.view='office'; 
        } 
        else { 
            if(!Mechanics.canAct(false)) return; 
            m.style.display='flex'; 
            Game.state.view='monitor'; 
            AudioSys.play('sfx-monitor'); 
        } 
    },
    toggleMask: () => { 
        if(Game.state.view !== 'office') return; 
        if(Game.state.mask) { 
            Game.state.mask = false; 
            document.getElementById('layer-mask').style.display = 'none'; 
            AudioSys.stop('sfx-mask'); 
        } 
        else { 
            if(!Mechanics.canAct(false)) return; 
            Game.state.mask = true; 
            document.getElementById('layer-mask').style.display = 'block'; 
            AudioSys.play('sfx-mask', true); 
        } 
    },
    toggleFlashlight: () => { 
        if(Game.state.view !== 'office') return; 
        if(Game.state.flash) { 
            Game.state.flash = false; 
            document.getElementById('layer-flashlight').style.display = 'none'; 
        } 
        else { 
            if(!Mechanics.canAct(false)) return; 
            Game.state.flash = true; 
            document.getElementById('layer-flashlight').style.display = 'block'; 
            AudioSys.play('sfx-flash'); 
            if(Game.ai.pos.jomar === 1) { 
                Game.ai.pos.jomar = 0; 
                document.getElementById('vis-jomar').style.display = 'none'; 
                AudioSys.stopLoops(); 
                AudioSys.play('sfx-leave', false, 1.0); 
                Game.ai.busy = false; 
            } 
        } 
    },
    toggleCurtain: () => { 
        if(Game.state.view !== 'office') return; 
        if(Game.state.curtain) { 
            Game.state.curtain = false; 
        } 
        else { 
            if(!Mechanics.canAct(false)) return; 
            Game.state.curtain = true; 
            AudioSys.play('sfx-curtain'); 
        } 
        document.getElementById('curtain').classList.toggle('closed', Game.state.curtain); 
    },
    toggleHide: () => { 
        if(Game.state.view !== 'office') return; 
        if(Game.state.hidden) { 
            Game.state.hidden = false; 
            document.getElementById('layer-under-desk').style.display = 'none'; 
        } 
        else { 
            if(!Mechanics.canAct(false)) return; 
            Game.state.hidden = true; 
            document.getElementById('layer-under-desk').style.display = 'flex'; 
            AudioSys.play('sfx-hide'); 
        } 
    },
    toggleVent: () => {
        if(Game.state.view !== 'office') return;
        if(Game.state.vent) { 
            Game.state.vent = false; 
        } 
        else { 
            if(!Mechanics.canAct(false)) return; 
            Game.state.vent = true; 
            AudioSys.play('sfx-curtain'); 
        }
        document.getElementById('vent-door').classList.toggle('closed', Game.state.vent);
        document.getElementById('vent-btn').classList.toggle('active', Game.state.vent);
    },
    muteCall: () => {
        AudioSys.stop('voice-1'); 
        AudioSys.stop('voice-2');
        document.getElementById('btn-mute').style.display = 'none';
    },
    moveGenButton: () => { 
        const btn = document.getElementById('gen-btn'); 
        btn.style.left = Math.random()*90 + 'px'; 
        btn.style.top = Math.random()*140 + 'px'; 
        btn.style.display = 'block'; 
    },
    chargeGen: () => { 
        if(Game.state.over) return; 
        Game.state.power = Math.min(100, Game.state.power + 5); 
        document.getElementById('pwr-val').innerText = Math.floor(Game.state.power); 
        AudioSys.play('sfx-gen'); 
        document.getElementById('gen-btn').style.display = 'none'; 
        setTimeout(Mechanics.moveGenButton, 3000 + Math.random()*5000); 
    }
};

const Monitor = {
    current: 6, 
    setCam: (id) => { 
        Monitor.current = id; 
        document.getElementById('cam-id').innerText = "0"+id; 
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById('btn-c'+id).classList.add('active');
        AudioSys.play('sfx-cam'); 
        Monitor.update(); 
    },
    update: () => {
        if(Game.state.view !== 'monitor') return;
        const div = document.getElementById('cam-content'); 
        div.innerHTML = '';
        const c = Monitor.current; 
        const p = Game.ai.pos;
        let html = '';

        if(c===6) {
            if(p.maifer === 0) html += '<div class="cam-spot">MAIFER (IDLE)</div>';
            if(p.isaac === 0) html += '<div class="cam-spot">ISAAC (IDLE)</div>';
        }
        if(c===5 && p.maifer === 1) html += '<div class="cam-spot active-anim">MAIFER DETECTED</div>';
        if(c===4 && p.isaac === 1) html += '<div class="cam-spot active-anim">ISAAC DETECTED</div>';
        if(c===3) {
            if(p.maifer === 2) html += '<div class="cam-spot active-anim">MAIFER DETECTED</div>';
            if(p.isaac === 2) html += '<div class="cam-spot active-anim">ISAAC DETECTED</div>';
        }
        if(c===2) {
            if(p.maifer === 3) html += '<div class="cam-spot active-anim">MAIFER DETECTED</div>';
            if(p.isaac === 4) html += '<div class="cam-spot active-anim">ISAAC (NEAR)</div>';
        }
        if(c===1) {
            if(p.maifer === 4) html += '<div class="cam-spot active-anim">MAIFER (NEAR)</div>';
            if(p.isaac === 3) html += '<div class="cam-spot active-anim">ISAAC DETECTED</div>';
        }

        if(html === '') html = '<h1 style="color:#333;">NO SIGNAL</h1>';
        div.innerHTML = html;
    }
};

const UI = {
    modalOpen: false,
    showScreen: (id) => { 
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
    },
    openLore: () => { document.getElementById('modal-lore').style.display = 'flex'; },
    openUpdates: () => { document.getElementById('modal-updates').style.display = 'flex'; },
    openSettings: () => { document.getElementById('modal-settings').style.display = 'flex'; },
    openLeaderboard: () => { document.getElementById('modal-leaderboard').style.display = 'flex'; Leaderboard.show(); },
    closeModals: () => { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); },
    flicker: () => { 
        if(!Config.glitchEnabled) return;
        const el = document.getElementById('layer-flicker'); 
        el.classList.remove('flickering'); 
        void el.offsetWidth; 
        el.classList.add('flickering'); 
    }
};

const MiniGames = {
    active: false, night: 0, ctx: null, 
    player: {}, enemies: [], target: {}, state: {}, frame: 0,
    start: (n) => {
        Game.state.inMinigame = true; MiniGames.night = n; MiniGames.active = true; MiniGames.frame = 0;
        UI.showScreen('screen-minigame'); AudioSys.play('bgm-minigame', true);
        const c = document.getElementById('mg-canvas'); MiniGames.ctx = c.getContext('2d');
        const t = TEXTS[Lang.current];
        document.getElementById('mg-info').innerText = t['mg_'+n] || "MINIGAME";
        document.getElementById('mg-controls-hint').innerText = "Use Mouse / Arrows / Space / Click";
        MiniGames.initLogic(n);
        requestAnimationFrame(MiniGames.loop);
        document.onkeydown = MiniGames.handleInput; c.onmousedown = MiniGames.handleClick; c.onmousemove = MiniGames.handleMove;
    },
    initLogic: (n) => {
        const w=600, h=400; MiniGames.enemies = []; MiniGames.player = {x:300, y:200, w:20, h:20, duck:false};
        if(n===1) { MiniGames.player = {x:50, y:300, w:30, h:30, duck:false}; MiniGames.enemies = [{x:600, y:280, w:40, h:60, spd:4}]; } 
        else if(n===2) { MiniGames.player = {x:20, y:20, w:20, h:20}; MiniGames.target = {x:550, y:350, w:30, h:30, active:true}; MiniGames.enemies = [{x:100,y:0,h:300,dir:1},{x:300,y:100,h:300,dir:-1},{x:500,y:0,h:300,dir:1}]; } 
        else if(n===3) { MiniGames.state = {score:0}; MiniGames.spawnClickTarget(); } 
        else if(n===4) { MiniGames.enemies = []; MiniGames.player = {x:300, y:300, w:10, h:10}; } 
        else if(n===5) { MiniGames.state = {pos: 200, vel: 0, target: 200}; } 
        else if(n===6) { MiniGames.state = {timer: Math.random()*200 + 100, color: 'red', waiting: true}; } 
        else if(n===7) { MiniGames.player = {x:20, y:20, w:20, h:20}; MiniGames.target = {x:560, y:360, w:20, h:20}; MiniGames.enemies = [{x:100,y:50,w:20,h:350}, {x:250,y:0,w:20,h:350}, {x:400,y:50,w:20,h:350}]; } 
        else if(n===8) { MiniGames.player = {x:300, y:200, w:20, h:20}; MiniGames.state = {timer: 1800}; }
    },
    spawnClickTarget: () => { MiniGames.enemies.push({x:Math.random()*560+20, y:Math.random()*360+20, r:20, life:60}); },
    loop: () => {
        if(!MiniGames.active) return;
        const ctx = MiniGames.ctx; const w=600, h=400;
        ctx.fillStyle = '#111'; ctx.fillRect(0,0,w,h);
        MiniGames.frame++; const n = MiniGames.night;

        if(n===1) {
            ctx.fillStyle = MiniGames.player.duck ? '#050' : '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.duck?320:300, 30, MiniGames.player.duck?15:30);
            MiniGames.enemies.forEach(e => {
                e.x -= e.spd; ctx.fillStyle = '#f00'; ctx.fillRect(e.x, e.y, e.w, e.h);
                if(e.x < -50) { e.x = 650; e.spd = 4+Math.random()*3; }
                if(MiniGames.col(MiniGames.player, e) && !MiniGames.player.duck) MiniGames.lose();
            });
            if(MiniGames.frame > 900) MiniGames.win();
        } else if(n===2) {
            ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20); ctx.fillStyle = '#00f'; ctx.fillRect(MiniGames.target.x, MiniGames.target.y, 30, 30);
            MiniGames.enemies.forEach(e => { ctx.fillStyle = '#555'; ctx.fillRect(e.x, e.y, e.w, e.h); if(MiniGames.col(MiniGames.player, {x:e.x,y:e.y,w:20,h:e.h})) MiniGames.lose(); });
            if(MiniGames.col(MiniGames.player, MiniGames.target)) MiniGames.win();
        } else if(n===3) {
            ctx.fillStyle = '#fff'; ctx.fillText("CLICK GREEN ORBS: "+MiniGames.state.score+"/10", 20, 30);
            MiniGames.enemies.forEach((e,i) => { e.life--; ctx.fillStyle='#0f0'; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,6.28); ctx.fill(); if(e.life<=0) { MiniGames.enemies.splice(i,1); MiniGames.spawnClickTarget(); } });
            if(MiniGames.state.score >= 10) MiniGames.win();
        } else if(n===4) {
            ctx.fillStyle = '#0f0'; ctx.beginPath(); ctx.arc(MiniGames.player.x, MiniGames.player.y, 10, 0, 6.28); ctx.fill();
            if(MiniGames.frame % 10 === 0) { MiniGames.enemies.push({x:Math.random()*w, y:-20, w:20, h:20, vy:3+Math.random()*2}); }
            MiniGames.enemies.forEach(e => { e.y += e.vy; ctx.fillStyle='red'; ctx.fillRect(e.x, e.y, e.w, e.h); if(Math.abs(e.x - MiniGames.player.x) < 15 && Math.abs(e.y - MiniGames.player.y) < 15) MiniGames.lose(); });
            if(MiniGames.frame > 1000) MiniGames.win();
        } else if(n===5) {
            ctx.fillStyle = '#fff'; ctx.fillText("KEEP IN CENTER (SPACE)", 200, 50);
            MiniGames.state.vel += (Math.random()-0.5) * 2; MiniGames.state.pos += MiniGames.state.vel;
            ctx.fillStyle = '#333'; ctx.fillRect(100, 200, 400, 20); ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.state.pos, 190, 40, 40);
            if(MiniGames.state.pos < 100 || MiniGames.state.pos > 460) MiniGames.lose();
            if(MiniGames.frame > 800) MiniGames.win();
        } else if(n===6) {
            if(MiniGames.state.waiting) { MiniGames.state.timer--; ctx.fillStyle = 'red'; ctx.fillRect(200,100,200,200); if(MiniGames.state.timer <= 0) { MiniGames.state.waiting = false; MiniGames.state.color = 'green'; MiniGames.state.timer = 60; } } 
            else { ctx.fillStyle = 'green'; ctx.fillRect(200,100,200,200); MiniGames.state.timer--; if(MiniGames.state.timer <= 0) MiniGames.lose(); }
        } else if(n===7) {
            ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20); ctx.fillStyle = 'gold'; ctx.fillRect(MiniGames.target.x, MiniGames.target.y, 20, 20);
            MiniGames.enemies.forEach(e => { ctx.fillStyle = '#555'; ctx.fillRect(e.x, e.y, e.w, e.h); if(MiniGames.col(MiniGames.player, e)) MiniGames.player = {x:20, y:20, w:20, h:20}; });
            if(MiniGames.col(MiniGames.player, MiniGames.target)) MiniGames.win();
        } else if(n===8) {
             ctx.fillStyle = '#0f0'; ctx.fillRect(MiniGames.player.x, MiniGames.player.y, 20, 20);
             if(MiniGames.frame % 5 === 0) { let side = Math.floor(Math.random()*4); let e = {w:10,h:10}; if(side===0) { e.x=Math.random()*600; e.y=0; e.vx=(Math.random()-0.5)*2; e.vy=3; } if(side===1) { e.x=Math.random()*600; e.y=400; e.vx=(Math.random()-0.5)*2; e.vy=-3; } if(side===2) { e.x=0; e.y=Math.random()*400; e.vx=3; e.vy=(Math.random()-0.5)*2; } if(side===3) { e.x=600; e.y=Math.random()*400; e.vx=-3; e.vy=(Math.random()-0.5)*2; } MiniGames.enemies.push(e); }
             MiniGames.enemies.forEach(e => { e.x+=e.vx; e.y+=e.vy; ctx.fillStyle='red'; ctx.fillRect(e.x,e.y,e.w,e.h); if(MiniGames.col(MiniGames.player,e)) MiniGames.lose(); });
             if(MiniGames.frame > 1200) MiniGames.win();
        }
        requestAnimationFrame(MiniGames.loop);
    },
    col: (r1,r2) => (r1.x < r2.x+r2.w && r1.x+r1.w > r2.x && r1.y < r2.y+r2.h && r1.y+r1.h > r2.y),
    handleInput: (e) => {
        if(!MiniGames.active) return;
        const k=e.code, p=MiniGames.player;
        if([1,2,7,8].includes(MiniGames.night)) { if(k==='ArrowLeft') p.x-=15; if(k==='ArrowRight') p.x+=15; if(MiniGames.night !== 1) { if(k==='ArrowUp') p.y-=15; if(k==='ArrowDown') p.y+=15; } else { if(k==='ArrowDown') p.duck=true; if(k==='ArrowUp') p.duck=false; } }
        if(MiniGames.night === 5 && k==='Space') { MiniGames.state.vel -= 1.5; }
    },
    handleMove: (e) => {
        if(MiniGames.night === 4) { const r = document.getElementById('mg-canvas').getBoundingClientRect(); MiniGames.player.x = e.clientX - r.left; MiniGames.player.y = e.clientY - r.top; }
    },
    handleClick: (e) => {
        if(MiniGames.night===3) { const r = document.getElementById('mg-canvas').getBoundingClientRect(); const mx = e.clientX-r.left, my = e.clientY-r.top; MiniGames.enemies.forEach((t,i) => { if(Math.sqrt((mx-t.x)**2+(my-t.y)**2) < t.r) { MiniGames.state.score++; MiniGames.enemies.splice(i,1); MiniGames.spawnClickTarget(); } }); }
        if(MiniGames.night===6) { if(!MiniGames.state.waiting) MiniGames.win(); else MiniGames.lose(); }
    },
    win: () => { MiniGames.active=false; AudioSys.stop('bgm-minigame'); const n = MiniGames.night; const txt = TEXTS[Lang.current]['lf_'+n] || "DATA RECOVERED."; alert(txt); SAVEDATA.night = parseInt(n)+1; SAVEDATA.stars[n]=true; localStorage.setItem('mf_save_v4', JSON.stringify(SAVEDATA)); location.reload(); },
    lose: () => { MiniGames.active=false; AudioSys.stop('bgm-minigame'); alert("FAIL."); location.reload(); }
};

Game.initMenu();
</script>
</body>
</html>
